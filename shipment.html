<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CMS VOICE</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://script.google.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6d28d9">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <script src="firebase-config.js"></script>

    <svg width="0" height="0" style="position:absolute; left:-9999px; top:-9999px" aria-hidden="true" focusable="false">
        <!-- Lucide-style Modern Icons -->
        <symbol id="i-reload" viewBox="0 0 24 24">
            <path
                d="M11 2L13 3.99545L12.9408 4.05474M13 18.0001L11 19.9108L11.0297 19.9417M12.9408 4.05474L11 6M12.9408 4.05474C12.6323 4.01859 12.3183 4 12 4C7.58172 4 4 7.58172 4 12C4 14.5264 5.17107 16.7793 7 18.2454M17 5.75463C18.8289 7.22075 20 9.47362 20 12C20 16.4183 16.4183 20 12 20C11.6716 20 11.3477 19.9802 11.0297 19.9417M13 22.0001L11.0297 19.9417"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
        </symbol>
        <symbol id="i-phone" viewBox="0 0 24 24">
            <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-truck" viewBox="0 0 24 24">
            <path d="M10 17h4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M14 17h5a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-5" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <path d="M3 7h7v10H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2z" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <path d="M14 7h4l3 3v6h-7V7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <circle cx="6.5" cy="17.5" r="2.5" fill="none" stroke="currentColor" stroke-width="2" />
            <circle cx="17.5" cy="17.5" r="2.5" fill="none" stroke="currentColor" stroke-width="2" />
        </symbol>
        <symbol id="i-printer" viewBox="0 0 24 24">
            <polyline points="6 9 6 2 18 2 18 9" fill="none" class="paper-feed" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <rect x="6" y="14" width="12" height="8" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-trash" viewBox="0 0 24 24">
            <polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <line x1="10" y1="11" x2="10" y2="17" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="14" y1="11" x2="14" y2="17" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-pencil" viewBox="0 0 24 24">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-check-square" viewBox="0 0 24 24">
            <polyline points="9 11 12 14 22 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-x" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="6" y1="6" x2="18" y2="18" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-search" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-share" viewBox="0 0 24 24">
            <circle cx="18" cy="5" r="3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <circle cx="6" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <circle cx="18" cy="19" r="3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-thumbs-up" viewBox="0 0 24 24">
            <path
                d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </symbol>
        <symbol id="i-exclamation" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <line x1="12" y1="8" x2="12" y2="12" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="12" y1="16" x2="12.01" y2="16" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-scan" viewBox="0 0 24 24">
            <path d="M3 7V5a2 2 0 0 1 2-2h2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M17 3h2a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M21 17v2a2 2 0 0 1-2 2h-2" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <path d="M7 21H5a2 2 0 0 1-2-2v-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <line x1="7" y1="12" x2="17" y2="12" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-check-circle" viewBox="0 0 24 24">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <polyline points="22 4 12 14.01 9 11.01" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-x-circle" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <line x1="15" y1="9" x2="9" y2="15" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="9" y1="9" x2="15" y2="15" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-package" viewBox="0 0 24 24">
            <path d="M16.5 9.4 7.5 4.21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path
                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M3.27 6.96 12 12.01l8.73-5.05" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="12" y1="22.08" x2="12" y2="12" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-clock" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <polyline points="12 6 12 12 16 14" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-user" viewBox="0 0 24 24">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <circle cx="12" cy="7" r="4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
        <symbol id="i-location" viewBox="0 0 24 24">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <circle cx="12" cy="10" r="3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
        <!-- New Icons for Payment Details -->
        <symbol id="i-smartphone" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="5" y="2" width="14" height="20" rx="2" ry="2" />
            <line x1="12" y1="18" x2="12.01" y2="18" />
        </symbol>
        <symbol id="i-bank" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 21h18M3 10h18M5 10v11M19 10v11M12 10v11M7 10V4l5-2 5 2v6" />
        </symbol>
        <symbol id="i-credit-card" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
            <line x1="1" y1="10" x2="23" y2="10" />
        </symbol>
        <symbol id="i-barcode" viewBox="0 0 24 24">
            <path d="M3 5v14M8 5v14M12 5v14M17 5v14M21 5v14" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-volume-2" viewBox="0 0 24 24">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-link" viewBox="0 0 24 24">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-calendar" viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="16" y1="2" x2="16" y2="6" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="8" y1="2" x2="8" y2="6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <line x1="3" y1="10" x2="21" y2="10" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-receipt" viewBox="0 0 24 24">
            <path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M16 8h-8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M16 12h-8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M13 16h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
        <symbol id="i-list" viewBox="0 0 24 24">
            <line x1="5" y1="7" x2="19" y2="7" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round" />
            <line x1="5" y1="12" x2="19" y2="12" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round" />
            <line x1="5" y1="17" x2="19" y2="17" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round" />
        </symbol>
        <symbol id="i-idcard" viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="7" y1="8" x2="17" y2="8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <line x1="7" y1="12" x2="17" y2="12" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <line x1="7" y1="16" x2="12" y2="16" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-insights-new" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 3v17a1 1 0 0 0 1 1h17" />
            <path d="M18 11v6" />
            <path d="M13 6v11" />
            <path d="M8 13v4" />
        </symbol>
        <symbol id="i-create-new" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="4" y="4" width="16" height="16" rx="3" />
            <line x1="12" y1="8" x2="12" y2="16" />
            <line x1="8" y1="12" x2="16" y2="12" />
        </symbol>
        <symbol id="i-check" viewBox="0 0 24 24">
            <polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
        <symbol id="i-check-circle" viewBox="0 0 24 24">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <polyline points="22 4 12 14.01 9 11.01" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-rupee-circle" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
            <path d="M8 7h7M8 10h7c0 0-4 0-4 4s4 4 4 4M9 10l4 4" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-chevron" viewBox="0 0 24 24">
            <polyline points="6 9 12 15 18 9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
        <symbol id="i-package" viewBox="0 0 24 24">
            <path d="m7.5 4.27 9 5.15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path
                d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="m3.3 7 8.7 5 8.7-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path d="M12 22V12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
        <symbol id="i-gear" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-whatsapp" viewBox="0 0 24 24">
            <path
                d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"
                fill="currentColor" />
        </symbol>
        <symbol id="i-num-1" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
            <path d="M12 8v8M10 10l2-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
        <symbol id="i-num-2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" />
            <path d="M10 9c0-1.1 1.3-2 2.5-2s2.5.9 2.5 2c0 2-2.5 3.5-5 5h5" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="i-chevron-left" viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
        <symbol id="i-chevron-right" viewBox="0 0 24 24">
            <polyline points="9 18 15 12 9 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
        </symbol>
    </svg>

    <style>
        /* Fix for "Today" + "Selected" overlap visibility */
        .cal-day.today.selected {
            color: #fff !important;
        }

        .cal-day.today:not(.selected) {
            color: var(--primary);
        }

        /* Ensure icon color matches text in Date Buttons */
        #dateBtn .ico,
        #metricsDateBtn .ico {
            color: currentColor;
        }

        /* =========================
   REFINED MODERN THEME (V3 Option 2)
   ========================= */
        :root {
            /* Palette (Kept original vibrant colors) */
            --bg: #f9faff;
            --paper: #fff;
            --ink: #1e293b;
            --muted: #64748b;
            --border: #e2e8f0;
            --surface: #f1f5f9;

            /* Primary Colors (ROYAL PURPLE THEME) */
            --primary: #6d28d9;
            /* Violet-700 Use true Royal Purple */
            --primary-600: #5b21b6;
            /* Violet-800 */

            /* Slate Theme (LABELS) */
            --label-fg: #475569;
            /* Slate-600 */
            --label-bg: #f8fafc;
            /* Slate-50 */
            --label-border: #e2e8f0;
            /* Slate-200 */

            --accent: #22d3ee;
            --accent2: #7c3aed;
            /* Violet-600 (Darker secondary for subtle gradient) */
            --primary-focus-ring: rgba(109, 40, 217, 0.25);
            --primary-light-bg: #f5f3ff;
            /* Violet-50 */

            /* Status Colors */
            --paid-bg: #ecfdf5;
            --paid-fg: #065f46;
            --paid-border: #bbf7d0;
            --unpaid-bg: #fff1f2;
            --unpaid-fg: #9f1239;
            --unpaid-border: #fecdd3;

            /* Shadows (Refined) */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07),
                0 2px 4px -2px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08),
                0 4px 6px -4px rgba(0, 0, 0, 0.08);
            --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.1);

            /* Radius */
            --radius-lg: 16px;
            --radius-md: 10px;
            --radius-sm: 8px;

            /* Table column widths (unchanged) */
            --col-ts: clamp(70px, 7vw, 100px);
            --col-name: clamp(90px, 10vw, 160px);
            --col-addr: clamp(100px, 21vw, 210px);
            --col-p1: clamp(80px, 9vw, 110px);
            --col-p2: clamp(80px, 9vw, 110px);
            --col-pref: clamp(100px, 10vw, 130px);
            --col-via: clamp(80px, 9vw, 120px);
            --col-trk: clamp(90px, 11vw, 130px);
            --col-url: clamp(80px, 9vw, 110px);
            --col-date: clamp(90px, 9vw, 120px);
            --col-ov: clamp(60px, 9vw, 84px);
            --col-cc: clamp(60px, 9vw, 84px);
            --col-ac: clamp(90px, 11vw, 120px);
            --col-pay: clamp(60px, 10vw, 82px);
            --col-act: clamp(90px, 15vw, 100px);

            --pill-w: 80px;
            /* Default badge width */
            --preview-w: 10cm;

            /* Control sizing */
            --ctrl-h: 38px;
            --ctrl-pad-v: 8px;
            --ctrl-pad-h: 12px;
            --font-base: 14px;
        }

        /* Fixed nested styles from :root - moved outside */
        #dateBtn,
        #metricsDateBtn {
            font-weight: 700 !important;
        }

        #dateBtn .ico,
        #metricsDateBtn .ico {
            color: currentColor !important;
            stroke: currentColor !important;
        }

        .rp2-chip,
        .current-month-label,
        .cal-header {
            font-weight: 700 !important;
        }

        .cal-day.today.selected {
            color: #fff !important;
        }

        * {
            box-sizing: border-box
        }

        input,
        textarea,
        select,
        button {
            margin: 0;
            /* Reset browser defaults for uniform spacing */
        }

        html,
        body {
            min-height: 100%
        }

        body {
            margin: 0;
            padding: 0 12px;
            font-family: 'Plus Jakarta Sans', Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;
            font-size: var(--font-base);
            line-height: 1.4;
            color: var(--ink);
            background: var(--bg);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
        }

        .ico16 {
            width: 16px;
            height: 16px;
            stroke-width: 2.5;
            stroke: currentColor;
            fill: none;
            vertical-align: middle;
            display: inline-block;
        }

        /* Header Icon Fixed Size */
        .ico-th {
            width: 15px;
            height: 15px;
            flex-shrink: 0;
            margin-right: 6px;
            color: var(--muted);
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            vertical-align: middle;
            display: inline-block;
        }

        /* --- HYPER-PREMIUM MESH BACKGROUND --- */
        .bg-mesh {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
            background: var(--bg);
        }

        .mesh-sphere {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.45;
            mix-blend-mode: multiply;
            animation: float-sphere 25s infinite alternate ease-in-out;
        }

        .sphere-1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, var(--primary), transparent 70%);
            top: -100px;
            left: -100px;
        }

        .sphere-2 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, var(--accent), transparent 70%);
            bottom: -150px;
            right: -50px;
            animation-duration: 30s;
            animation-delay: -5s;
        }

        .sphere-3 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent2), transparent 70%);
            top: 40%;
            left: 60%;
            animation-duration: 35s;
            animation-delay: -10s;
        }

        @keyframes float-sphere {
            0% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(50px, 80px) scale(1.1);
            }

            66% {
                transform: translate(-30px, 40px) scale(0.9);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        @media (max-width:768px) {
            body {
                padding: 0;
            }
        }

        /* Modern Scrollbar for Textareas/Panels */
        textarea::-webkit-scrollbar,
        .fancy-select-menu::-webkit-scrollbar,
        .table-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        textarea::-webkit-scrollbar-track,
        .fancy-select-menu::-webkit-scrollbar-track,
        .table-container::-webkit-scrollbar-track {
            background: transparent;
        }

        textarea::-webkit-scrollbar-thumb,
        .fancy-select-menu::-webkit-scrollbar-thumb,
        .table-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        textarea::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Basic icons */
        .ico.spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }


        /* Printer Animation */
        .ico.printing .paper-feed {
            animation: printFeed 1s ease-in-out infinite;
        }

        @keyframes printFeed {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .ico {
            width: 1em;
            height: 1em;
            display: inline-block;
            vertical-align: -0.15em;
        }

        .ico16 {
            width: 14px;
            height: 14px;
            display: inline-block;
            vertical-align: -2px;
        }

        .ico-th {
            width: 13px;
            height: 13px;
            display: inline-block;
            margin-right: 6px;
            vertical-align: -2px;
            opacity: 0.8;
        }

        .card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px) saturate(160%);
            -webkit-backdrop-filter: blur(16px) saturate(160%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            position: relative;
        }

        /* Lift effect removed to prevent jumping */
        .lift {
            transition: box-shadow .28s ease;
        }

        .lift:hover {
            /* transform: translateY(-3px); REMOVED */
            box-shadow: var(--shadow-lg);
        }

        /* Brand (unchanged) */
        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .brand-logo {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            overflow: hidden;
            box-shadow: 0 12px 24px rgba(99, 102, 241, .16);
            flex: 0 0 auto;
        }

        .brand h1 {
            margin: 0;
            font-size: 16px;
            letter-spacing: .2px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width:768px) {
            .brand-logo {
                width: 30px;
                height: 30px;
            }

            .brand h1 {
                font-size: 15px;
            }
        }

        /* Buttons â€” Kept gradient */
        .btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            height: var(--ctrl-h);
            padding: 0 14px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--paper);
            font-weight: 600;
            font-size: 13px;
            box-shadow: var(--shadow-sm);
            transition: transform .15s, box-shadow .2s, border-color .2s, background .2s, color .2s;
        }

        .btn:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0.5px);
        }

        .btn:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent2));
            border: 1px solid rgba(99, 102, 241, .5);
            color: #fff;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
        }

        .btn .ico {
            transition: transform .3s ease;
        }

        .btn.loading .ico {
            animation: spin 1s linear infinite;
        }

        .btn.loading .btn-text {
            opacity: .55;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        /* ===== PILL CHECKBOXES (Modernized shape) ===== */
        .pill {
            position: relative;
            display: inline-block;
        }

        .pill input[type="checkbox"] {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .pill .pill-ui {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--paper);
            color: var(--ink);
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            transition: .18s ease;
        }

        .pill-sm .pill-ui {
            padding: 5px 9px;
            font-size: 12px;
        }

        .pill .cbx {
            width: 16px;
            height: 16px;
            border-radius: 6px;
            border: 2px solid #cbd5e1;
            display: inline-grid;
            place-items: center;
            background: #fff;
            transition: .2s ease;
            box-shadow: none;
        }

        .pill-sm .cbx {
            width: 15px;
            height: 15px;
            border-radius: 5px;
        }

        .pill .cbx .tick {
            width: 12px;
            height: 12px;
            color: transparent;
            opacity: 0;
            transform: scale(.9);
            transition: .2s ease;
        }

        .pill-sm .cbx .tick {
            width: 11px;
            height: 11px;
        }

        .pill:has(input:hover) .pill-ui {
            border-color: #cbd5e1;
            background: #f8fafc;
        }

        .pill:has(input:focus-visible) .pill-ui {
            box-shadow: 0 0 0 4px var(--primary-focus-ring);
            border-color: var(--primary);
        }

        .pill input:checked+.pill-ui {
            background: var(--primary-light-bg);
            border-color: var(--primary);
        }

        .pill input:checked+.pill-ui .cbx {
            background: linear-gradient(135deg, var(--primary), var(--accent2));
            border-color: transparent;
            box-shadow: 0 10px 24px rgba(109, 40, 217, .25);
        }

        .pill input:checked+.pill-ui .cbx .tick {
            color: #fff;
            opacity: 1;
            transform: scale(1);
        }

        .pill .pill-ui .ico {
            width: 16px;
            height: 16px;
        }

        /* ===== Sticky bar (Upgraded to Glassmorphism) ===== */
        #topControls {
            position: sticky;
            top: 8px;
            z-index: 9999;
            margin: 8px auto;
            width: calc(100% - 16px);
            border-radius: var(--radius-lg);
            padding: 12px;
            display: grid;
            gap: 8px;
            align-items: center;
            grid-template-areas:
                "date filters search refresh toggle"
                "mirror mirror mirror mirror mirror";
            grid-template-columns: auto 1fr minmax(380px, 1.2fr) auto auto;
            grid-template-rows: auto auto;

            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            /* Stronger border */
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.25);
            /* Stronger shadow */

            width: 100%;
            max-width: 100%;
        }

        .date-area {
            grid-area: date;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
        }

        #filters {
            grid-area: filters;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            min-width: 0;
        }

        #filters::-webkit-scrollbar {
            display: none;
        }

        .search-wrap {
            grid-area: search;
            min-width: 0;
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
        }

        .refresh-area {
            grid-area: refresh;
            display: flex;
            justify-content: flex-end;
        }

        .view-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #64748b;
            white-space: nowrap;
        }

        .search-toggle-area {
            display: none;
        }

        /* Segment (Modernized shape, kept gradient) */
        .segment {
            display: inline-flex;
            gap: 4px;
            padding: 4px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            flex: 0 0 auto;
        }

        .segment .seg-btn {
            border: none;
            background: transparent;
            padding: 6px 8px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
            color: #334155;
            font-weight: 700;
            transition: .15s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            height: 28px;
            white-space: nowrap;
        }

        .segment .seg-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--accent2));
            color: #fff;
            box-shadow: 0 10px 20px rgba(99, 102, 241, .18);
        }

        .segment .seg-btn:not(.active):hover {
            background: var(--paper);
        }

        /* Search */
        #searchInput::-webkit-search-cancel-button {
            -webkit-appearance: none;
            display: none;
        }

        #searchInput::-ms-clear,
        #searchInput::-ms-reveal {
            display: none;
            width: 0;
            height: 0;
        }

        #searchInput {
            width: 100%;
            height: var(--ctrl-h);
            padding: var(--ctrl-pad-v) 120px var(--ctrl-pad-v) 34px;
            font-size: 13px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            outline: none;
            transition: .15s;
            background: #fff no-repeat 10px center/16px 16px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g stroke="%23999" stroke-width="2" fill="none"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></g></svg>');
            box-sizing: border-box;
            max-width: 100%;
        }

        #searchInput:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-focus-ring);
        }

        .search-actions {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 6px;
            pointer-events: none;
            z-index: 2;
        }

        .search-actions>* {
            pointer-events: auto;
        }

        .clear-btn,
        .cancel-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            padding: 0;
            border: 1px solid var(--border);
            border-radius: 50%;
            background: #fff;
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .clear-btn:hover,
        .cancel-btn:hover {
            background: var(--surface);
        }

        .search-wrap.has-text .clear-btn {
            display: inline-flex !important;
        }

        /* Force clear button visible on mobile in search mode */
        @media (max-width:768px) {
            body.search-mode .clear-btn {
                display: inline-flex !important;
            }
        }

        @media (min-width:769px) {
            .cancel-btn {
                display: none !important;
            }
        }

        .search-icon-btn {
            display: none;
            border: 1px solid var(--border);
            background: #fff;
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 800;
            box-shadow: var(--shadow-sm);
        }

        .cancel-btn.icon-only {
            width: 36px;
            height: 26px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 0;
        }

        .cancel-btn.icon-only .ico {
            width: 14px;
            height: 14px;
        }

        /* Toggle detailed view */
        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            inset: 0;
            background: #cbd5e1;
            border-radius: 999px;
            transition: .3s;
        }

        .slider:before {
            content: "";
            position: absolute;
            left: 4px;
            bottom: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: .3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .18);
        }

        .switch input:checked+.slider {
            background: linear-gradient(135deg, var(--primary), var(--accent2));
        }

        .switch input:checked+.slider:before {
            transform: translateX(20px);
        }

        .switch input:focus-visible+.slider {
            box-shadow: 0 0 0 4px var(--primary-focus-ring);
        }

        /* Mirrored table header */
        .thead-mirror {
            grid-area: mirror;
            margin: 0 -8px;
            padding: 0;
            overflow: hidden;
            border-top: 1px solid var(--border);
            display: block;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }

        .thead-mirror-inner {
            display: flex;
            min-width: 100%;
            will-change: transform;
        }

        .mirror-cell {
            flex: 0 0 auto;
            font-size: 12px;
            font-weight: 800;
            color: var(--ink);
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 5px 8px;
            border-bottom: 1px solid var(--border);
            background: rgba(251, 252, 255, 0.8);
            backdrop-filter: blur(4px);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        @media (min-width:769px) {
            .mirror-cell:nth-child(1) {
                width: var(--col-name);
            }

            .mirror-cell:nth-child(2) {
                width: var(--col-addr);
            }

            .mirror-cell:nth-child(3) {
                width: var(--col-p1);
            }

            .mirror-cell:nth-child(4) {
                width: var(--col-via);
            }

            .mirror-cell:nth-child(5) {
                width: var(--col-trk);
            }

            .mirror-cell:nth-child(6) {
                width: var(--col-date);
            }

            .mirror-cell:nth-child(7) {
                width: var(--col-cc);
            }

            .mirror-cell:nth-child(8) {
                width: var(--col-pay);
            }

            .mirror-cell:nth-child(9) {
                width: var(--col-act);
            }
        }

        .mirror-cell .ico-th {
            width: 12px;
            height: 12px;
            opacity: .8;
        }

        /* ===== MOBILE sticky bar (Glassmorphism) ===== */
        @media (max-width:768px) {
            #topControls {
                position: sticky;
                top: 8px;
                z-index: 1000;
                margin: 8px auto;
                width: calc(100% - 16px);
                border-radius: var(--radius-lg);
                grid-template-areas:
                    "date refresh toggle"
                    "filters searchToggle searchToggle";
                grid-template-columns: 1fr auto auto;
                grid-template-rows: auto auto;
                gap: 8px;
            }

            #filters {
                min-width: 0;
                overflow-x: auto;
            }

            .view-toggle {
                display: none !important;
            }

            #theadMirror {
                display: none !important;
            }

            #topControls .search-wrap {
                display: none;
            }

            .search-toggle-area {
                grid-area: searchToggle;
                display: flex;
                justify-content: flex-end;
            }

            .search-icon-btn {
                display: inline-flex;
            }

            /* Search-only mode on mobile */
            body.search-mode .cm-main,
            body.search-mode #mobileNav {
                display: none !important;
            }

            body.search-mode #topControls {
                grid-template-areas: "search";
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                gap: 0;
            }

            body.search-mode #topControls .search-wrap {
                display: flex !important;
                width: 100%;
            }

            body.search-mode #topControls .date-area,
            body.search-mode #topControls #filters,
            body.search-mode #topControls .refresh-area,
            body.search-mode #topControls .view-toggle,
            body.search-mode #topControls #theadMirror,
            body.search-mode #topControls .search-toggle-area {
                display: none !important;
            }

            body.search-mode #searchCancelBtn {
                display: inline-flex;
            }
        }

        /* ======= MAIN LAYOUT ======= */
        .cm-main {
            padding: 0;
            display: grid;
            gap: 16px;
            align-items: stretch;
            grid-template-columns: 1fr;
            grid-template-areas: "form" "preview" "metrics" "orders";
        }

        #formWrap {
            grid-area: form;
        }

        #previewWrap {
            grid-area: preview;
        }

        #metricsWrap {
            grid-area: metrics;
            display: flex;
            flex-direction: column;
        }

        @media (min-width:1025px) {
            .cm-main {
                grid-template-columns: minmax(400px, 1.2fr) minmax(360px, 1.05fr) minmax(300px, .95fr);
                grid-template-areas: "metrics form preview" "orders orders orders";
            }
        }

        @media (min-width:769px) and (max-width:1024px) {
            .cm-main {
                grid-template-columns: minmax(340px, 1fr) minmax(340px, 1fr);
                grid-template-areas:
                    "metrics metrics"
                    "form preview"
                    "orders orders";
            }
        }

        @media (max-width:768px) {
            .cm-main {
                gap: 12px;
                padding: 8px;
                grid-template-areas: "metrics" "form" "preview" "orders";
                height: auto;
                overflow: visible;
            }

            /* Mobile Spacing Fixes - FLUID LAYOUT */
            .preview-panel {
                padding: 40px 0 !important;
                width: 100%;
                overflow: hidden;
            }

            .preview-card {
                margin: 30px auto !important;
                width: 100% !important;
                max-width: 10.5cm;
                transform: none !important;
                box-sizing: border-box;
            }

            /* Ensure toolbar fits */
            .print-toolbar {
                width: 100% !important;
                max-width: 10.5cm;
                margin: 0 auto;
                box-sizing: border-box;
            }

            .pt-checks {
                flex-direction: row !important;
                gap: 8px !important;
                display: flex !important;
                justify-content: space-between !important;
                width: 100% !important;
            }

            .pt-checks .pill {
                flex: 1 1 0px !important;
                width: 0 !important;
                max-width: none !important;
                margin: 0 !important;
                white-space: nowrap !important;
                height: auto !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            /* Force toolbar to stay inside */
            .print-toolbar {
                width: 92% !important;
                /* Safe margin from edges */
                max-width: 10.5cm !important;
                margin: 10px auto !important;
                border-radius: 12px !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
        }

        .cm-main>* {
            min-width: 0;
        }

        /* Panels */
        .form-panel {
            padding: 16px;
        }

        .preview-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            min-height: 100%;
        }

        .preview-card {
            padding: 12px 20px 20px;
            margin-top: 12px;
            /* Access for badge */
            border-radius: var(--radius-lg);
            justify-self: center;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);
            /* Soft drop shadow */
            border: 1px solid var(--border);
            position: relative;
            /* Paper effect */
        }

        .preview-card::before {
            content: "PREVIEW";
            position: absolute;
            top: -10px;
            left: 20px;
            background: var(--primary);
            color: #fff;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
            letter-spacing: 1px;
        }

        .metrics-panel {
            padding: 12px;
            width: 100%;
        }

        /* Metrics header */
        .metrics-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .metrics-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Form controls (Refined) */
        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 14px;
            /* Uniform 14px gap */
            align-items: center;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none !important;
            -webkit-appearance: none;
        }

        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .form-group {
            flex: 1;
            min-width: 160px;
            position: relative;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            height: var(--ctrl-h);
            padding: var(--ctrl-pad-v) var(--ctrl-pad-h);
            font-size: 13px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--paper);
            outline: none;
            transition: .15s;
        }

        .form-group textarea {
            width: 100%;
            padding: var(--ctrl-pad-v) var(--ctrl-pad-h);
            font-size: 13px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--paper);
            outline: none;
            transition: .15s;
            resize: vertical;
            min-height: 92px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-focus-ring);
        }

        .form-group label {
            position: absolute;
            left: 8px;
            top: 9px;
            background: var(--paper);
            padding: 0 6px;
            border-radius: 6px;
            font-size: 11px;
            color: var(--muted);
            pointer-events: none;
            transform-origin: left top;
            transition: .2s;
        }

        .form-group input:focus~label,
        .form-group input:not(:placeholder-shown)~label,
        .form-group textarea:focus~label,
        .form-group textarea:not(:placeholder-shown)~label,
        .form-group select:focus~label,
        .form-group select:not([value=""])~label,
        .form-group .fs:not(.placeholder)~label {
            top: -8px;
            left: 6px;
            font-size: 10.5px;
            color: var(--primary);
            font-weight: 600;
        }

        /* Label preview */
        .label-header {
            background: #0f172a;
            color: #fff;
            padding: 6px 8px;
            margin: 0 0 6px;
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 14px;
            line-height: 1.2;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .label-logo {
            display: block;
            margin: 6px auto 8px;
            max-width: 140px !important;
            height: auto;
        }

        .text-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 8px 0 10px;
            color: var(--primary);
            font-weight: 900;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .label-divider {
            border: none;
            border-top: 1px dashed #000;
            margin: 8px 0 8px;
            opacity: .7;
        }

        .address-label p,
        .from-section p {
            margin: 2px 0;
            line-height: 1.25;
            font-size: 14px;
        }

        /* ================================
   Metrics Section (Gauge Style)
   ================================ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* Locked 3 Cols as requested */
            gap: 12px;
            width: 100%;
        }

        /* Date Picker Trigger Text */
        #dateLabel,
        #metricsDateLabel {
            color: #475569;
            /* Semi-black (Slate 600) */
            font-weight: 700;
        }

        .metric {
            padding: 12px;
            background: var(--paper);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
            transition: all .2s;
        }

        .metric:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }

        .metric.clickable {
            cursor: pointer;
        }

        .metric-top {
            width: 100%;
            text-align: center;
            margin-bottom: 4px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .metric .l {
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .gauge-wrap {
            position: relative;
            width: 135px;
            /* Scaled up */
            height: 75px;
            /* Requested 75px */
            display: flex;
            justify-content: center;
            margin-top: 4px;
        }

        /* SVG Gauge Container */
        .radial.gauge {
            width: 100%;
            height: 100%;
        }

        .radial svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .radial .track {
            stroke: #e2e8f0;
            opacity: 0.5;
        }

        .radial .value {
            transition: stroke-dashoffset 1s ease;
        }

        /* Centered Value (Delta Only) */
        .centered-val {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
            width: 100%;
            /* Ensure full width for text */
        }

        .metric .k {
            font-size: clamp(16px, 2vw, 24px);
            /* Responsive scaling */
            font-weight: 600;
            color: var(--primary);
            line-height: 1.2;
        }

        .delta {
            font-size: 11px;
            /* Slightly larger for readability */
            font-weight: 600;
            padding: 0;
            /* No padding */
            white-space: nowrap;
            /* Prevent 2 lines */
            margin-top: 2px;
        }

        .delta.up {
            color: #10b981;
            background: transparent;
            /* No background */
        }

        .delta.down {
            color: #ef4444;
            background: transparent;
            /* No background */
        }

        .metric-foot {
            margin-top: auto;
            padding-top: 8px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--muted);
            font-size: 10px;
            font-weight: 500;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .metric:hover .metric-foot {
            opacity: 1;
            color: var(--primary);
        }

        .metric-foot svg {
            width: 12px;
            height: 12px;
            fill: #64748b;
        }

        .metric:hover .metric-foot svg {
            fill: var(--primary);
        }

        /* Responsive */
        @media (max-width: 550px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                /* Mobile: 2 Cols */
                gap: 10px;
            }

            .metric {
                padding: 10px;
            }

            .gauge-wrap {
                width: 95px;
                height: 75px;
            }
        }

        /* Bouncy Loading Animation */
        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.3;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .bounce-dots {
            display: inline-flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }

        .bounce-dots span {
            width: 6px;
            height: 6px;
            background: var(--label-fg);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .bounce-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .bounce-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .table-wrap {
            overflow: auto;
            border-radius: var(--radius-lg);
            background: var(--paper);
            max-width: 100%;
            /* overscroll-behavior: contain; */
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--paper);
            font-size: 13px;
        }

        @media (min-width:769px) {
            table {
                table-layout: fixed;
            }

            /* Fix Top Rounded Corners */
            table thead th:first-child {
                border-top-left-radius: var(--radius-lg);
            }

            table thead th:last-child {
                border-top-right-radius: var(--radius-lg);
            }
        }

        table thead {
            display: none !important;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--surface);
            position: relative;
            vertical-align: middle;
            min-width: 0;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
        }

        @media (min-width:769px) {

            table thead th:nth-child(1),
            tbody td:nth-child(1) {
                width: var(--col-name);
            }

            table thead th:nth-child(2),
            tbody td:nth-child(2) {
                width: var(--col-addr);
            }

            table thead th:nth-child(3),
            tbody td:nth-child(3) {
                width: var(--col-p1);
            }

            table thead th:nth-child(4),
            tbody td:nth-child(4) {
                width: var(--col-via);
            }

            table thead th:nth-child(5),
            tbody td:nth-child(5) {
                width: var(--col-trk);
            }

            table thead th:nth-child(6),
            tbody td:nth-child(6) {
                width: var(--col-date);
            }

            table thead th:nth-child(7),
            tbody td:nth-child(7) {
                width: var(--col-cc);
            }

            table thead th:nth-child(8),
            tbody td:nth-child(8) {
                width: var(--col-pay);
            }

            table thead th:nth-child(9),
            tbody td:nth-child(9) {
                width: var(--col-act);
                white-space: nowrap !important;
                overflow: visible;
            }
        }

        .extra-col {
            display: none !important;
        }

        @media (min-width:769px) {
            .extra-col.show {
                display: table-cell !important;
            }
        }

        /* Address clamp */
        .address-content {
            max-height: 2em;
            overflow: hidden;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            margin-bottom: 4px;
            text-align: left !important;
            position: relative;
            transition: max-height 0.2s;
        }

        body.view-detailed .address-content {
            max-height: 4.5em;
            /* Show approx 3 lines */
        }

        .address-content.expanded {
            max-height: none;
        }

        .address-content:not(.expanded)::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 1.6em;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), var(--paper));
            pointer-events: none;
        }

        /* Smaller "View More" */
        .view-more {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--primary-600);
            background: var(--primary-light-bg);
            padding: 3px 7px;
            border-radius: 999px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 700;
        }

        .view-more .ico {
            width: 12px;
            height: 12px;
        }

        .view-more svg {
            transition: .2s;
        }

        .view-more.rot svg {
            transform: rotate(180deg);
        }

        /* Inputs inline */
        .inline-input,
        .inline-select {
            width: 100%;
            max-width: 100%;
            padding: 7px 9px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--paper);
            font: inherit;
            text-align: left;
            transition: .15s;
        }

        /* Fix for Select Icons showing numbers/artifacts */
        select.inline-select,
        select.custom-select,
        select.fancy-select {
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
            background-size: 14px !important;
            padding-right: 28px !important;
            /* Override any potential font-icon injection */
            font-family: 'Plus Jakarta Sans', sans-serif !important;
            content: none !important;
        }

        select::-ms-expand {
            display: none;
        }

        /* Fix for Date Input artifacts */
        input[type="date"] {
            appearance: none;
            -webkit-appearance: none;
            position: relative;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }

        input[type="date"]::before {
            content: attr(data-placeholder);
            color: var(--muted);
            width: 100%;
        }

        input[type="date"]:focus::before,
        input[type="date"]:valid::before {
            display: none;
        }

        .inline-input:focus,
        .inline-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-focus-ring);
        }

        /* Animations */
        @keyframes flashGreen {
            0% {
                background-color: rgba(34, 197, 94, 0.2);
            }

            100% {
                background-color: transparent;
            }
        }

        @keyframes flashRed {
            0% {
                background-color: rgba(239, 68, 68, 0.2);
            }

            100% {
                background-color: transparent;
            }
        }

        .flash-success {
            animation: flashGreen 1.5s ease-out;
        }

        .flash-delete {
            animation: flashRed 0.5s ease-out forwards;
        }

        @keyframes blinkGreen {

            0%,
            100% {
                background-color: transparent;
            }

            50% {
                background-color: rgba(34, 197, 94, 0.15);
            }
        }

        @keyframes blinkRed {

            0%,
            100% {
                background-color: transparent;
            }

            50% {
                background-color: rgba(239, 68, 68, 0.15);
            }
        }

        .blinking-green {
            animation: blinkGreen 1.2s infinite;
        }

        .blinking-red {
            animation: blinkRed 1.2s infinite;
        }

        .inline-input:disabled,
        .inline-select:disabled {
            background: var(--surface);
            opacity: 0.8;
        }

        /* Inform button */
        .inform-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 7px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            border: 1px solid var(--border);
            background: var(--paper);
            color: var(--ink);
            cursor: pointer;
            transition: .15s;
        }

        .inform-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            background: var(--surface);
        }

        .inform-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Payment tag */
        .status-tag {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 5px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 900;
            white-space: nowrap;
        }

        .status-tag.paid {
            background: var(--paid-bg);
            color: var(--paid-fg);
            border: 1px solid var(--paid-border);
        }

        .status-tag.unpaid {
            background: var(--unpaid-bg);
            color: var(--unpaid-fg);
            border: 1px solid var(--unpaid-border);
        }

        .status-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            position: relative;
        }

        .txn-details-overlay {
            position: absolute;
            background: #ffffff !important;
            color: #1e293b !important;
            padding: 12px !important;
            border-radius: 12px !important;
            font-size: 11px !important;
            z-index: 999999 !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2) !important;
            border: 1px solid #94a3b8 !important;
            width: 260px !important;
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
            animation: none !important;
            min-height: 100px;
        }

        .txn-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px 0;
            color: var(--muted);
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .txn-details-overlay::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: transparent transparent #ffffff transparent;
        }

        .txn-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .txn-row:last-child {
            border-bottom: none;
        }

        .txn-label {
            color: #64748b;
            font-weight: 500;
            white-space: nowrap;
        }

        .txn-val {
            color: #0f172a;
            font-weight: 700;
            text-align: right;
            word-break: break-all;
        }

        /* Copy icon btn */
        .copy-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--paper);
            letter-spacing: -0.5px;
        }

        /* Revised Popup Layout Styles */
        .txn-header-custom {
            padding: 16px 24px 4px;
            background: #fff;
        }

        .txn-payer-name {
            font-size: 18px;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .txn-amount-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .txn-amount-main {
            font-size: 24px;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.5px;
        }

        .txn-status-bracket {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .txn-status-success {
            background: #dcfce7;
            color: #16a34a;
        }

        .txn-status-failure {
            background: #fee2e2;
            color: #ef4444;
        }

        .txn-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 3px;
        }

        .txn-meta-val {
            font-weight: 600;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .txn-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 10px 0;
            border: none;
        }

        .txn-details-list {
            padding: 0 24px 16px;
        }

        /* Override generic row for list */
        .txn-details-list .txn-row {
            padding: 6px 0;
            border-bottom: 1px dashed #f1f5f9;
        }

        .txn-details-list .txn-row:last-child {
            border-bottom: none;
        }

        /* Row action buttons */
        .action-btn {
            display: inline;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--paper);
            cursor: pointer;
            transition: .15s;
            margin: 0 2px;
        }

        .action-btn svg {
            width: 15px;
            height: 15px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .edit-btn {
            color: var(--primary-600);
        }

        .edit-btn:hover {
            background: var(--primary-light-bg);
            border-color: var(--primary);
        }

        .save-btn {
            color: var(--paid-fg);
            border-color: var(--paid-border);
            background: var(--paid-bg);
        }

        .save-btn:hover {
            box-shadow: var(--shadow-md);
        }

        .delete-btn {
            color: var(--unpaid-fg);
            border-color: var(--unpaid-border);
            background: var(--unpaid-bg);
        }

        .delete-btn:hover {
            box-shadow: var(--shadow-md);
        }

        /* Settings Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-modal {
            width: 100%;
            max-width: 380px;
            background: var(--paper);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            color: var(--primary);
            font-size: 16px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 8px 20px 20px;
        }

        .settings-gear-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            border-radius: 50%;
            transition: .2s;
        }

        .settings-gear-btn:hover {
            background: rgba(109, 40, 217, 0.1);
            color: var(--primary);
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label strong {
            display: block;
            font-size: 14px;
            color: var(--ink);
        }

        .settings-label p {
            font-size: 11px;
            color: var(--muted);
            margin: 2px 0 0;
            line-height: 1.4;
        }

        #mobileNav {
            position: fixed;
            bottom: 12px;
            left: 12px;
            right: 12px;
            z-index: 1000;
            display: none;
            padding: 8px;
            gap: 8px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        #mobileNav .seg {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 14px;
            font-weight: 700;
            border-radius: 14px;
            cursor: pointer;
            transition: .2s;
        }

        #mobileNav .seg.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(109, 40, 217, 0.3);
        }

        #mobileNav .seg:not(.active):hover {
            background: rgba(109, 40, 217, 0.05);
            color: var(--primary);
        }

        @media (max-width:768px) {
            #mobileNav {
                display: flex;
            }

            #ordersWrap {
                margin-bottom: 90px !important;
            }
        }

        /* ================================
   NEW MOBILE CARD STYLES (V3 Option 2)
   ================================ */
        #mCards {
            display: none;
        }

        @media (max-width:768px) {
            #courierList {
                display: none !important;
            }

            #mCards {
                display: grid !important;
                gap: 12px;
                margin: 0;
                padding: 12px;
            }
        }

        .mcard {
            background: var(--paper);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 12px 14px 12px 24px;
            /* Left padding includes space for bar */
            display: grid;
            /* Grid Layout: Avatar | Main Info | Right Side */
            grid-template-columns: 40px 1fr auto;
            /* Col widths: Avatar | Flexible Name/Meta | Fixed right */
            grid-template-rows: auto 1fr;
            /* Row heights: Name | Meta takes remaining space */
            gap: 4px 12px;
            /* Row Gap | Column Gap */
            align-items: center;
            /* Vertically align items in rows */
            position: relative;
            overflow: hidden;
            min-height: 80px;
            /* Ensure a minimum height */
            transition: transform .15s ease, box-shadow .15s ease;
        }

        .mcard:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Side Bar - Reverted to original gradient, increased thickness */
        .with-bar-left::before {
            content: "";
            position: absolute;
            left: 8px;
            top: 10px;
            bottom: 10px;
            width: 6px;
            /* Increased thickness */
            border-radius: 3px;
            background: linear-gradient(180deg, var(--accent2), var(--accent));
            /* Original Gradient */
        }

        /* Inner Card Layout using Grid */
        .mcard .avatar {
            grid-column: 1;
            grid-row: 1 / 3;
            align-self: center;
        }

        /* Center avatar vertically */
        .mcard .name {
            grid-column: 2;
            grid-row: 1;
            align-self: end;
            /* Align name to bottom of first row */
            font-weight: 800;
            font-size: 14px;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mcard .meta {
            grid-column: 2;
            grid-row: 2;
            align-self: start;
            /* Align meta to top of second row */
            display: flex;
            flex-direction: column;
            /* Stack vertically */
            gap: 2px;
            /* Tighter gap */
            font-size: 11.5px;
            color: var(--muted);
            margin-top: 2px;
            /* Small space below name */
        }

        .mcard .right-stack {
            grid-column: 3;
            grid-row: 1 / 3;
            /* Span both rows */
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            /* Align right */
            gap: 6px;
            justify-content: center;
            /* Center vertically */
            text-align: right;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: var(--muted);
            animation: emptyIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform: translateY(10px);
        }

        @keyframes emptyIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state .ico {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            color: #cbd5e1;
        }

        .metric .k {
            font-size: 14px;
            font-weight: 600;
            /* Bolder */
            color: var(--primary);
            /* Theme Purple */
            line-height: 1.2;
        }

        .empty-state h3 {
            font-size: 16px;
            font-weight: 800;
            color: var(--ink);
            margin: 0 0 6px;
        }

        .empty-state p {
            font-size: 13px;
        }

        .mcard .amount {
            font-weight: 800;
            font-size: 13.5px;
            color: var(--ink);
        }

        .mcard .badge {
            width: var(--pill-w);
            /* Keep fixed width */
            margin: 0;
            padding: 4px 8px;
            /* Slightly tighter badge */
            font-size: 11px;
            /* Smaller badge font */
        }

        /* End of new mobile card styles V3 */

        /* AVATARS */
        .avatar {
            width: 40px;
            height: 40px;
            display: grid;
            place-items: center;
            font-weight: 900;
            font-size: 14px;
            text-transform: uppercase;
            border-radius: 50%;
        }

        .avatar-sm {
            width: 32px;
            height: 32px;
            display: grid;
            place-items: center;
            font-weight: 900;
            font-size: 11.5px;
            text-transform: uppercase;
            flex: 0 0 auto;
            border-radius: 50%;
        }

        .meta-line {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            line-height: 1.25;
        }

        .meta-line .ico {
            margin-top: 0;
            width: 13px;
            height: 13px;
            opacity: 0.8;
        }

        /* Slightly smaller icons */

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 7px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 800;
            justify-content: center;
        }

        .badge .ico {
            width: 12px;
            height: 12px;
        }

        /* Ensure badge icon size */
        .badge.paid {
            background: var(--paid-bg);
            color: var(--paid-fg);
            border: 1px solid var(--paid-border);
        }

        .badge.unpaid {
            background: var(--unpaid-bg);
            color: var(--unpaid-fg);
            border: 1px solid var(--unpaid-border);
        }

        .badge.shipped {
            background: #eff6ff;
            /* Blue-50 */
            color: #1e40af;
            /* Blue-800 */
            border: 1px solid #bfdbfe;
            /* Blue-200 */
        }


        /* Bottom sheet â€” Pill Cards Design */
        #detailSheetOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .4);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 10000;
        }

        #detailSheetOverlay.open {
            display: flex;
        }

        #detailSheet {
            width: 100%;
            max-width: 640px;
            background: #f2f3f6;
            border: none;
            border-radius: 28px 28px 0 0;
            padding: 8px 14px 28px;
            transform: translateY(100%);
            animation: slideUp .25s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            box-shadow: 0 -8px 40px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        #detailSheet::before {
            content: '';
            width: 36px;
            height: 4px;
            background: #d0d0d5;
            border-radius: 4px;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }

        /* â”€â”€â”€ Header: merged with summary in one top card â”€â”€â”€ */
        .sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 16px 16px 14px;
            margin-top: 14px;
            margin-bottom: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            border-bottom: 1px solid #f0f0f3;
        }

        .sheet-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 900;
            letter-spacing: -0.2px;
        }

        .sheet-title .avatar {
            width: 46px;
            height: 46px;
            font-size: 16px;
            box-shadow: none;
        }

        .sheet-close {
            width: 30px;
            height: 30px;
            background: #f2f3f6;
            border: none;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: none;
            color: var(--muted);
            transition: .15s;
        }

        .sheet-close:hover {
            background: #e8e9ee;
        }

        .sheet-close:active {
            transform: scale(0.92);
        }

        /* â”€â”€â”€ Body â”€â”€â”€ */
        .sheet-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 66vh;
            overflow: auto;
            padding: 0;
            scrollbar-width: none;
        }

        .sheet-body::-webkit-scrollbar {
            display: none;
        }

        /* â”€â”€â”€ Summary section: bottom half of top card â”€â”€â”€ */
        .sheet-section:first-child {
            background: #fff;
            border-radius: 0 0 20px 20px;
            padding: 14px 16px 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
            border: none;
            margin-bottom: 0;
        }

        /* â”€â”€â”€ Pill Cards (other sections) â”€â”€â”€ */
        .sheet-section {
            border: none;
            border-radius: 20px;
            padding: 14px 16px;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
            position: relative;
        }

        .sheet-section.with-bar-left::before {
            display: none;
        }

        /* Summary boxes inside top card */
        .summary-box {
            background: #f2f3f6;
            border: none;
            border-radius: 12px;
            padding: 10px 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            box-shadow: none;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 800;
            margin: 2px 2px 10px;
            color: var(--primary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .sheet-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .sheet-field {
            margin-bottom: 10px;
            min-width: 0;
            overflow: hidden;
        }

        .sheet-field label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--label-fg);
            margin-bottom: 5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .sheet-field select {
            width: 100%;
            padding: 9px 11px;
            border: none;
            border-radius: 10px;
            background: #f2f3f6;
            box-shadow: none;
            font-family: inherit;
            color: var(--ink);
            transition: .2s;
            font-size: 13px;
            font-weight: 500;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .sheet-field input,
        .sheet-field textarea {
            width: 100%;
            padding: 9px 11px;
            border: none;
            border-radius: 10px;
            background: #f2f3f6;
            box-shadow: none;
            font-family: inherit;
            color: var(--ink);
            transition: .2s;
            font-size: 13px;
            font-weight: 500;
        }

        /* Payment Status Badge Logic */
        .status-badge-view {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 38px;
            width: 100%;
        }

        .sheet-field select:disabled {
            display: none;
        }

        .sheet-field select:disabled+.status-badge-view {
            display: flex;
        }

        .status-badge-view.paid {
            background: var(--paid-bg);
            color: var(--paid-fg);
            border: 1px solid var(--paid-border);
        }

        .status-badge-view.unpaid {
            background: var(--unpaid-bg);
            color: var(--unpaid-fg);
            border: 1px solid var(--unpaid-border);
        }

        #sheetDateTime {
            font-weight: 500;
            font-size: 13px;
        }

        .sheet-field.readonly input,
        .sheet-field.readonly textarea,
        .sheet-field.readonly select {
            background: #f2f3f6;
            pointer-events: none;
            opacity: 0.7;
        }

        .sheet-field input:focus,
        .sheet-field select:focus,
        .sheet-field textarea:focus {
            outline: none;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.12);
        }

        /* â”€â”€â”€ Actions â”€â”€â”€ */
        .sheet-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
            padding: 0 2px;
        }

        .sheet-actions #sheetEditBtn,
        .sheet-actions .save-btn,
        .sheet-actions #sheetSaveBtn {
            background: linear-gradient(135deg, #6d28d9, #7c3aed);
            color: #fff;
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 14px rgba(109, 40, 217, 0.2);
            font-weight: 700;
            transition: .2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sheet-actions #sheetEditBtn:hover,
        .sheet-actions .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 22px rgba(109, 40, 217, 0.3);
        }

        .sheet-actions #sheetEditBtn:active,
        .sheet-actions .save-btn:active {
            transform: scale(0.97);
            box-shadow: 0 4px 12px rgba(109, 40, 217, 0.2);
        }

        .sheet-actions #sheetDeleteBtn {
            background: #fff;
            color: #ef4444;
            border: none;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            font-weight: 700;
        }

        .sheet-actions #sheetDeleteBtn:active {
            transform: scale(0.97);
        }

        .sheet-actions .btn {
            flex: 1 1 auto;
            justify-content: center;
            height: 43px;
        }

        /* â”€â”€â”€ Contact Lines â”€â”€â”€ */
        .contact-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            background: #f2f3f6;
            border: none;
            border-radius: 12px;
            box-shadow: none;
            margin-bottom: 8px;
        }

        .sheet-number {
            background: transparent;
            border-radius: 0;
            padding: 0;
            margin-top: 2px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 14px;
        }

        .contact-actions {
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
            background: var(--paper);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-weight: 700;
            font-size: 12px;
            box-shadow: var(--shadow-sm);
            transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--ink);
        }

        .icon-btn:hover {
            background: #ecedf0;
        }

        .icon-btn:active {
            transform: scale(0.96);
        }

        .acct-inline {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--muted);
            font-size: 13px;
            font-weight: 700;
            font-family: 'Plus Jakarta Sans', sans-serif;
            letter-spacing: 0.2px;
        }

        /* Scanner overlay */
        #scanOverlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 11000;
            background: rgba(0, 0, 0, .5);
            padding: 12px;
        }

        #scanOverlay.open {
            display: flex;
        }

        .scan-wrap {
            width: 100%;
            max-width: 520px;
            background: var(--paper);
            border-radius: var(--radius-lg);
            padding: 10px;
            box-shadow: var(--shadow-lg);
        }

        .scan-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        #scanViewport {
            width: 100%;
            height: 280px;
            background: #0b1220;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .scan-hint {
            text-align: center;
            margin-top: 8px;
            font-size: 12px;
            color: var(--muted);
        }

        /* Confirm modal (reuses rp-* styles) */
        #confirmOverlay,
        #deleteConfirmOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12000;
        }

        #confirmOverlay.open,
        #deleteConfirmOverlay.open {
            display: flex;
        }

        .confirm-modal {
            width: 100%;
            max-width: 460px;
            background: var(--paper);
            border-radius: var(--radius-lg);
            padding: 10px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        /* Toast */
        #toast {
            position: fixed;
            right: 14px;
            bottom: 14px;
            z-index: 12000;
            pointer-events: none;
        }

        .toast-msg {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--ink);
            color: #fff;
            padding: 9px 11px;
            border-radius: var(--radius-md);
            margin-top: 8px;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transform: translateY(6px);
            animation: toastIn .18s ease forwards;
            font-size: 12.5px;
        }

        .toast-msg .ico16 {
            color: #a7f3d0;
        }

        @keyframes toastIn {
            to {
                opacity: 1;
                transform: none;
            }
        }

        /* Range Picker */
        #rangePickerOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 12000;
        }

        #rangePickerOverlay.open {
            display: flex;
        }

        .rp-modal {
            width: 100%;
            max-width: 520px;
            background: var(--paper);
            border-radius: var(--radius-lg);
            padding: 10px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .rp-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .rp-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .rp2-chip {
            border: 1px solid var(--border);
            background: var(--paper);
            border-radius: 999px;
            padding: 6px 10px;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
        }

        .rp2-chip:hover {
            background: var(--surface);
        }

        .rp2-chip.active {
            background: var(--primary-light-bg);
            border-color: var(--primary);
            color: var(--primary-600);
        }

        .rp-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .rp-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        /* Hide sticky bar when "Create" tab active on mobile (Create=Form+Preview only) */
        @media (max-width:768px) {
            body.create-mode #topControls {
                display: none !important;
            }
        }

        /* Tab visibility (MOBILE Create vs Insights) */
        @media (max-width:768px) {

            body.create-mode #formWrap,
            body.create-mode #previewWrap {
                display: block !important;
            }

            body.create-mode #metricsWrap,
            body.create-mode #ordersWrap {
                display: none !important;
            }

            body.insights-mode #formWrap,
            body.insights-mode #previewWrap {
                display: none !important;
            }

            body.insights-mode #metricsWrap,
            body.insights-mode #ordersWrap {
                display: block !important;
            }
        }

        /* Name/phone/etc */
        .name-cell {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .name-stack {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .ts-subtext {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11.5px;
            color: var(--muted);
            margin-top: 1px;
        }

        .ts-time {
            color: var(--primary);
            font-weight: 500;
        }

        .ts-subtext .ico {
            width: 13px;
            height: 13px;
        }

        .num-with-icon {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .num-with-icon .ico {
            width: 14px;
            height: 14px;
            opacity: .9;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            align-items: center;
        }

        .summary-box {
            background: var(--surface);
            border: 1px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 9px;
        }

        .summary-title {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 11.5px;
            font-weight: 800;
            color: var(--label-fg);
            margin-bottom: 6px;
        }

        .summary-value {
            font-weight: 900;
            color: var(--ink);
        }

        .sheet-number {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 900;
            position: relative;
        }

        .sheet-number.interactive {
            cursor: pointer;
        }

        .wa-confirm-popup {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: #0f172a;
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: popIn .15s ease-out;
        }

        .wa-confirm-popup::before {
            content: "";
            position: absolute;
            top: -4px;
            left: 10px;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid #0f172a;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Skeleton shimmer */
        .skel {
            background: linear-gradient(90deg, #f1f5f9, #fafafa, #f1f5f9);
            background-size: 200% 100%;
            animation: sh 1.2s linear infinite;
        }

        @keyframes sh {
            0% {
                background-position: 200% 0
            }

            100% {
                background-position: -200% 0
            }
        }

        /* Fancy select */
        select.fancy-select {
            position: absolute !important;
            opacity: 0 !important;
            pointer-events: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        .fs {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .fs.hide-until-edit {
            display: none;
        }

        .fs-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--paper);
            cursor: pointer;
            font-weight: 600;
            font-size: 12.5px;
            transition: .15s;
            color: var(--ink);
            min-width: 0;
            overflow: hidden;
        }

        .fs-btn:focus-visible {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-focus-ring);
        }

        .fs.disabled .fs-btn {
            opacity: .6;
            cursor: not-allowed;
        }

        .fs .fs-label {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--ink);
        }

        .fs.placeholder .fs-label {
            color: var(--muted);
        }

        .fs .fs-caret {
            width: 14px;
            height: 14px;
            transform: rotate(0);
            transition: .18s;
            opacity: .7;
        }

        .fs.open .fs-caret {
            transform: rotate(180deg);
        }

        .fs-portal {
            position: fixed;
            z-index: 12000;
            inset: auto auto auto auto;
        }

        .fs-list {
            min-width: 180px;
            max-height: 240px;
            overflow: auto;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, .98);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
        }

        .fs-opt {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 800;
            font-size: 12.5px;
            color: var(--ink);
        }

        .fs-opt:hover,
        .fs-opt[aria-current="true"] {
            background: var(--primary-light-bg);
        }

        .fs-check {
            display: none !important;
        }

        td .fs-btn {
            padding: 7px 9px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 12.5px;
        }

        .sheet-field .fs-btn {
            padding: 9px;
            border-radius: var(--radius-md);
            font-size: 12.5px;
        }

        /* Live preview width uses --preview-w */
        .preview-card {
            max-width: var(--preview-w) !important;
        }

        /* Print Toolbar Spacing */
        .pt-checks {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .pt-select-wrap {
            margin-bottom: 12px;
        }

        /* =========================
   PRINT â€” VISIBILITY ISOLATION (Blogger-safe)
   ========================= */
        @media print {
            @page {
                size: auto;
                margin: 0;
            }

            html,
            body {
                background: #fff !important;
                background-image: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: 100% !important;
                overflow: hidden !important;
                visibility: hidden !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Hide specific app sections */
            .bg-mesh,
            #topControls,
            #ordersWrap,
            #metricsWrap,
            #formWrap,
            #mobileNav,
            #detailSheetOverlay,
            #scanOverlay,
            #rangePickerOverlay,
            #toast,
            #labelOptions,
            #loadMoreBtn,
            #txnDetailsOverlay,
            #receiptModal {
                display: none !important;
            }

            .cm-main {
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 0 !important;
                height: 0 !important;
                overflow: visible !important;
            }

            .cm-main>*:not(#previewWrap) {
                display: none !important;
            }

            /* Fixed positioning = relative to the physical print page */
            #previewWrap {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: #fff !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                border: none !important;
                box-shadow: none !important;
                z-index: 99999 !important;
                visibility: visible !important;
            }

            /* Make all children of previewWrap visible too */
            #previewWrap * {
                visibility: visible !important;
            }

            /* Reset Preview Card for Print */
            #previewWrap .preview-card {
                width: var(--preview-w) !important;
                max-width: 9.5cm !important;
                margin: 0 !important;
                padding: 14px !important;
                background: #fff !important;
                border: 1px solid #000 !important;
                border-radius: 12px !important;
                box-shadow: none !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                overflow: visible !important;
            }

            /* Force Logo Visibility in Print */
            #previewWrap .label-logo {
                display: block !important;
                max-width: 150px !important;
                height: auto !important;
                opacity: 1 !important;
                visibility: visible !important;
            }

            /* Hide pseudo-elements that might leak */
            #previewWrap::before,
            #previewWrap::after,
            .preview-card::before,
            .preview-card::after {
                display: none !important;
                content: none !important;
            }
        }

        @media print {
            #previewWrap.card {
                border: 0 !important;
                box-shadow: none !important;
                background: transparent !important;
                border-radius: 0 !important;
            }

            /* Hide any labels/pseudo-elements on the preview container */
            #previewWrap::before,
            #previewWrap::after,
            .preview-card::before,
            .preview-card::after {
                display: none !important;
                content: none !important;
            }
        }

        /* Print Toolbar Spacing */
        .pt-checks {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Ensure no "Preview Label" text leaks if it's a specific element */
        @media print {
            .preview-label-text {
                display: none !important;
            }

            /* Speculative fix */
        }

        #scanViewport video {
            width: 100% !important;
            height: auto !important;
            object-fit: contain !important;
            transform: none !important;
        }

        /* 1. Remove the Gradient Line from the left */
        .sheet-section.with-bar-left::before {
            display: none !important;
        }

        /* Reset padding since the bar is gone */
        .sheet-section.with-bar-left {
            padding-left: 10px !important;
        }

        /* 2. Style the "Open" Link as a Button */
        #sheetTrackingLink {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 40px;
            /* Fixed height match inputs */
            background: var(--surface);
            /* Light grey background */
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--primary);
            font-weight: 700;
            text-decoration: none;
            font-size: 13px;
            box-shadow: var(--shadow-sm);
            transition: 0.2s;
        }

        #sheetTrackingLink:hover {
            background: var(--border);
            transform: translateY(-1px);
        }

        #sheetTrackingLink::after {
            content: " \2197";
            /* Adds a small arrow â†— */
            margin-left: 4px;
        }

        /* 3. Perfect Alignment Engine */
        .sheet-row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            /* Force 2 columns, constrain content */
            gap: 12px;
            align-items: end;
            /* Aligns the BOTTOM of inputs/buttons */
        }

        /* Force EVERY input, select, and button to have the exact same height */
        .sheet-field input,
        .sheet-field select,
        .sheet-field .fs-btn,
        .sheet-field .btn,
        .icon-btn,
        #sheetTrackingLink {
            height: 40px !important;
            min-height: 40px !important;
            max-height: 40px !important;
            padding: 0 10px;
            /* Consistent padding */
            box-sizing: border-box;
            margin: 0;
            /* Remove random margins */
        }

        /* Fix the "Tracking Number + Copy" group alignment */
        .input-with-btn {
            display: flex;
            gap: 6px;
            width: 100%;
            align-items: center;
            height: 40px;
            /* Container height */
        }

        .input-with-btn input {
            flex: 1;
            /* Input takes available space */
            min-width: 0;
            border-radius: var(--radius-md) !important;
        }

        .input-with-btn .icon-btn {
            flex: 0 0 auto;
            /* Button doesn't shrink */
            width: auto;
            border-radius: var(--radius-md) !important;
        }

        /* Ensure Labels don't push elements down unevenly */
        .sheet-field label {
            display: block;
            margin-bottom: 6px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Screen-only shadow for 10.5cm preview */
        .preview-card {
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
        }

        /* Detail View Styles */
        .detail-only {
            display: none;
        }

        body.view-detailed .detail-only {
            display: flex;
        }

        .acct-ph {
            font-size: 11px;
            color: var(--muted);
            align-items: center;
            gap: 4px;
            margin-top: 2px;
        }

        .track-link.detail-only {
            margin-top: 2px;
            color: var(--primary);
        }

        .sec-ph {
            font-size: 12px;
            color: var(--muted);
        }
    </style>

    <style id="dynamicPrint"></style>
</head>

<body class="insights-mode">
    <div class="bg-mesh">
        <div class="mesh-sphere sphere-1"></div>
        <div class="mesh-sphere sphere-2"></div>
        <div class="mesh-sphere sphere-3"></div>
    </div>

    <div class="cm-main">
        <section id="formWrap" class="form-panel card lift" data-section="form">
            <form id="courierForm">
                <div class="row">
                    <div class="form-group" style="flex:1 1 100%;">
                        <input id="recipientName" placeholder=" " required>
                        <label><svg class="ico16">
                                <use href="#i-user" />
                            </svg> Recipient Name</label>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group" style="flex:1 1 100%;">
                        <textarea id="addressInput" rows="3" placeholder=" " required></textarea>
                        <label><svg class="ico16">
                                <use href="#i-location" />
                            </svg> Address</label>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <input id="primaryPhone" placeholder=" " type="text" maxlength="10" pattern="\d{10}" required
                            oninput="this.value=this.value.replace(/\D/g,'')">
                        <label><svg class="ico16">
                                <use href="#i-phone" />
                            </svg> Primary Phone</label>
                    </div>
                    <div class="form-group">
                        <input id="secondaryPhone" placeholder=" " type="text" maxlength="10" pattern="\d{10}"
                            oninput="this.value=this.value.replace(/\D/g,'')">
                        <label><svg class="ico16">
                                <use href="#i-phone" />
                            </svg> Secondary Phone</label>
                    </div>
                </div>
                <div class="row" style="align-items:center;">
                    <div class="form-group">
                        <input id="accountPhone" placeholder=" " type="text" maxlength="10" pattern="\d{10}" required
                            oninput="this.value=this.value.replace(/\D/g,'')">
                        <label><svg class="ico16">
                                <use href="#i-phone" />
                            </svg> Account Phone No.</label>
                    </div>

                    <label class="pill pill-sm">
                        <input type="checkbox" id="sameAsPrimary">
                        <span class="pill-ui">
                            <span class="cbx" aria-hidden="true"><svg class="tick">
                                    <use href="#i-check" />
                                </svg></span>
                            Same as Primary
                        </span>
                    </label>
                </div>

                <div class="row">
                    <div class="form-group">
                        <input id="orderValue" placeholder=" " type="number" min="0" step="0.01" required>
                        <label><svg class="ico16">
                                <use href="#i-rupee-circle" />
                            </svg> Order Value (Rs)</label>
                    </div>
                    <div class="form-group">
                        <select id="paymentStatus" name="payment" class="fancy-select" required>
                            <option value="" disabled selected hidden>Select Status</option>
                            <option value="Paid">Paid</option>
                            <option value="Unpaid">Unpaid</option>
                        </select>
                        <label><svg class="ico16">
                                <use href="#i-check-circle" />
                            </svg> Payment Status</label>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <select id="preferredCourier" class="fancy-select" required>
                            <option value="" disabled selected hidden>Select Courier</option>
                        </select>
                        <label><svg class="ico16">
                                <use href="#i-package" />
                            </svg> Preferred Courier</label>
                    </div>
                </div>



                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn btn-primary" id="submitBtn" type="submit">
                        <svg class="ico">
                            <use href="#i-printer" />
                        </svg><span class="btn-text">Submit & Print</span>
                    </button>
                    <button class="btn" type="button" id="clearBtn">
                        <svg class="ico">
                            <use href="#i-trash" />
                        </svg><span>Clear</span>
                    </button>
                </div>
            </form>
        </section>

        <section id="previewWrap" class="preview-panel card lift" data-section="preview">
            <div class="preview-card">
                <h3 class="label-header">Life Saving Medicine â€“ Deliver Immediately</h3>
                <img id="labelLogo"
                    src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjEV85RAhHdM3BXX0o_aXJ9zNX7ZYL4tYJ-xG5Ya0Z_aOc_D4lYer7CMTw1A4JU8fw0-zWc9X3l9LUPQ22InAnBuu4Msxi3Bw849KS-jd3Hf6KxhSYaN6kjkhR5NZ57AV_8a3QsjrPDQM2g/s1099/MAKKAL_MARUNTHAGAM-removebg-preview+%25281%2529-min.png"
                    alt="Logo" class="label-logo" />
                <hr class="label-divider">
                <div class="address-label" id="printPreview">
                    <p>To,</p>
                    <p class="name" id="labelName"><strong>Recipient Name</strong></p>
                    <p id="labelAddress">Address will appear here</p>
                    <p id="labelPhoneCombined"><strong>Phone : </strong></p>
                    <br>
                    <div id="fromSection" class="from-section">
                        <p>From,</p>
                        <p><strong>Makkal Marunthagam, Chennai 600062</strong></p>
                        <p>Phone: 7397359435</p>
                    </div>
                </div>
            </div>

            <section id="labelOptions" class="no-print" data-section="label-options">
                <div class="print-toolbar">
                    <div class="pt-group">
                        <div class="pt-checks">
                            <label class="pill" for="includeCourierCheckbox">
                                <input type="checkbox" id="includeCourierCheckbox">
                                <span class="pill-ui">
                                    <span class="cbx" aria-hidden="true"><svg class="tick">
                                            <use href="#i-check" />
                                        </svg></span>
                                    Preferred Courier
                                </span>
                            </label>
                            <label class="pill" for="alternateFromCheckbox">
                                <input type="checkbox" id="alternateFromCheckbox">
                                <span class="pill-ui">
                                    <span class="cbx" aria-hidden="true"><svg class="tick">
                                            <use href="#i-check" />
                                        </svg></span>
                                    Full From-Address
                                </span>
                            </label>
                        </div>
                    </div>
                    <div class="pt-divider"></div>
                    <div class="pt-select-wrap">
                        <select id="paperSelect" class="fancy-select">
                            <option value="a5-landscape" data-icon="a5-landscape" selected>A5 â€” Landscape</option>
                            <option value="a5-portrait" data-icon="a5-portrait">A5 â€” Portrait</option>
                            <option value="a4-portrait" data-icon="a4-portrait">A4 â€” Portrait</option>
                            <option value="a4-landscape" data-icon="a4-landscape">A4 â€” Landscape</option>
                            <option value="th-88" data-icon="receipt">Thermal 88mm</option>
                            <option value="follow" data-icon="globe">Browser Default</option>
                            <option value="lbl-105" data-icon="tag">Label 105mm</option>
                        </select>
                    </div>
                </div>
            </section>
        </section>

        <section id="metricsWrap" class="metrics-panel card lift no-print" data-section="metrics">
            <div class="metrics-header">
                <div class="brand">
                    <div class="brand-logo" aria-hidden="true">
                        <svg viewBox="-20 -20 296 296" xmlns="http://www.w3.org/2000/svg" role="img"
                            aria-labelledby="t">
                            <title id="t">Courier Management</title>
                            <defs>
                                <linearGradient id="gBrand" x1="0" y1="0" x2="1" y2="1">
                                    <stop offset="0%" stop-color="#7c3aed" />
                                    <stop offset="100%" stop-color="#6d28d9" />
                                </linearGradient>
                                <path id="orbitPath"
                                    d="M 128 128 m -117 0 a 117 117 0 1 0 234 0 a 117 117 0 1 0 -234 0" />
                            </defs>
                            <g aria-hidden="true">
                                <use href="#orbitPath" fill="none" stroke="url(#gBrand)" stroke-width="18"
                                    stroke-linecap="round" />
                            </g>
                        </svg>
                    </div>
                    <h1>Courier Management</h1>
                </div>
                <div class="metrics-controls">
                    <button class="btn" id="metricsDateBtn">
                        <svg class="ico">
                            <use href="#i-calendar" />
                        </svg>
                        <span id="metricsDateLabel"> Today</span>
                    </button>
                </div>
            </div>
            <input type="date" id="metricsStartDate" style="display:none;">
            <input type="date" id="metricsEndDate" style="display:none;">

            <div id="metricsGrid" class="metrics-grid"></div>
        </section>
    </div>



    <section id="ordersWrap" class="card lift" data-section="orders" style="margin:10px 0; overflow:visible;">
        <div id="topControls" class="no-print">
            <div class="date-area">
                <button class="btn" id="dateBtn">
                    <svg class="ico">
                        <use href="#i-calendar" />
                    </svg>
                    <span id="dateLabel">All dates</span>
                </button>
                <input type="date" id="startDate" style="display:none;">
                <input type="date" id="endDate" style="display:none;">
            </div>

            <div id="filters">
                <div class="segment">
                    <button class="seg-btn active" data-payment="All"><svg class="ico">
                            <use href="#i-list" />
                        </svg> All</button>
                    <button class="seg-btn" data-payment="Paid"><svg class="ico">
                            <use href="#i-check-circle" />
                        </svg> Paid</button>
                    <button class="seg-btn" data-payment="Unpaid"><svg class="ico">
                            <use href="#i-x-circle" />
                        </svg> Unpaid</button>
                </div>
            </div>

            <div class="search-wrap">
                <a href="transaction.html" class="btn"
                    style="white-space:nowrap; font-size:12px; padding:6px 12px; border-radius:8px; text-decoration:none; display:inline-flex; align-items:center; gap:4px; background:var(--primary, #6d28d9); color:white; border:none; font-weight:600;">
                    <svg class="ico" style="width:14px;height:14px;stroke:white;">
                        <use href="#i-list" />
                    </svg>
                    All Transactions
                </a>
                <input id="searchInput" placeholder="Search here" aria-label="Search">
                <div class="search-actions">
                    <button type="button" id="searchClearBtn" class="clear-btn" aria-label="Clear search"><svg
                            class="ico">
                            <use href="#i-x" />
                        </svg></button>

                </div>
            </div>

            <div class="search-toggle-area">
                <button id="searchIconBtn" class="search-icon-btn" aria-label="Open search">
                    <svg class="ico">
                        <use href="#i-search" />
                    </svg>
                </button>
            </div>

            <div class="refresh-area">
                <button id="refreshBtn" class="btn" title="Refresh">
                    <svg class="ico">
                        <use href="#i-reload" />
                    </svg><span class="btn-text">Refresh</span>
                </button>
            </div>

            <div class="toggle-group"
                style="grid-area: toggle; display: flex; align-items: center; gap: 8px; justify-content: flex-end;">
                <div class="view-toggle">
                    <label class="switch">
                        <input type="checkbox" id="viewModeSwitch" aria-label="Toggle detailed view">
                        <span class="slider"></span>
                    </label>
                    <span class="btn-text">Detailed</span>
                </div>

                <button id="settingsBtn" class="settings-gear-btn" title="Voice & Language Settings"
                    onclick="openSettingsModal()">
                    <svg class="ico">
                        <use href="#i-settings" />
                    </svg>
                </button>
            </div>

            <div id="theadMirror" class="thead-mirror" aria-hidden="true">
                <div class="thead-mirror-inner" id="theadMirrorInner"></div>
            </div>
        </div>
        <div id="courierList"></div>
        <div id="mCards" class="no-print"></div>

        <div style="text-align:center; margin:14px;">
            <button id="loadMoreBtn" class="btn">
                <svg class="ico">
                    <use href="#i-reload" />
                </svg>
                <span class="btn-text">Load More</span>
            </button>
        </div>
    </section>
    <div id="mobileNav" class="no-print" aria-label="Mobile navigation">
        <button class="seg active" data-target="insights">
            <svg class="ico16">
                <use href="#i-insights-new" />
            </svg>Insights</button>
        <button class="seg" data-target="create">
            <svg class="ico16">
                <use href="#i-create-new" />
            </svg>Create</button>
    </div>

    <!-- Bottom Sheet -->
    <div id="detailSheetOverlay" class="no-print" aria-hidden="true">
        <div id="detailSheet">
            <div class="sheet-header">
                <div class="sheet-title">
                    <div class="avatar" id="sheetAvatar"></div>
                    <div>
                        <div id="sheetName" style="font-weight:900;"></div>
                        <div id="sheetAccount" class="acct-inline"><svg class="ico">
                                <use href="#i-phone" />
                            </svg> <span id="sheetAccountText"></span></div>
                    </div>
                </div>
                <button class="sheet-close" id="sheetClose"><svg class="ico">
                        <use href="#i-x" />
                    </svg></button>
            </div>

            <div class="sheet-body">
                <div class="sheet-section with-bar-left" id="sheetTopBadges">
                    <div class="section-title"><svg class="ico">
                            <use href="#i-list" />
                        </svg> Summary</div>

                    <div class="summary-grid" style="grid-template-columns: 1fr;">
                        <div class="summary-box">
                            <div class="summary-title"><svg class="ico">
                                    <use href="#i-calendar" />
                                </svg> Date &amp; Time</div>
                            <div id="sheetDateTime" class="summary-value">â€”</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-title"><svg class="ico">
                                    <use href="#i-check-circle" />
                                </svg> Payment</div>
                            <div
                                style="display:flex; align-items:center; justify-content:space-between; width:100%; margin-bottom:4px;">
                                <span id="sheetAmount" class="amount"
                                    style="font-weight: 800; font-size: 16px; color: var(--ink);">â‚¹0</span>
                                <span id="sheetPayBadge" class="badge">Status</span>
                            </div>
                            <div id="sheetTxnDetailsWrap"
                                style="width:100%; display:none; flex-direction:column; margin-top:10px;">
                                <button id="sheetViewDetailsBtn" class="view-more"
                                    style="background:var(--label-bg); color:var(--label-fg); border:1px solid var(--label-border); padding:10px 16px; border-radius:12px; font-weight:700; font-size:12px; align-self:stretch; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; font-family:inherit; min-height:42px;">
                                    View Payment Details
                                </button>
                                <div id="sheetTxnContent"
                                    style="margin-top:10px; padding:12px; background:#ffffff; border-radius:12px; border:1px solid var(--label-border); font-size:13px; display:none;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sheet-section with-bar-left">
                    <div class="section-title"><svg class="ico">
                            <use href="#i-location" />
                        </svg> Address</div>
                    <div class="sheet-field readonly">
                        <label>Delivery Address</label>
                        <textarea id="sheetAddress" rows="3" readonly></textarea>
                    </div>
                </div>

                <div class="sheet-section with-bar-left">
                    <div class="section-title"><svg class="ico">
                            <use href="#i-phone" />
                        </svg> Contacts & Share</div>
                    <div class="contact-line">
                        <div>
                            <div style="font-size:11px;color:#64748b;">Primary</div>
                            <div id="sheetP1Box" class="sheet-number"><svg class="ico">
                                    <use href="#i-phone" />
                                </svg><span id="sheetP1"></span></div>
                        </div>
                        <div class="contact-actions">
                            <button class="icon-btn" id="sheetP1Call"><svg class="ico">
                                    <use href="#i-phone" />
                                </svg> Call</button>
                            <button class="icon-btn" id="sheetP1Wa"><svg class="ico">
                                    <use href="#i-whatsapp" />
                                </svg> WhatsApp</button>
                        </div>
                    </div>
                    <div class="contact-line" id="sheetP2Wrap" style="display:none;">
                        <div>
                            <div style="font-size:11px;color:#64748b;">Secondary</div>
                            <div id="sheetP2Box" class="sheet-number"><svg class="ico">
                                    <use href="#i-phone" />
                                </svg><span id="sheetP2"></span></div>
                        </div>
                        <div class="contact-actions">
                            <button class="icon-btn" id="sheetP2Call"><svg class="ico">
                                    <use href="#i-phone" />
                                </svg> Call</button>
                            <button class="icon-btn" id="sheetP2Wa"><svg class="ico">
                                    <use href="#i-whatsapp" />
                                </svg> WhatsApp</button>
                        </div>
                    </div>
                </div>

                <div class="sheet-section with-bar-left">
                    <div class="section-title"><svg class="ico">
                            <use href="#i-package" />
                        </svg> Shipping</div>
                    <div class="sheet-row">
                        <div class="sheet-field">
                            <label><svg class="ico16">
                                    <use href="#i-package" />
                                </svg> Couriered via</label>
                            <select id="sheetCourieredVia" class="fancy-select" disabled></select>
                        </div>
                        <div class="sheet-field">
                            <label><svg class="ico16">
                                    <use href="#i-barcode" />
                                </svg> Tracking Number</label>
                            <div class="input-with-btn" style="display:flex; gap:8px; flex-wrap:wrap;">
                                <input id="sheetTrackingNumber" placeholder="#..." disabled style="flex:1">
                                <button class="icon-btn" id="sheetCopyBtn" title="Copy tracking"><svg class="ico">
                                        <use href="#i-clipboard" />
                                    </svg></button>
                                <button class="icon-btn" id="sheetScanBtn" title="Scan barcode"
                                    style="display:none;"><svg class="ico">
                                        <use href="#i-scan" />
                                    </svg></button>
                            </div>
                        </div>
                    </div>

                    <div class="sheet-row">
                        <div class="sheet-field readonly">
                            <label><svg class="ico16">
                                    <use href="#i-link" />
                                </svg> Tracking URL</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <input type="text" id="sheetTrackingURL" class="sheet-input"
                                    placeholder="No link available" readonly style="flex:1;">
                                <a id="sheetTrackingLink" href="#" target="_blank" class="btn"
                                    style="display:none; padding: 6px 12px; height: 38px; align-items: center; gap: 6px; text-decoration: none;">
                                    <svg class="ico">
                                        <use href="#i-link" />
                                    </svg> Open
                                </a>
                            </div>
                        </div>



                        <div class="sheet-field">
                            <label><svg class="ico16">
                                    <use href="#i-calendar" />
                                </svg> Dispatch Date</label>
                            <input type="date" id="sheetDispatchDate" class="sheet-input" readonly>
                        </div>
                        <div class="sheet-field">
                            <label><svg class="ico16">
                                    <use href="#i-rupee-circle" />
                                </svg> Courier Charge (â‚¹)</label>
                            <input type="number" id="sheetCourierCharge" class="sheet-input" placeholder=" "
                                inputmode="decimal" readonly>
                        </div>
                        <div class="sheet-field">
                            <label><svg class="ico16">
                                    <use href="#i-check-circle" />
                                </svg> Payment Status</label>
                            <div style="position:relative;">
                                <select id="sheetPayment" class="fancy-select" disabled>
                                    <option value="Paid">Paid</option>
                                    <option value="Unpaid">Unpaid</option>
                                </select>
                                <div id="sheetPaymentBadge" class="status-badge-view"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sheet-actions">
                    <button class="btn" id="sheetDeleteBtn">
                        <svg class="ico">
                            <use href="#i-trash" />
                        </svg> Delete
                    </button>
                    <button class="btn" id="sheetEditBtn">
                        <svg class="ico">
                            <use href="#i-pencil" />
                        </svg><span class="btn-text">Edit</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="scanOverlay" class="no-print" aria-hidden="true">
        <div class="scan-wrap">
            <div class="scan-head">
                <strong>Scan barcode</strong>
                <div style="display:flex;gap:8px;align-items:center">
                    <!-- Flash toggle (default OFF) -->
                    <label class="pill pill-sm" id="torchPill" style="display:none;">
                        <input type="checkbox" id="scanTorchToggle" aria-label="Toggle flash">
                        <span class="pill-ui">
                            <span class="cbx" aria-hidden="true"><svg class="tick">
                                    <use href="#i-check" />
                                </svg></span>
                            Flash
                        </span>
                    </label>
                    <button class="sheet-close" id="scanClose"><svg class="ico">
                            <use href="#i-x" />
                        </svg></button>
                </div>
            </div>

            <div id="scanViewport"></div>
            <div class="scan-hint">Center the barcode inside the frame</div>
        </div>
    </div>

    <!-- Date Range Picker -->
    <div id="rangePickerOverlay" class="no-print" aria-hidden="true">
        <div class="rp-modal">
            <div class="rp-head">
                <strong>Select date range</strong>
                <button class="sheet-close" id="rpClose"><svg class="ico">
                        <use href="#i-x" />
                    </svg></button>
            </div>

            <div id="rpPresets" class="rp-presets">
                <button class="rp2-chip" data-k="today">Today</button>
                <button class="rp2-chip" data-k="yesterday">Yesterday</button>
                <button class="rp2-chip" data-k="thisWeek">This Week</button>
                <button class="rp2-chip" data-k="thisMonth">This Month</button>
                <button class="rp2-chip" data-k="clear">Clear All</button>
            </div>

            <div class="rp-body" style="padding:0; display:block;">
                <div id="jsCalendar"></div>
                <!-- Hidden inputs to store value for existing logic -->
                <input type="hidden" id="rpStart">
                <input type="hidden" id="rpEnd">
            </div>

            <style>
                /* Modern JS Calendar */
                #jsCalendar {
                    padding: 10px 16px 16px;
                    user-select: none;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    /* Center Calendar */
                    width: 100%;
                }

                .cal-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 14px;
                    color: var(--ink);
                    font-weight: 700;
                    font-size: 14px;
                    /* Medium Header */
                    width: 100%;
                    max-width: 320px;
                    /* Constrain width */
                    margin: 0 auto;
                    /* Force Center */
                }

                .cal-nav-btn {
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    border: 1px solid var(--border);
                    background: var(--paper);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    color: var(--ink);
                    transition: .2s;
                    box-shadow: var(--shadow-sm);
                }

                .cal-nav-btn svg {
                    width: 18px;
                    height: 18px;
                    stroke-width: 2.5;
                }

                .cal-nav-btn:hover {
                    background: var(--surface);
                    color: var(--primary);
                    border-color: var(--primary);
                }

                .cal-grid {
                    display: grid;
                    grid-template-columns: repeat(7, 1fr);
                    column-gap: 4px;
                    row-gap: 6px;
                    text-align: center;
                    width: 100%;
                    max-width: 320px;
                    /* Constrain width */
                    margin: 0 auto;
                    /* Force Center */
                }

                .cal-head-day {
                    font-size: 11px;
                    color: var(--muted);
                    font-weight: 600;
                    padding-bottom: 6px;
                }

                .cal-day {
                    width: 38px;
                    /* Medium Size (down from 44, up from original) */
                    height: 38px;
                    margin: 0 auto;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 13.5px;
                    font-weight: 600;
                    border-radius: 50%;
                    cursor: pointer;
                    transition: .2s;
                    position: relative;
                    color: var(--ink);
                }

                .cal-day:hover:not(.empty) {
                    background: var(--surface);
                    color: var(--primary);
                }

                .cal-day.selected {
                    background: var(--primary);
                    color: #fff;
                    font-weight: 700;
                    box-shadow: 0 4px 10px var(--primary-light);
                }

                /* Range Connectors */
                .cal-day.range-start {
                    border-radius: 50% 0 0 50%;
                }

                .cal-day.range-end {
                    border-radius: 0 50% 50% 0;
                }

                .cal-day.in-range {
                    background: var(--primary-light-bg);
                    color: var(--primary);
                    border-radius: 0;
                    width: 100%;
                }

                /* Single day overlap fix */
                .cal-day.selected.range-start.range-end {
                    border-radius: 50%;
                    width: 38px;
                }

                .cal-day.today {
                    font-weight: 800;
                    color: var(--primary);
                }

                .cal-day.empty {
                    cursor: default;
                    pointer-events: none;
                }

                .current-month-label {
                    cursor: pointer;
                    padding: 4px 12px;
                    border-radius: 20px;
                    transition: .2s;
                }

                .current-month-label:hover {
                    background: var(--surface);
                    color: var(--primary);
                }

                /* Year Picker Grid */
                .cal-year-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 12px;
                    padding: 10px;
                    width: 100%;
                    max-width: 320px;
                    margin: 0 auto;
                    /* Force Center */
                }

                .cal-year-cell {
                    padding: 14px;
                    text-align: center;
                    border-radius: 12px;
                    border: 1px solid var(--border);
                    font-weight: 600;
                    cursor: pointer;
                    transition: .2s;
                    font-size: 14px;
                }

                .cal-year-cell:hover {
                    border-color: var(--primary);
                    color: var(--primary);
                    background: var(--surface);
                }

                .cal-year-cell.current {
                    background: var(--primary);
                    color: #fff;
                    border-color: var(--primary);
                }

                /* Center Presets & Make Larger */
                .rp-presets {
                    justify-content: center !important;
                    /* Force Center */
                    gap: 8px;
                    /* Spacing */
                    padding: 12px 16px 4px;
                }

                .rp2-chip {
                    font-size: 13px !important;
                    /* Larger Font */
                    padding: 8px 14px !important;
                    /* Larger Touch Target */
                    border-radius: 20px !important;
                }
            </style>

            <div class="cal-actions"
                style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid var(--border); padding-top:10px;">
                <button class="btn" id="rpCancel"><svg class="ico">
                        <use href="#i-x" />
                    </svg> Cancel</button>
                <button class="btn btn-primary" id="rpApply"><svg class="ico">
                        <use href="#i-check-square" />
                    </svg> Apply</button>
            </div>
        </div>
    </div>
    </div>
    </div>


    <style>
        #txnDetailsOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        #txnDetailsOverlay[aria-hidden="false"] {
            display: flex !important;
        }

        /* NEW PREMIUM POPUP STYLES */
        /* Modern Loader */
        .modern-loader {
            width: 40px;
            aspect-ratio: 1;
            display: grid;
        }

        .modern-loader::before,
        .modern-loader::after {
            content: "";
            grid-area: 1/1;
            --c: no-repeat radial-gradient(farthest-side, var(--primary) 92%, #0000);
            background: var(--c) 50% 0, var(--c) 50% 100%, var(--c) 100% 50%, var(--c) 0 50%;
            background-size: 10px 10px;
            animation: l12 1s infinite;
        }

        .modern-loader::before {
            margin: 4px;
            filter: blur(2px);
            opacity: 0.5;
            background-size: 8px 8px;
            animation-timing-function: linear;
            /* smooth blur rotation */
        }

        @keyframes l12 {
            100% {
                transform: rotate(1turn)
            }
        }

        .txn-details-overlay {
            position: absolute;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 20px 25px -5px rgba(0, 0, 0, 0.05),
                inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            width: 420px !important;
            overflow: hidden;
            animation: popIn 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            font-family: 'Inter', sans-serif;
            transform-origin: top center;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(8px) scale(0.96);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .txn-loading {
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: var(--muted);
            font-size: 13px;
            font-weight: 500;
        }

        .txn-header {
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .txn-header strong {
            font-size: 14px;
            color: var(--ink);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .txn-close-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: .2s;
            display: flex;
        }

        .txn-close-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--ink);
        }

        .txn-body {
            padding: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .txn-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px dashed var(--border-light);
            font-size: 13px;
        }

        .txn-row:last-child {
            border-bottom: none;
        }

        .txn-label {
            color: var(--muted);
            font-weight: 500;
            font-size: 12px;
        }

        .txn-val {
            color: var(--ink);
            font-weight: 600;
            text-align: right;
            user-select: text;
        }

        .txn-copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            margin-left: 6px;
            opacity: 0.6;
            transition: .2s;
            padding: 2px;
        }

        .txn-copy-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
    </style>
    <!-- Transaction Details Overlay -->
    <div id="txnDetailsOverlay" class="no-print" aria-hidden="true" style="display:none;">
        <div class="rp-modal" style="width:550px; max-width:95vw;">
            <div class="rp-head">
                <strong>Transaction Details</strong>
                <button class="sheet-close" onclick="closeTxnDetails()"><svg class="ico">
                        <use href="#i-x" />
                    </svg></button>
            </div>
            <div id="txnDetailsBody" class="rp-body" style="padding:16px;">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <!-- Confirm (Save/Discard) -->
    <div id="confirmOverlay" class="no-print" aria-hidden="true">
        <div class="confirm-modal">
            <div class="rp-head">
                <strong id="confirmTitle">Unsaved changes</strong>
                <button class="sheet-close" id="confirmX"><svg class="ico">
                        <use href="#i-x" />
                    </svg></button>
            </div>
            <div class="confirm-body" id="confirmBody" style="font-size:13px;color:#334155;margin:4px 0 10px;">
                You have unsaved changes. Do you want to save before closing?
            </div>
            <div class="rp-actions">
                <button class="btn" id="confirmCancel"><svg class="ico">
                        <use href="#i-x" />
                    </svg> Cancel</button>
                <button class="btn" id="confirmDiscard"><svg class="ico">
                        <use href="#i-trash" />
                    </svg> Discard</button>
                <button class="btn btn-primary" id="confirmSave"><svg class="ico">
                        <use href="#i-check-square" />
                    </svg> Save &amp; Close</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <!-- Custom Delete Confirmation Modal -->
    <div id="deleteConfirmOverlay" class="no-print" aria-hidden="true">
        <div class="confirm-modal">
            <div class="rp-head">
                <strong>Confirm Deletion</strong>
                <button class="sheet-close" id="delConfirmX"><svg class="ico">
                        <use href="#i-x" />
                    </svg></button>
            </div>
            <div class="confirm-body" id="delConfirmBody" style="font-size:13px;color:#334155;margin:4px 0 10px;">
                Are you sure you want to delete this row?
            </div>
            <div class="rp-actions">
                <button class="btn" id="delConfirmCancel"><svg class="ico">
                        <use href="#i-x" />
                    </svg> Cancel</button>
                <button class="btn btn-primary" id="delConfirmOk"><svg class="ico">
                        <use href="#i-trash" />
                    </svg> Delete</button>
            </div>
        </div>
    </div>

    <!-- Scanner Engines (order matters): ZXing (fallback 2), Quagga (fallback 3) -->
    <script defer src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <!-- External scanner libs -->
    <script defer src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <!-- Main app script -->
    <script>
        'use strict';

        /* =========================
           CONFIG
           ========================= */
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz90dG1fJmfu6_N2U8bWXNECLvdHRM3czmDNHXzltMBUVEDWRch1zRMlygnLS8CDIZ6PQ/exec';
        const PAGE_LIMIT = 25;
        const CACHE_TTL = 10 * 60 * 1000; // 10 min cache for static data

        /* â”€â”€ localStorage stale-while-revalidate cache â”€â”€ */
        function cachedFetch(cacheKey, url, applyFn) {
            // 1. Instantly apply cached data if available
            let usedCache = false;
            try {
                const raw = localStorage.getItem(cacheKey);
                if (raw) {
                    const { ts, data } = JSON.parse(raw);
                    if (data) { applyFn(data); usedCache = true; }
                    // If cache is still fresh, skip network entirely
                    if (Date.now() - ts < CACHE_TTL) return Promise.resolve();
                }
            } catch (_) { /* corrupt cache, ignore */ }

            // 2. Fetch fresh data (foreground if no cache, background if stale)
            const networkPromise = fetch(url)
                .then(r => r.json())
                .then(data => {
                    try { localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data })); } catch (_) { }
                    applyFn(data);
                })
                .catch(() => { /* network failed, cached data already applied */ });

            // If we had cache, don't wait for network
            return usedCache ? Promise.resolve() : networkPromise;
        }

        /* Row index mapping (kept from your original) */
        const SHEET_HEADER_ROWS = -1;
        const SERVER_ROW_INDEX_MODE = 'DATA_1_BASED';
        function toSheetRow(idx) {
            const n = Number(idx) || 0;
            if (SERVER_ROW_INDEX_MODE === 'ABSOLUTE_1_BASED') return n;
            if (SERVER_ROW_INDEX_MODE === 'DATA_0_BASE') return n + SHEET_HEADER_ROWS;
            return n + SHEET_HEADER_ROWS;
        }

        /* =========================
           STATE
           ========================= */
        let currentOffset = 0, isLastPage = false;
        let courierOptions = [], trackingMap = {};
        let paymentFilter = 'All', uiDateFilter = 'all';
        let mobileDetail = { open: false, rowId: null, data: null, edit: false };
        let mobileCurrent = 'insights';
        let mobileNavInitialized = false;
        let rangeTarget = 'orders'; // 'orders' | 'metrics'
        let baseCache = { rows: [], offset: 0, isLastPage: false };
        let lastQuery = '';

        // Navigation Guard Flag
        window.hasPendingAsync = false;

        window.addEventListener('beforeunload', (e) => {
            if (window.hasPendingAsync || document.querySelector('.has-pending-changes')) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes or an action in progress. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        /* =========================
           UTILS
           ========================= */
        /* =========================
           UTILS
           ========================= */
        const debounce = (fn, ms = 350) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
        const s = v => (v === undefined || v === null) ? '' : String(v);
        const isMobile = () => window.matchMedia('(max-width: 768px)').matches;
        const canUseCamera = () => !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);

        // Explicitly attach to window to ensure global scope availability
        window.closeTxnDetails = function () {
            const ov = document.getElementById('txnDetailsOverlay');
            if (ov) {
                ov.style.display = 'none';
                ov.setAttribute('aria-hidden', 'true');
            }
        };
        // Explicitly attach to window to ensure global scope availability



        function toTitleCase(str) {
            return String(str || '').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }

        /* Avatar helpers */
        const AV_PALETTE = [
            ['#E0F2FE', '#075985'], ['#E0E7FF', '#3730A3'], ['#FCE7F3', '#831843'], ['#DCFCE7', '#065F46'],
            ['#FEF9C3', '#92400E'], ['#FFE4E6', '#9F1239'], ['#F3E8FF', '#6D28D9'], ['#E2E8F0', '#0F172A'],
        ];
        function hashStr(str) { let h = 0; for (let i = 0; i < str.length; i++) { h = (h << 5) - h + str.charCodeAt(i); h |= 0; } return Math.abs(h); }
        function initialsFrom(name) {
            const n = (name || '').trim();
            if (!n) return '?';
            const parts = n.split(/\s+/).filter(Boolean);
            if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase();
            return (parts[0][0] + parts[1][0]).toUpperCase();
        }
        function pickAvatar(name) {
            const idx = hashStr(name || '?') % AV_PALETTE.length;
            const [bg, fg] = AV_PALETTE[idx];
            return { bg, fg, text: initialsFrom(name || '?') };
        }

        /* Dates / money */
        function parseDateDMY(raw, fallbackISO) {
            const v = s(raw).trim();
            if (!v) { if (fallbackISO) return parseDateDMY(fallbackISO); return null; }
            if (/^\d{4}-\d{1,2}-\d{1,2}(?:[ T]\d{1,2}:\d{2}(?::\d{2})?(?:\.\d+)?(?:Z|[+-]\d{2}:\d{2})?)?$/.test(v)) {
                const dt = new Date(v); return isNaN(dt) ? null : dt;
            }
            const m = v.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})(?:[ ,T]+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM|am|pm)?)?$/);
            if (m) {
                let [, dd, MM, yy, hh, mm, ss, ap] = m;
                let d = parseInt(dd, 10), mo = parseInt(MM, 10), y = parseInt(yy, 10);
                if (y < 100) y += 2000;
                let H = parseInt(hh || '0', 10), M = parseInt(mm || '0', 10), S = parseInt(ss || '0', 10);
                if (ap) { const isPM = /pm/i.test(ap); if (H === 12) H = isPM ? 12 : 0; else if (isPM) H += 12; }
                const dt = new Date(y, (mo || 1) - 1, d || 1, H, M, S);
                return isNaN(dt) ? null : dt;
            }
            const dt = new Date(v);
            if (!isNaN(dt)) return dt;
            if (fallbackISO) return parseDateDMY(fallbackISO);
            return null;
        }
        function fmtDateOnly(ts) {
            const d = parseDateDMY(ts);
            return d ? d.toLocaleDateString(undefined, { day: '2-digit', month: 'short', year: 'numeric' }) : '';
        }
        function fmtDateTime(ts) {
            const d = parseDateDMY(ts);
            if (!d) return '';
            const opts = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
            const date = d.toLocaleDateString(undefined, opts);
            const time = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
            return `${date} | <span class="ts-time">${time}</span>`;
        }
        function fmtDateWithDay(ts, short = true) {
            const d = parseDateDMY(ts);
            if (!d) return '';
            const opts = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
            return d.toLocaleDateString(undefined, opts); // Sat, 15 Feb 2026
        }
        function fmtTimeOnly(ts) {
            const d = parseDateDMY(ts);
            if (!d) return '';
            return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
        }
        function fmtINR(n) {
            const num = Number(n);
            const f = isFinite(num) ? num : 0;
            return new Intl.NumberFormat('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(f);
        }
        function toTitleCase(str) {
            return String(str || '').toLowerCase().replace(/(?:^|\s)\S/g, a => a.toUpperCase());
        }

        /* Toast + loading */
        function showToast(msg, icon = 'check-circle') {
            const wrap = document.getElementById('toast'); if (!wrap) return;
            const el = document.createElement('div');
            el.className = 'toast-msg';
            el.innerHTML = `<svg class="ico16"><use href="#i-${icon}"/></svg><span>${msg}</span>`;
            wrap.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(6px)'; }, 1600);
            setTimeout(() => el.remove(), 2000);
        }
        function setBtnLoading(btn, on, text = 'Saving...', iconId = '#i-reload') {
            if (!btn) return;
            btn.disabled = !!on;
            if (on) {
                btn.dataset.prevHtml = btn.innerHTML;

                // Special handling for printer to ensure animation works (inlining the SVG)
                if (iconId === '#i-printer') {
                    btn.innerHTML = `
<svg class="ico printing" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="6 9 6 2 18 2 18 9" class="paper-feed" />
  <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
  <rect x="6" y="14" width="12" height="8" />
</svg> ${text}`;
                } else {
                    // Default spinner
                    btn.innerHTML = `<svg class="ico spin"><use href="${iconId}"/></svg> ${text}`;
                }
            } else {
                if (btn.dataset.prevHtml) btn.innerHTML = btn.dataset.prevHtml;
            }
        }

        /* =========================
           PREVIEW (label)
           ========================= */
        function updatePreview() {
            const rn = s(document.getElementById('recipientName')?.value).trim();
            const ad = s(document.getElementById('addressInput')?.value).trim();
            const p1 = s(document.getElementById('primaryPhone')?.value).trim();
            const p2 = s(document.getElementById('secondaryPhone')?.value).trim();
            const pref = s(document.getElementById('preferredCourier')?.value);
            const includeCourier = document.getElementById('includeCourierCheckbox')?.checked;
            const useAltFrom = document.getElementById('alternateFromCheckbox')?.checked;

            const name = rn ? toTitleCase(rn) : 'Recipient Name';
            const phone = p2 ? `${p1} | ${p2}` : p1;

            let addrHtml = ad ? toTitleCase(ad).replace(/\n/g, '<br>') : 'Address will appear here';
            if (ad && includeCourier && pref) addrHtml += ` <strong>[${s(pref)}]</strong>`;

            const el = (id, html) => { const e = document.getElementById(id); if (e) e.innerHTML = html; };
            el('labelName', `<strong>${name}</strong>`);
            el('labelAddress', addrHtml);
            el('labelPhoneCombined', `<strong>Phone : ${phone}</strong>`);

            const from = document.getElementById('fromSection');
            if (from) {
                from.innerHTML = useAltFrom
                    ? `<p>From,</p><p><strong>Makkal Marunthagam,</strong></p><p>124/9, GN Complex, Cholambedu mainroad, Thirumullaivoyal, Chennai 600062</p><p>Phone: 7397359435</p>`
                    : `<p>From,</p><p><strong>Makkal Marunthagam, Chennai 600062</strong></p><p>Phone: 7397359435</p>`;
            }
        }
        function clearEntireForm() {
            if (!confirm('Clear entire form?')) return;
            const form = document.getElementById('courierForm');
            form?.reset();
            const ids = ['includeCourierCheckbox', 'alternateFromCheckbox', 'sameAsPrimary'];
            ids.forEach(id => { const e = document.getElementById(id); if (e) e.checked = false; });
            updatePreview();
        }
        function handleSubmit(e) {
            e.preventDefault();
            const form = document.getElementById('courierForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            const btn = document.getElementById('submitBtn');
            setBtnLoading(btn, true, 'Printing...', '#i-printer');
            window.hasPendingAsync = true;

            const payload = {
                recipientName: toTitleCase(s(document.getElementById('recipientName').value).trim()),
                address: toTitleCase(s(document.getElementById('addressInput').value).trim()),
                primaryPhone: s(document.getElementById('primaryPhone').value).trim(),
                secondaryPhone: s(document.getElementById('secondaryPhone').value).trim(),
                preferredCourier: s(document.getElementById('preferredCourier').value),
                orderValue: s(document.getElementById('orderValue').value).trim(),
                courierCharge: s(document.getElementById('courierCharge')?.value || '').trim(),
                accountPhone: s(document.getElementById('accountPhone').value).trim(),
                payment: s(document.getElementById('paymentStatus').value)
            };

            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) })
                .then(() => {
                    updatePreview();
                    window.print();

                    // Hard reload after successful submission to ensure latest data
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 500); // Small delay to allow print dialog to open

                    form.reset();
                    // Force Fancy Selects to update labels
                    form.querySelectorAll('select').forEach(s => s.dispatchEvent(new Event('change')));

                    ['includeCourierCheckbox', 'alternateFromCheckbox', 'sameAsPrimary'].forEach(id => { const e = document.getElementById(id); if (e) e.checked = false; });

                    // Silent Create: Prepend Row (Optimistic)
                    // 1. Determine the target sheet row based on MAX existing row in DOM
                    let maxRow = 0;
                    document.querySelectorAll('tr[data-sheetrow]').forEach(tr => {
                        const r = parseInt(tr.dataset.sheetrow, 10);
                        if (!isNaN(r) && r > maxRow) maxRow = r;
                    });
                    const targetSheetRow = maxRow + 1;

                    // Reverse-engineer "Server Index" for buildRow
                    // sheetRow = serverIndex + SHEET_HEADER_ROWS
                    const serverIndexForBuild = targetSheetRow - SHEET_HEADER_ROWS;
                    const now = new Date();

                    // 2. Construct row array
                    const dummyRow = [
                        serverIndexForBuild,
                        now.toISOString(),
                        payload.recipientName,
                        payload.address,
                        payload.primaryPhone,
                        payload.secondaryPhone,
                        payload.preferredCourier,
                        '', '', '', '',
                        payload.orderValue,
                        payload.courierCharge,
                        payload.accountPhone,
                        payload.payment
                    ];

                    // 3. Inject into Table
                    const tbody = document.querySelector('#courierList tbody');
                    if (tbody) {
                        const html = buildRow(dummyRow);
                        const temp = document.createElement('tbody');
                        temp.innerHTML = html;
                        const newTr = temp.firstElementChild;
                        if (newTr) {
                            newTr.classList.add('flash-success');
                            tbody.insertBefore(newTr, tbody.firstElementChild);
                            // Ensure the new row's dropdown is enhanced
                            enhanceAllSelects();
                        }
                    }

                    // 4. Inject into Mobile Cards
                    const mCards = document.getElementById('mCards');
                    if (mCards) {
                        const cardHtml = buildMobileCard(dummyRow);
                        mCards.insertAdjacentHTML('afterbegin', cardHtml);
                        const newCard = mCards.firstElementChild;
                        if (newCard) newCard.classList.add('flash-success');
                    }

                    // 5. Update Metrics silently
                    fetchMetricsRange(getRangeForMetrics().start, getRangeForMetrics().end);

                    // 6. SURGICAL SYNC: Fetch latest data in background & update ID
                    // FIXME: This might be updating the wrong row, causing ID collisions.
                    // Disabling for now to stabilize existing rows.
                    // syncNewRowID(payload);

                })
                .catch(err => alert('Submit failed: ' + err.message))
                .finally(() => {
                    setBtnLoading(btn, false);
                    window.hasPendingAsync = false;
                });
        }

        /* Surgical Sync: Fetch latest page and update the specific row ID in DOM */
        function syncNewRowID(payload) {
            // Small delay to let Sheet update
            setTimeout(() => {
                // Fetch specific range or just latest page? Latest page (desc) has new row at top.
                const params = new URLSearchParams({
                    action: 'search',
                    limit: '5', // Just get top 5 to find our new guy
                    sortBy: 'timestamp', order: 'desc'
                });

                fetch(`${SCRIPT_URL}?${params}`)
                    .then(r => r.json())
                    .then(({ rows }) => {
                        if (!rows || !rows.length) return;

                        // Find row matching payload (using unique combo: phone + name + val)
                        // Or just the most recent one if we trust it?
                        // Let's match by timestamp approx? No, payload doesn't have server timestamp.
                        // Match by unique fields:
                        const match = rows.find(r =>
                            r.recipientName === payload.recipientName &&
                            r.primaryPhone === payload.primaryPhone &&
                            r.orderValue === payload.orderValue
                        );

                        if (match) {
                            const realSheetRow = match.sheetRow;
                            // Find our optimistic row (which has a predicted ID)
                            // We can identify it by the fact it's likely the first one
                            // OR we can add a temporary class/ID to the optimistic row?
                            // Let's assume it's the one at the very top (first child)

                            const tbody = document.querySelector('#courierList tbody');
                            const firstTr = tbody ? tbody.firstElementChild : null;

                            if (firstTr && firstTr.classList.contains('flash-success')) {
                                // Update ID
                                firstTr.dataset.sheetrow = realSheetRow;
                                // Also update onclick/action bindings if they use closure?
                                // No, they read dataset.sheetrow dynamically.
                                console.log('Surgical Sync: Update TR to', realSheetRow);
                            }

                            const mCards = document.getElementById('mCards');
                            const firstCard = mCards ? mCards.firstElementChild : null;
                            if (firstCard && firstCard.classList.contains('flash-success')) {
                                firstCard.dataset.sheetrow = realSheetRow;
                            }
                        }
                    })
                    .catch(e => console.warn('Sync failed', e));
            }, 1500); // 1.5s delay for sheet propagation
        }

        /* =========================
           DATE RANGE helpers
           ========================= */
        function computeDateRange(kind, startEl, endEl) {
            const today = new Date(); const pad = n => String(n).padStart(2, '0');
            const toISO = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
            let start = '', end = '';
            const y = today.getFullYear();
            const m = today.getMonth();

            if (kind === 'today') { start = end = toISO(today); }
            else if (kind === 'yesterday') { const yest = new Date(today); yest.setDate(yest.getDate() - 1); start = end = toISO(yest); }
            else if (kind === 'last7') { const l7 = new Date(today); l7.setDate(today.getDate() - 7); start = toISO(l7); end = toISO(today); }
            else if (kind === 'thisWeek') {
                const d = new Date(today);
                const day = d.getDay() || 7; // 1(Mon)-7(Sun)
                if (day !== 1) d.setHours(-24 * (day - 1)); // Go back to Mon
                start = toISO(d);
                end = toISO(today);
            }
            else if (kind === 'thisMonth') { const firstDay = new Date(y, m, 1); start = toISO(firstDay); end = toISO(today); }
            else if (kind === 'custom') { start = startEl?.value || ''; end = endEl?.value || ''; }
            else { start = ''; end = ''; }
            return { start, end };
        }
        function labelFromRange(start, end) {
            if (!start && !end) return 'All dates';
            if (start === end) return fmtDateOnly(start);
            return `${fmtDateOnly(start)} \u2192 ${fmtDateOnly(end)}`;
        }

        /* =========================
           TABLE: skeleton + mirror header
           ========================= */
        function renderTableSkeleton() {
            const rows = 10;
            // Skeleton should match the 9-column structure of the real table
            const row = `<tr>${Array.from({ length: 9 }).map(() => `<td><div class="skel" style="height:16px;border-radius:6px;"></div></td>`).join('')}</tr>`;
            const html = `
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Recipient Name</th>
          <th>Address</th>
          <th>Phones</th>
          <th>Couriered via</th>
          <th>Tracking</th>
          <th>Dispatch Date</th>
          <th>Courier Charge</th>
          <th>Payment Status</th>
          <th><svg class="ico-th"><use href="#i-gear"/></svg> Actions</th>
        </tr></thead>
        <tbody>${Array.from({ length: rows }).map(() => row).join('')}</tbody>
      </table>
    </div>`;
            const c = document.getElementById('courierList'); if (c) c.innerHTML = html;
            hideMirrorHeader();
            buildMirrorHeader();
        }

        function hideMirrorHeader() {
            const m = document.getElementById('theadMirror');
            if (m) {
                m.style.opacity = '0';
                m.style.visibility = 'hidden';
            }
        }

        function buildMirrorHeader() {
            const mirror = document.getElementById('theadMirrorInner');
            if (!mirror) return;
            const labels = [
                ['Recipient Name', false, 'user'],
                ['Address', false, 'location'],
                ['Phones', false, 'phone'],
                ['Couriered via', false, 'package'],
                ['Tracking', false, 'barcode'],
                ['Dispatch Date', false, 'calendar'],
                ['Courier Charge', false, 'rupee-circle'],
                ['Payment Status', false, 'check-circle'],
                ['Actions', false, 'gear']
            ];
            mirror.innerHTML = labels.map(([t, extra, icon]) =>
                `<div class="mirror-cell ${extra ? 'extra-col' : ''}"><svg class="ico-th"><use href="#i-${icon || 'list'}"/></svg>${t}</div>`).join('');
            applyDetailColsFromSwitch();
        }

        /* =========================
           BUILD ROW (desktop)
           ========================= */
        function buildRow(r) {
            if (!Array.isArray(r) || r.length < 2) return '';
            const serverIndex = Number(r[0]);
            const sheetRow = toSheetRow(serverIndex);
            const [_, ts, name, addr, p1, p2, pref, courieredVia, trackingNumber, trackingURL, dispatchISO, orderValue, courierCharge, accountPhone, sheetPayment, txnId] = r;

            const viaOpts = [
                `<option value=""${s(courieredVia) ? '' : ' selected'}>Select Courier\u2026</option>`,
                ...courierOptions.map(o => {
                    const name = typeof o === 'object' ? o.name : o;
                    const icon = typeof o === 'object' ? o.icon : '';
                    return `<option value="${s(name)}"${s(name) === s(courieredVia) ? ' selected' : ''} data-icon="${icon || 'package'}">${s(name)}</option>`;
                })
            ].join('');

            const payStat = s(sheetPayment).trim() || 'Unpaid';
            const paymentClass = payStat === 'Paid' ? 'paid' : 'unpaid';
            const safeDispatch = s(dispatchISO) || '';
            const addrId = `addr-${sheetRow}`;
            const av = pickAvatar(s(name));
            const dayDate = fmtDateWithDay(ts, true);

            return `
  <tr data-serverindex="${serverIndex}" data-sheetrow="${sheetRow}" data-rowid="${sheetRow}"
      data-name="${s(name)}" data-ordervalue="${s(orderValue)}"
      data-p1="${s(p1)}" data-p2="${s(p2)}" data-account="${s(accountPhone)}" data-payment="${payStat}" data-dispatch="${safeDispatch}" data-ts="${s(ts)}"
      data-txnid="${s(txnId)}">
    <td>
      <div class="name-cell">
        <div class="avatar-sm" style="background:${av.bg};color:${av.fg};">${av.text}</div>
        <div class="name-stack">
          <strong>${s(name)}</strong>
          <div class="ts-subtext">
            <svg class="ico"><use href="#i-calendar"/></svg> ${dayDate || 'â€”'}
            <span class="detail-only ts-time"> ${fmtTimeOnly(ts)}</span>
          </div>
        </div>
      </div>
    </td>
    <td class="address-cell">
      <div id="${addrId}" class="address-content">${s(addr).replace(/\n/g, '<br>')}</div>
      <span class="view-more" onclick="toggleAddress('${addrId}', this)"><svg class="ico"><use href="#i-chevron"/></svg> <span>View More</span></span>
    </td>
    <td>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-start;">
          <span class="num-with-icon"><svg class="ico"><use href="#i-user"/></svg><strong>${s(accountPhone)}</strong></span>
          ${s(accountPhone) ? `<button class="view-more" onclick="informFromTable(event,'${sheetRow}','account')" style="border:none; font-family:inherit;"><svg class="ico"><use href='#i-whatsapp'/></svg> Share</button>` : ''}
        </div>
        
        ${s(p1) ? `
          <div class="detail-only" style="flex-direction:column; align-items:flex-start; gap:4px;">
             <span class="num-with-icon" style="color:#15803d;"><svg class="ico"><use href="#i-num-1"/></svg><strong>${s(p1)}</strong></span>
             <button class="view-more" onclick="informFromTable(event,'${sheetRow}','p1')" style="border:none; font-family:inherit;"><svg class="ico"><use href='#i-whatsapp'/></svg> Share</button>
          </div>` : ''}

        ${s(p2) ? `
          <div class="detail-only sec-ph" style="flex-direction:column; align-items:flex-start; gap:4px;">
            <span class="num-with-icon" style="color:#b45309;"><svg class="ico"><use href="#i-num-2"/></svg>${s(p2)}</span>
            <button class="view-more" onclick="informFromTable(event,'${sheetRow}','p2')" style="border:none; font-family:inherit;"><svg class="ico"><use href='#i-whatsapp'/></svg> Share</button>
          </div>` : ''}
      </div>
    </td>
    <td>
      <div style="display:flex; flex-direction:column; gap:2px;">
        <select class="inline-select fancy-select" data-field="courieredVia" disabled onchange="onCourierChange(this)">${viaOpts}</select>
        ${s(pref) ? `<div class="detail-only" style="font-size:11px; color:var(--muted); margin-left:2px;">Preferred: ${s(pref)}</div>` : ''}
      </div>
    </td>
    <td>
      <div style="display:flex; flex-direction:column; gap:4px;">
        <div style="display:flex; align-items:center; gap:6px;">
          <input class="inline-input" data-field="trackingNumber" disabled value="${s(trackingNumber)}" placeholder="#\u2026" />
          <button class="copy-btn" title="Copy tracking"><svg class="ico16"><use href="#i-clipboard"/></svg></button>
        </div>
        <a class="view-more detail-only" href="${s(trackingURL) || '#'}" target="_blank" style="text-decoration:none; align-self:flex-start; margin-top:2px;">
           <span>View</span> <svg class="ico" style="transform:none!important;"><use href="#i-link"/></svg>
        </a>
        <input type="hidden" data-field="trackingURL" value="${s(trackingURL)}" />
      </div>
    </td>
    <td>
      <input type="date" class="inline-input" data-field="dispatchDate" disabled value="${safeDispatch}" />
    </td>
    <td>
      <input type="number" step="0.01" class="inline-input" data-field="courierCharge" disabled value="${s(courierCharge)}" placeholder=" " />
    </td>
    <td>
      <div style="display:flex; flex-direction:column; gap:2px;">
        <div class="amount-top" style="font-weight:600; font-size:13px;">\u20B9${fmtINR(orderValue)}</div>
        <div class="status-wrap">
          <span class="status-tag ${paymentClass} payment-tag">
            <svg class="ico16"><use href="#i-${payStat === 'Paid' ? 'check-circle' : 'x-circle'}"/></svg> ${payStat}
          </span>
          <select class="payment-select fancy-select" data-field="payment" disabled>
            <option value="Paid"${payStat === 'Paid' ? ' selected' : ''}>Paid</option>
            <option value="Unpaid"${payStat === 'Unpaid' ? ' selected' : ''}>Unpaid</option>
          </select>
          ${payStat === 'Paid' && txnId ? `<button class="view-more detail-only" onclick="showTxnDetails(event, '${txnId}')" style="margin-top:2px; border:none; font-family:inherit; background:rgba(16, 185, 129, 0.1); color:#059669;">Details</button>` : ''}
        </div>
      </div>
    </td>
    <td>
      <button class="action-btn edit-btn" title="Edit"><svg class="ico"><use href="#i-pencil"/></svg></button>
      <button class="action-btn save-btn" title="Save" style="display:none;"><svg class="ico"><use href="#i-check-square"/></svg></button>
      <button class="action-btn" title="Reprint Label" onclick="reprintLabel('${sheetRow}')"><svg class="ico"><use href="#i-printer"/></svg></button>
      <button class="action-btn delete-btn" title="Delete"><svg class="ico"><use href="#i-trash"/></svg></button>
    </td>
  </tr>`;
        }

        function renderTable(rows) {
            const safeRows = Array.isArray(rows) ? rows : [];
            const html = `
    <div class="table-wrap">
      <table id="ordersTable">
        <thead><tr>
          <th>Recipient Name</th>
          <th>Address</th>
          <th>Phones</th>
          <th>Couriered via</th>
          <th>Tracking</th>
          <th>Dispatch Date</th>
          <th>Courier Charge</th>
          <th>Payment Status</th>
          <th><svg class="ico-th"><use href="#i-gear"/></svg> Actions</th>
        </tr></thead>
        <tbody>${safeRows.map(buildRow).join('')}</tbody>
      </table>
    </div>`;
            const c = document.getElementById('courierList'); if (c) c.innerHTML = html;

            enhanceAllSelects();
            applyDetailColsFromSwitch();
            // sync mirror widths once rows are in
            syncMirrorWidths();
        }

        /* =========================
           MOBILE CARDS
           ========================= */
        function mobileCardSkeleton(count = 6) {
            const c = document.getElementById('mCards');
            if (!c) return;
            c.innerHTML = `<div class="block-skeleton">${Array.from({ length: count }).map(() => `<div class="skel" style="height:90px;border-radius:16px;"></div>`).join('')}</div>`;
        }
        function buildMobileCard(r) {
            if (!Array.isArray(r) || r.length < 2) return '';
            const serverIndex = Number(r[0]);
            const sheetRow = toSheetRow(serverIndex);

            // Destructure same as buildRow
            const [_, ts, name, addr, p1, p2, pref, courieredVia, trackingNumber, trackingURL, dispatchISO, orderValue, courierCharge, accountPhone, sheetPayment, txnId] = r;

            const payStat = s(sheetPayment).trim() || 'Unpaid';
            const pClass = payStat === 'Paid' ? 'paid' : 'unpaid';
            const cc = Number(courierCharge) || 0;
            const av = pickAvatar(s(name));
            const dayDate = fmtDateWithDay(ts, true) || '\u2014';
            const timeStr = fmtTimeOnly(ts);
            const icon = payStat === 'Paid' ? 'check-circle' : 'x-circle';

            const isShipped = !!s(trackingNumber).trim();

            return `
  <div class="mcard with-bar-left" data-sheetrow="${sheetRow}">
    <div class="avatar" style="background:${av.bg};color:${av.fg};">${av.text}</div>
    <div class="name">${s(name)}</div>
    <div class="meta">
      <div class="meta-line" style="flex-wrap:wrap; gap:6px;">
        <div style="display:flex; align-items:center; gap:4px; flex-wrap:wrap;">
           <svg class="ico"><use href="#i-calendar"/></svg><span>${dayDate}</span>
        </div>
        ${isShipped ? `<span class="badge shipped" style="padding:2px 6px; font-size:10px; border-radius:4px; height:auto; width:auto; font-weight:700;">SHIPPED</span>` : ''}
      </div>
      <div class="meta-line"><svg class="ico"><use href="#i-idcard"/></svg><span>${s(accountPhone)}</span></div>
    </div>
      <div class="right-stack">
        <div class="amount">\u20B9${fmtINR(orderValue)}</div>
        <div class="badge ${pClass}"><svg class="ico"><use href="#i-${icon}"/></svg> ${payStat}</div>
      </div>
    </div>`;
        }
        function renderMobileCards(rows, replace = true) {
            const m = document.getElementById('mCards');
            if (!m) return;
            if (replace) m.innerHTML = '';
            (Array.isArray(rows) ? rows : []).forEach(r => m.insertAdjacentHTML('beforeend', buildMobileCard(r)));
        }

        /* =========================
           FANCY SELECT
           ========================= */
        let FS_OPEN = null;

        function floatLabel(el, on) {
            if (!el) return;
            el.style.top = on ? '-8px' : '9px';
            el.style.left = on ? '6px' : '8px';
            el.style.fontSize = on ? '10.5px' : '11px';
            el.style.fontWeight = on ? '600' : '400';
            el.style.zIndex = '10';
        }
        function syncSelectLabelState(selectEl) {
            const group = selectEl.closest('.form-group');
            if (!group) return;
            const label = group.querySelector('label');
            if (!label) return;
            const hasValue = !!selectEl.value;
            floatLabel(label, hasValue);
        }
        function hookSelectLabel(selectEl) {
            selectEl.addEventListener('change', () => syncSelectLabelState(selectEl));
            syncSelectLabelState(selectEl);
        }
        function enhanceSelect(sel) {
            if (!sel || sel.dataset.fsEnhanced === '1') return;
            sel.dataset.fsEnhanced = '1';
            sel.classList.add('fancy-select');
            const wrap = document.createElement('div');
            wrap.className = 'fs';
            if (sel.classList.contains('payment-select')) {
                wrap.classList.add('hide-until-edit');
            }
            sel.parentNode.insertBefore(wrap, sel);
            wrap.appendChild(sel);

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'fs-btn';
            btn.setAttribute('aria-haspopup', 'listbox');
            btn.setAttribute('aria-expanded', 'false');
            const lab = document.createElement('span');
            lab.className = 'fs-label';
            const caret = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            caret.classList.add('fs-caret', 'ico');
            caret.innerHTML = '<use href="#i-chevron"/>';
            btn.appendChild(lab); btn.appendChild(caret);
            wrap.appendChild(btn);

            let portal = null, listEl = null;

            function optionsData() {
                return Array.from(sel.options).map((o) => ({
                    value: o.value, text: o.textContent, disabled: o.disabled, selected: o.selected,
                    icon: o.getAttribute('data-icon') // Capture icon config
                }));
            }
            function currentLabel() {
                const o = sel.options[sel.selectedIndex];
                if (!o || o.value === '') {
                    const first = sel.options[0];
                    return first ? first.textContent : 'Select\u2026';
                }
                return o.textContent;
            }
            function isPlaceholderSelected() {
                const o = sel.options[sel.selectedIndex]; return !o || o.value === '';
            }
            function refreshButton() {
                lab.textContent = currentLabel();
                wrap.classList.toggle('placeholder', isPlaceholderSelected());
                // Update specific styles if needed
                const o = sel.options[sel.selectedIndex];
                const icon = o ? o.getAttribute('data-icon') : null;
                // remove old icon if any
                const oldIco = btn.querySelector('.fs-ico-preview');
                if (oldIco) oldIco.remove();

                if (icon) {
                    let ih = '';
                    if (icon.startsWith('http') || icon.includes('data:image')) {
                        ih = `<img src="${icon}" class="ico16 fs-ico-preview" style="width:16px;height:16px;object-fit:contain;margin-right:6px;">`;
                    } else {
                        ih = `<svg class="ico16 fs-ico-preview" style="margin-right:6px;opacity:0.75;"><use href="#i-${icon}"/></svg>`;
                    }
                    lab.insertAdjacentHTML('afterbegin', ih);
                }

                if (sel.closest('.form-group')) syncSelectLabelState(sel);
            }

            // Sync on native change (e.g. programmatic update)
            sel.addEventListener('change', refreshButton);

            // INSIDE openFs -> optionsData loop:
            /* 
               We need to replace the loop logic. 
               Since replace_file_content targets specific lines, I will include the openFs function part here.
            */

            /* NOTE: The above functions (optionsData) are updated. 
               Now I need to target the separate block where the loop happens. 
               I will split this into two edits if needed, or use a larger block. 
               Let's assume I am rewriting `enhanceSelect` internals or just the `optionsData` and the rendering loop.
            */

            // actually, let's just do the whole block for safer replacement of the loop

            function setDisabledState() {
                const dis = sel.disabled;
                wrap.classList.toggle('disabled', dis);
                btn.setAttribute('aria-disabled', dis ? 'true' : 'false');
                btn.tabIndex = dis ? -1 : 0;
            }
            function closeFs() {
                if (!FS_OPEN) return;
                const { portal: p, wrap: w, btn: b } = FS_OPEN;
                if (p && p.parentNode) p.parentNode.removeChild(p);
                w.classList.remove('open');
                b.setAttribute('aria-expanded', 'false');
                FS_OPEN = null;
                window.removeEventListener('scroll', onReposition, true);
                window.removeEventListener('resize', onReposition, true);
                document.removeEventListener('click', onDocClick, true);
            }
            function onReposition() {
                if (!FS_OPEN) return;
                const { btn: b, portal: p } = FS_OPEN;
                const r = b.getBoundingClientRect();
                const minW = Math.max(r.width, 180);
                p.style.left = Math.round(r.left) + 'px';
                p.style.minWidth = Math.round(minW) + 'px';
                const below = r.bottom + 8;
                const above = r.top - 8;
                const spaceBelow = window.innerHeight - r.bottom - 10;
                const willOpenAbove = spaceBelow < 220 && above > 220;
                if (willOpenAbove) {
                    p.style.top = 'auto';
                    p.style.bottom = (window.innerHeight - r.top + 8) + 'px';
                    FS_OPEN.listEl.style.marginTop = '0';
                } else {
                    p.style.bottom = 'auto';
                    p.style.top = Math.round(below) + 'px';
                }
            }
            function onDocClick(ev) {
                if (!FS_OPEN) return;
                const { wrap: w, portal: p } = FS_OPEN;
                if (w.contains(ev.target) || (p && p.contains(ev.target))) return;
                closeFs();
            }
            function openFs() {
                if (sel.disabled) return;
                if (FS_OPEN) closeFs();
                portal = document.createElement('div'); portal.className = 'fs-portal';
                listEl = document.createElement('div'); listEl.className = 'fs-list'; listEl.setAttribute('role', 'listbox');
                portal.appendChild(listEl);
                document.body.appendChild(portal);

                listEl.innerHTML = '';
                optionsData().forEach(o => {
                    const opt = document.createElement('div');
                    opt.className = 'fs-opt';
                    opt.setAttribute('role', 'option');
                    opt.setAttribute('data-value', o.value);
                    opt.setAttribute('aria-selected', o.selected ? 'true' : 'false');
                    opt.setAttribute('aria-current', o.selected ? 'true' : 'false');
                    if (o.disabled) opt.setAttribute('aria-disabled', 'true');

                    let ih = '';
                    let spanStyle = '';

                    if (o.icon && (o.icon.startsWith('http') || o.icon.includes('data:image'))) {
                        ih = `<img src="${o.icon}" class="ico16" style="width:16px;height:16px;object-fit:contain;margin-right:4px;">`;
                    } else if (o.icon) {
                        ih = `<svg class="ico16" style="color:var(--text); opacity:0.75;"><use href="#i-${o.icon}"/></svg>`;
                    } else if (o.text === 'Paid') {
                        ih = '<svg class="ico16" style="color:#22c55e;"><use href="#i-check-circle"/></svg>';
                        spanStyle = ' style="color:#22c55e;"';
                    } else if (o.text === 'Unpaid') {
                        ih = '<svg class="ico16" style="color:#ef4444;"><use href="#i-x-circle"/></svg>';
                        spanStyle = ' style="color:#ef4444;"';
                    }
                    opt.innerHTML = `<span${spanStyle}>${o.text}</span>${ih}`;
                    if (!o.disabled) {
                        opt.addEventListener('click', () => {
                            if (sel.value !== o.value) {
                                sel.value = o.value;
                                sel.setAttribute('value', o.value);
                                sel.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                            refreshButton();
                            closeFs();
                            btn.focus();
                        });
                    } else {
                        opt.style.opacity = .5;
                        opt.style.cursor = 'not-allowed';
                    }
                    listEl.appendChild(opt);
                });

                wrap.classList.add('open');
                btn.setAttribute('aria-expanded', 'true');
                FS_OPEN = { wrap, select: sel, btn, listEl, portal };
                onReposition();
                window.addEventListener('scroll', onReposition, true);
                window.addEventListener('resize', onReposition, true);
                setTimeout(() => document.addEventListener('click', onDocClick, true), 0);

                const cur = listEl.querySelector('.fs-opt[aria-selected="true"]') || listEl.querySelector('.fs-opt:not([aria-disabled="true"])');
                if (cur) { cur.setAttribute('aria-current', 'true'); cur.scrollIntoView({ block: 'nearest' }); }
            }

            btn.addEventListener('click', () => { if (sel.disabled) return; if (FS_OPEN && FS_OPEN.select === sel) closeFs(); else openFs(); });
            btn.addEventListener('keydown', (e) => {
                if (sel.disabled) return;
                if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); openFs(); }
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    openFs();
                    const opts = Array.from(listEl.querySelectorAll('.fs-opt:not([aria-disabled="true"])'));
                    if (!opts.length) return;
                    const dir = e.key === 'ArrowDown' ? 1 : -1;
                    let idx = opts.findIndex(o => o.getAttribute('aria-current') === 'true');
                    idx = (idx < 0) ? (dir > 0 ? 0 : opts.length - 1) : Math.max(0, Math.min(opts.length - 1, idx + dir));
                    opts.forEach(o => o.removeAttribute('aria-current'));
                    opts[idx].setAttribute('aria-current', 'true');
                    opts[idx].scrollIntoView({ block: 'nearest' });
                }
                if (e.key === 'Escape') { if (FS_OPEN) closeFs(); }
            });
            document.addEventListener('keydown', (e) => {
                if (!FS_OPEN || FS_OPEN.select !== sel) return;
                if (e.key === 'Enter') {
                    const cur = FS_OPEN.listEl.querySelector('.fs-opt[aria-current="true"]');
                    if (cur && !cur.hasAttribute('aria-disabled')) {
                        const v = cur.getAttribute('data-value');
                        if (sel.value !== v) {
                            sel.value = v;
                            sel.setAttribute('value', v);
                            sel.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        refreshButton();
                    }
                    closeFs(); btn.focus();
                }
            });

            const mo = new MutationObserver(() => setDisabledState());
            mo.observe(sel, { attributes: true, attributeFilter: ['disabled'] });

            sel.addEventListener('change', refreshButton);
            setDisabledState();
            refreshButton();
            if (sel.value) sel.setAttribute('value', sel.value);
            if (sel.closest('.form-group')) hookSelectLabel(sel);
        }
        function enhanceAllSelects() {
            document.querySelectorAll('select.fancy-select').forEach(enhanceSelect);
        }

        /* Paper size logic */
        const paperSelect = document.getElementById('paperSelect');
        const dynamicPrint = document.getElementById('dynamicPrint');

        function updatePaperSize() {
            const val = paperSelect.value;
            let css = '';
            if (val === 'a5-landscape') css = '@page { size: A5 landscape; margin: 0; }';
            else if (val === 'a5-portrait') css = '@page { size: A5 portrait; margin: 0; }';
            else if (val === 'a4-portrait') css = '@page { size: A4 portrait; margin: 0; }';
            else if (val === 'a4-landscape') css = '@page { size: A4 landscape; margin: 0; }';
            else if (val === 'th-88') css = '@page { size: 88mm auto; margin: 0; }';
            else if (val === 'lbl-105') css = '@page { size: 105mm auto; margin: 0; }';

            // Update variables for preview width on screen
            const r = document.documentElement;
            // User requested MAX width of 10.5cm for ALL "Paper" sizes (A4, A5 etc.)
            // Exception: if thermal is narrower than 10.5cm (e.g. 88mm), use that.
            let width = '10.5cm';

            if (val.includes('88')) width = '86mm'; // slightly less than 88mm to be safe
            else if (val.includes('105')) width = '103mm'; // ~10.5cm

            r.style.setProperty('--preview-w', width);

            dynamicPrint.textContent = css;
        }

        if (paperSelect) {
            paperSelect.addEventListener('change', updatePaperSize);
            // Initialize logic
            updatePaperSize();
        }

        /* =========================
           BACKEND HELPERS
           ========================= */
        function populatePreferredCourier() {
            return cachedFetch('cms_couriers', `${SCRIPT_URL}?action=tracking`, list => {
                courierOptions = (list || []).filter(v => { const name = typeof v === 'object' ? v.name : v; return !/heading/i.test(s(name)); });
                const dd = document.getElementById('preferredCourier');
                if (dd) {
                    dd.innerHTML = `<option value="" disabled selected hidden>Select Courier</option>`;
                    courierOptions.forEach(n => {
                        const o = document.createElement('option');
                        const name = typeof n === 'object' ? n.name : n;
                        const icon = typeof n === 'object' ? n.icon : '';
                        o.value = s(name);
                        o.textContent = s(name);
                        if (icon) o.setAttribute('data-icon', icon);
                        dd.appendChild(o);
                    });
                    enhanceAllSelects();
                    syncSelectLabelState(dd);
                }
            });
        }
        function loadTrackingMap() {
            return cachedFetch('cms_trackingMap', `${SCRIPT_URL}?action=getTrackingMap`, map => {
                trackingMap = map || {};
            });
        }
        function loadUPILogoMap() {
            return cachedFetch('cms_upiMap', `${SCRIPT_URL}?action=getUPIMap`, list => {
                globalUPILogoMap = {};
                if (Array.isArray(list)) {
                    list.forEach(item => {
                        if (item.name && item.logo) {
                            globalUPILogoMap[item.name] = item.logo;
                        }
                    });
                }
            });
        }

        /* =========================
           FETCH LIST / PAGINATION
           ========================= */
        function resetDateFilterAndFetch() {
            uiDateFilter = 'all';
            const sd = document.getElementById('startDate'); if (sd) sd.value = '';
            const ed = document.getElementById('endDate'); if (ed) ed.value = '';
            const dl = document.getElementById('dateLabel'); if (dl) dl.textContent = 'All dates';
            const si = document.getElementById('searchInput'); if (si) si.value = '';
            currentOffset = 0; isLastPage = false;
            fetchPage(false);
        }

        function fetchPage(append = false, options = {}) {
            const sd = document.getElementById('startDate');
            const ed = document.getElementById('endDate');
            let { start, end } = computeDateRange(uiDateFilter, sd, ed);

            if (options.ignoreDate) { start = ''; end = ''; }

            const q = document.getElementById('searchInput')?.value.trim() || '';

            const params = new URLSearchParams({
                action: 'search', q, payment: paymentFilter, startDate: start, endDate: end,
                dateField: 'timestamp',
                offset: String(currentOffset), limit: String(PAGE_LIMIT), sortBy: 'timestamp', order: 'desc',
                _t: Date.now()
            });

            if (!append) {
                renderTableSkeleton();
                if (isMobile()) mobileCardSkeleton();
            }

            const loadBtn = document.getElementById('loadMoreBtn');
            if (append) setBtnLoading(loadBtn, true, 'Loading...');

            lastQuery = q;

            return fetch(`${SCRIPT_URL}?${params}`)
                .then(r => r.json())
                .then(({ rows }) => {
                    const list = Array.isArray(rows) ? rows : [];

                    if (list.length === 0 && !append) {
                        let actionsHtml = '';
                        // Check if Date Filter is active (anything other than 'all')
                        // OR if search query exists.
                        // But specifically for Date Filter requirement:
                        if (uiDateFilter !== 'all') {
                            actionsHtml = `
                                <div style="display:flex; gap:10px; justify:center; margin-top:16px; flex-wrap:wrap;">
                                    <button class="btn" onclick="fetchPage(false, { ignoreDate: true })">Show All Results</button>
                                    <button class="btn btn-primary" onclick="resetDateFilterAndFetch()">Clear Filter & Show All</button>
                                </div>
                            `;
                        } else if (q) {
                            actionsHtml = `
                                 <button class="btn btn-primary" style="margin-top:16px;" onclick="document.getElementById('searchClearBtn').click()">
                                    Show All
                                 </button>
                             `;
                        } else {
                            actionsHtml = `
                                 <button class="btn" style="margin-top:16px;" onclick="refreshTableAndMetrics()">
                                    <svg class="ico"><use href="#i-refresh"/></svg> Refresh
                                 </button>
                             `;
                        }

                        const emptyHTML = `
               <div class="empty-state">
                 <svg class="ico"><use href="#i-search"/></svg>
                 <h3>No results found</h3>
                 <p>We couldn't find any matches${q ? ' for "' + q + '"' : ''}.</p>
                 ${actionsHtml}
               </div>
             `;
                        const cl = document.getElementById('courierList');
                        const mc = document.getElementById('mCards');

                        if (cl) {
                            // Render empty table structure to keep headers and allow syncing
                            renderTable([]);
                            // Append empty state after the table if desired, or just show it instead of tbody
                            const wrap = cl.querySelector('.table-wrap');
                            if (wrap) wrap.insertAdjacentHTML('beforeend', emptyHTML);
                            else cl.innerHTML = emptyHTML;
                        }
                        if (mc) mc.innerHTML = emptyHTML;

                        // Hide Load More
                        const lb = document.getElementById('loadMoreBtn');
                        if (lb) lb.style.display = 'none';

                        clearListInlineDisplay();
                        hideMirrorHeader(); // Ensure hidden on empty
                        syncMirrorWidths(); // Sync for structure but keep hidden
                    } else {
                        if (!append) {
                            renderTable(list);
                        } else {
                            const tbody = document.querySelector('#courierList tbody');
                            list.forEach(r => { tbody.insertAdjacentHTML('beforeend', buildRow(r)); });
                            enhanceAllSelects();
                            applyDetailColsFromSwitch();
                            syncMirrorWidths();
                        }
                        renderMobileCards(list, !append);

                        currentOffset += list.length;
                        isLastPage = list.length < PAGE_LIMIT;
                        updateLoadMoreVisibility();
                        clearListInlineDisplay();
                    }

                    if (q === '') {
                        if (!append) baseCache.rows = list;
                        else baseCache.rows = baseCache.rows.concat(list);
                        baseCache.offset = currentOffset;
                        baseCache.isLastPage = isLastPage;
                    }
                })
                .catch(err => {
                    console.error('fetchPage error:', err);
                    const c = document.getElementById('courierList');
                    if (c) c.innerHTML = '<div class="card" style="padding:12px;">Error loading</div>';
                    if (isMobile()) document.getElementById('mCards').innerHTML = '<div class="card" style="padding:12px;">Error loading</div>';
                })
                .finally(() => setBtnLoading(loadBtn, false));
        }
        function updateLoadMoreVisibility() {
            const listHasItems = (document.querySelector('#mCards')?.children.length || 0) > 0
                || (document.querySelector('#courierList tbody')?.children.length || 0) > 0;
            const b = document.getElementById('loadMoreBtn'); if (!b) return;
            b.style.display = (listHasItems && !isLastPage) ? 'inline-block' : 'none';
        }

        /* =========================
           METRICS
           ========================= */
        function gaugeSvg(perc, colorClass) {
            // Gauge Logic: 240deg arc (-120 to +120)
            const r = 24;
            const startAngle = -120;
            const endAngle = 120;
            const range = endAngle - startAngle; // 240

            const p = Math.max(0, Math.min(100, Number(perc) || 0));
            const valueAngle = startAngle + (p / 100) * range;

            const polarToCartesian = (cx, cy, radius, angleInDegrees) => {
                const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
                return {
                    x: cx + (radius * Math.cos(angleInRadians)),
                    y: cy + (radius * Math.sin(angleInRadians))
                };
            };

            const describeArc = (x, y, radius, start, end) => {
                const startPt = polarToCartesian(x, y, radius, end);
                const endPt = polarToCartesian(x, y, radius, start);
                const largeArcFlag = end - start <= 180 ? "0" : "1";
                const d = [
                    "M", startPt.x, startPt.y,
                    "A", radius, radius, 0, largeArcFlag, 0, endPt.x, endPt.y
                ].join(" ");
                return d;
            };

            const trackD = describeArc(30, 30, r, startAngle, endAngle);
            const valueD = describeArc(30, 30, r, startAngle, valueAngle);

            // Determine stroke color
            // If colorClass is passed, we map to gradient ID
            let strokeUrl = "url(#grad-theme)"; // default
            if (colorClass?.includes('c-green')) strokeUrl = "url(#grad-green)";
            if (colorClass?.includes('c-rose')) strokeUrl = "url(#grad-rose)";
            if (colorClass?.includes('c-amber')) strokeUrl = "url(#grad-amber)";

            return `
    <div class="radial gauge">
      <svg viewBox="0 0 60 50" aria-hidden="true">
        <defs>
          <linearGradient id="grad-theme" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#7c3aed" />
            <stop offset="100%" stop-color="#6d28d9" />
          </linearGradient>
          <linearGradient id="grad-green" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#10b981" />
            <stop offset="100%" stop-color="#34d399" />
          </linearGradient>
          <linearGradient id="grad-rose" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#f43f5e" />
            <stop offset="100%" stop-color="#fb7185" />
          </linearGradient>
          <linearGradient id="grad-amber" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#f59e0b" />
            <stop offset="100%" stop-color="#fbbf24" />
          </linearGradient>
        </defs>
        <path class="track" d="${trackD}" fill="none" stroke-width="6" stroke-linecap="round" />
        <path class="value" d="${valueD}" fill="none" stroke-width="6" stroke-linecap="round" stroke="${strokeUrl}" />
      </svg>
    </div>`;
        }
        function deltaBadge(curr, prev) {
            const c = Number(curr) || 0, p = Number(prev) || 0;
            if (p === 0 && c === 0) return `<span class="delta">â€”</span>`;
            const diff = c - p;
            const pct = p === 0 ? 100 : Math.abs(diff) / p * 100;
            const up = diff >= 0;
            const icon = up ? 'i-arrow-up-right' : 'i-arrow-down-right';
            return `<span class="delta ${up ? 'up' : 'down'}">
        <svg class="ico16" style="width:10px;height:10px;vertical-align:0;margin-right:2px;stroke-width:2.5;"><use href="#${icon}"/></svg>
        ${pct.toFixed(0)}%
      </span>`;
        }
        function showMetricsSkeleton() {
            const grid = document.getElementById('metricsGrid');
            if (!grid) return;
            grid.innerHTML = `
    ${Array.from({ length: 6 }).map(() => `
      <div class="metric">
        <div class="viz skel" style="height:52px;border-radius:50%"></div>
        <span class="k skel" style="height:16px;border-radius:8px;display:block;"></span>
        <span class="l skel" style="height:12px;border-radius:8px;display:block;"></span>
      </div>`).join('')}
  `;
        }
        function getRangeForMetrics() {
            let start = document.getElementById('metricsStartDate')?.value || '';
            let end = document.getElementById('metricsEndDate')?.value || '';

            if (!start && !end) {
                const t = new Date(); const pad = n => String(n).padStart(2, '0');
                const iso = `${t.getFullYear()}-${pad(t.getMonth() + 1)}-${pad(t.getDate())}`;
                start = end = iso;
            }

            const toD = s => { if (!s) return null; const [y, m, d] = s.split('-').map(Number); return new Date(y, m - 1, d); };
            const toISO = d => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            let ps = '', pe = '';
            if (start && end) {
                const sD = toD(start), eD = toD(end);
                if (sD && eD) {
                    const days = Math.max(1, Math.round((eD - sD) / 86400000) + 1);
                    const peD = new Date(sD); peD.setDate(peD.getDate() - 1);
                    const psD = new Date(peD); psD.setDate(psD.getDate() - (days - 1));
                    ps = toISO(psD); pe = toISO(peD);
                }
            }
            return { start, end, prevStart: ps, prevEnd: pe };
        }
        function fetchMetricsRange(start, end) {
            return fetch(`${SCRIPT_URL}?action=metrics&dateField=timestamp&startDate=${encodeURIComponent(start)}&endDate=${encodeURIComponent(end)}&_t=${Date.now()}`)
                .then(r => r.json())
                .catch(() => ({}));
        }
        function fetchMetrics() {
            console.log('[Metrics] fetchMetrics called');
            showMetricsSkeleton();
            const grid = document.getElementById('metricsGrid');
            const r = getRangeForMetrics();
            console.log('[Metrics] date range:', JSON.stringify(r));
            if (!r.start || !r.end) { console.warn('[Metrics] No start/end date, aborting'); return; }

            // Check if we are in "Default" mode (no explicit inputs set)
            const isDefault = !document.getElementById('metricsStartDate')?.value;

            // Wrap main fetch in a handler to support fallback
            const tryFetch = (range, isFallback = false) => {
                Promise.all([
                    fetchMetricsRange(range.start, range.end),
                    range.prevStart && range.prevEnd ? fetchMetricsRange(range.prevStart, range.prevEnd) : Promise.resolve({})
                ]).then(([cur, prev]) => {
                    // FALLBACK LOGIC: If default mode, not a fallback retry, and no orders today -> Try Last 7 Days
                    const hasData = (Number(cur.totalOrders) || 0) > 0;
                    if (isDefault && !isFallback && !hasData) {
                        const l7 = computeDateRange('last7');
                        const pStart = new Date(l7.start); pStart.setDate(pStart.getDate() - 7);
                        const pEnd = new Date(l7.start); pEnd.setDate(pEnd.getDate() - 1);
                        const toI = d => d.toISOString().split('T')[0];

                        const newRange = {
                            start: l7.start, end: l7.end,
                            prevStart: toI(pStart), prevEnd: toI(pEnd)
                        };

                        const ml = document.getElementById('metricsDateLabel');
                        if (ml) ml.textContent = "Last 7 Days (Auto)";

                        tryFetch(newRange, true);
                        return;
                    }

                    renderMetricsUI(cur, prev);
                    const grid = document.getElementById('metricsGrid');
                    if (grid && !grid.children.length) {
                        console.warn('[Metrics] Grid is still empty after renderMetricsUI');
                    }
                }).catch(err => {
                    console.error('Metrics fetch/render failed:', err);
                    const grid = document.getElementById('metricsGrid');
                    if (grid) grid.innerHTML = '<div class="empty-state">Failed to load metrics</div>';
                });
            };

            tryFetch(r);
        }

        function renderMetricsUI(cur, prev) {
            console.log('[Metrics] renderMetricsUI called with:', JSON.stringify(cur));
            try {
                const totalOrders = Number(cur.totalOrders) || 0;
                const grid = document.getElementById('metricsGrid');
                console.log('[Metrics] grid element:', grid ? 'found' : 'NOT FOUND');
                const totalOrderValue = Number(cur.totalOrderValue) || 0;
                const paymentsReceived = Number(cur.paymentsReceived) || 0;
                const outstanding = Number(cur.totalOutstanding) || 0;
                const totalCourierCharges = Number(cur.totalCourierCharges) || 0;
                const avgOrderValue = totalOrders ? (totalOrderValue / totalOrders) : 0;

                const p_totalOrders = Number(prev.totalOrders) || 0;
                const p_totalOrderValue = Number(prev.totalOrderValue) || 0;
                const p_paymentsReceived = Number(prev.paymentsReceived) || 0;
                const p_outstanding = Number(prev.totalOutstanding) || 0;
                const p_totalCourierCharges = Number(prev.totalCourierCharges) || 0;
                const p_avgOrderValue = p_totalOrders ? (p_totalOrderValue / p_totalOrders) : 0;

                const pct = (a, b) => b ? Math.min(100, (a / b) * 100) : 0;

                const collectionRate = pct(paymentsReceived, totalOrderValue);
                const outstandingRate = pct(outstanding, totalOrderValue);
                const chargeRate = pct(totalCourierCharges, totalOrderValue);
                const aovBaselineRate = Math.min(100, (avgOrderValue / 2000) * 100);
                const ovVsPrev = p_totalOrderValue ? Math.min(100, (totalOrderValue / p_totalOrderValue) * 100) : (totalOrderValue ? 100 : 0);
                const ordersVsPrev = p_totalOrders ? Math.min(100, (totalOrders / p_totalOrders) * 100) : (totalOrders ? 100 : 0);

                const ru = n => `\u20B9${fmtINR(n)}`;

                const arrowIcon = (isInteractive) => `
          <div class="metric-arrow ${isInteractive ? 'active' : 'disabled'}">
            <svg viewBox="0 0 24 24" fill="none" class="chevron-icon">
              <path d="M9 18L15 12L9 6" stroke="url(#themeGradient)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              <defs>
                <linearGradient id="themeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#7c3aed" />
                  <stop offset="100%" stop-color="#6d28d9" />
                </linearGradient>
              </defs>
            </svg>
          </div>
        `;

                const card = (cls, title, val, delta, sv, interactive) => `
      <div class="metric ${cls} ${interactive ? 'clickable' : ''}" ${interactive ? `onclick="applyPaymentFilter('${interactive}')"` : ''}>
        <div class="metric-top">
          <span class="l">${title}</span>
          <span class="k">${val}</span>
        </div>
        
        <div class="gauge-wrap">
           ${gaugeSvg(sv, cls)}
           <div class="centered-val">
             ${delta}
           </div>
        </div>

        <div class="metric-foot">
          <span>${interactive ? 'View Details' : 'Analytics'}</span>
          <svg class="ico16"><use href="#i-chevron-right"/></svg>
        </div>
      </div>
      `;

                grid.innerHTML = `
        ${card('c-amber', 'Total Orders', totalOrders, deltaBadge(totalOrders, p_totalOrders), ordersVsPrev, 'All')}
        ${card('c-green', 'Payments Received', ru(paymentsReceived), deltaBadge(paymentsReceived, p_paymentsReceived), collectionRate, 'Paid')}
        ${card('c-rose', 'Amount to be received', ru(outstanding), deltaBadge(outstanding, p_outstanding), outstandingRate, 'Unpaid')}
        ${card('', 'Order Value', ru(totalOrderValue), deltaBadge(totalOrderValue, p_totalOrderValue), ovVsPrev, null)}
        ${card('', 'Courier Charges', ru(totalCourierCharges), deltaBadge(totalCourierCharges, p_totalCourierCharges), chargeRate, null)}
        ${card('', 'Avg Order Value', ru(avgOrderValue), deltaBadge(avgOrderValue, p_avgOrderValue), aovBaselineRate, null)}
    `;

            } catch (e) {
                console.error("renderMetricsUI Error:", e);
                const grid = document.getElementById('metricsGrid');
                if (grid) grid.innerHTML = '<div class="empty-state">Error loading metrics</div>';
            }
        }

        /* Interactive Filter Logic */
        function applyPaymentFilter(status) {
            // If mobile, ensure we are in "Insights" mode to see the table
            if (isMobile()) setMobileSection('insights');

            const container = document.getElementById('filters');
            if (!container) return;
            let btn;
            if (status === 'All') {
                btn = container.querySelector('.seg-btn:not([data-payment])') || container.querySelector('.seg-btn[data-payment="All"]');
            } else {
                btn = container.querySelector(`.seg-btn[data-payment="${status}"]`);
            }
            if (btn) {
                btn.click();

                // Use a small timeout to ensure DOM updates and scroll to the table section
                setTimeout(() => {
                    const target = document.getElementById('ordersWrap');
                    if (target) {
                        const offset = 80; // Buffer for sticky header
                        const top = target.getBoundingClientRect().top + window.pageYOffset - offset;
                        window.scrollTo({ top, behavior: 'smooth' });
                    }
                }, 100);
            }
        }

        /* =========================
           EDIT / DELETE (table)
           ========================= */
        function updateRowInTableDOM(sheetRow, data) {
            const tr = document.querySelector(`tr[data-sheetrow="${sheetRow}"]`);
            if (!tr) return;

            // Animation
            tr.classList.remove('flash-success');
            void tr.offsetWidth; // trigger reflow
            tr.classList.add('flash-success');

            // Update inputs (if they exist in DOM)
            if (data.trackingNumber !== undefined) { const el = tr.querySelector('input[data-field="trackingNumber"]'); if (el) el.value = data.trackingNumber; }
            if (data.courierCharge !== undefined) { const el = tr.querySelector('input[data-field="courierCharge"]'); if (el) el.value = data.courierCharge; }
            if (data.dispatchDate !== undefined) { const el = tr.querySelector('input[data-field="dispatchDate"]'); if (el) el.value = data.dispatchDate; }

            // Update Payment Badge & Select
            if (data.payment !== undefined) {
                const sel = tr.querySelector('.payment-select');
                const tag = tr.querySelector('.status-tag');
                if (sel) sel.value = data.payment;
                if (tag) {
                    tag.innerHTML = `<svg class="ico16"><use href="#i-${data.payment === 'Paid' ? 'check-circle' : 'x-circle'}"/></svg> ${data.payment}`;
                    tag.className = "status-tag " + (data.payment === 'Paid' ? 'paid' : 'unpaid') + " payment-tag";
                }
            }

            // Update Courier/Tracking Link
            if (data.courieredVia !== undefined) {
                const sel = tr.querySelector('.inline-select:not(.payment-select)'); // likely the first one
                if (sel) sel.value = data.courieredVia;

                const url = trackingMap[data.courieredVia] || '';
                const link = tr.querySelector('a.track-link');
                const hid = tr.querySelector('input[data-field="trackingURL"]');
                if (hid) hid.value = url;
                if (link) { link.href = url || '#'; link.textContent = url ? 'Open' : 'Link'; }
            }
        }

        function updateField(tr, field, value) {
            let changes = JSON.parse(tr.dataset.pendingChanges || '{}');
            changes[field] = value; tr.dataset.pendingChanges = JSON.stringify(changes);
            tr.classList.add('has-pending-changes');
        }
        function onCourierChange(dd) {
            const tr = dd.closest('tr');
            if (!tr) return;

            const courier = dd.value;
            const url = trackingMap[courier] || '';
            updateField(tr, 'courieredVia', courier);
            const link = tr.querySelector('a.track-link');
            const hid = tr.querySelector('input[data-field="trackingURL"]');
            if (hid) hid.value = url;
            if (link) { link.href = url || '#'; link.textContent = url ? 'Open' : 'Link'; }

            // Queue change â€” do NOT auto-save individually.
            // User must click Save so dispatch group validation runs.
            if (!tr.classList.contains('editing')) {
                // Auto-enter edit mode so user is forced to use Save button
                const editBtn = tr.querySelector('.edit-btn');
                if (editBtn) editBtn.click();
            }
        }
        function collectAllEditableValues(tr) {
            const map = {};
            const nodes = tr.querySelectorAll('[data-field]');
            nodes.forEach(node => {
                const key = node.dataset.field;
                map[key] = node.value;
            });
            return map;
        }

        /* JSONP edit (User Provided Working Version) */
        function doJsonpEdit(sheetRow, changes, onDone = () => { }) {
            if (window.hasPendingAsync) {
                showToast('Please wait for current action', 'exclamation');
                return;
            }
            window.hasPendingAsync = true;

            // Fix Off-By-One: Backend likely uses 0-based index or expects offset
            const rowIndexForBackend = Number(sheetRow);

            const cbName = 'cbEdit' + Date.now() + Math.random().toString(36).slice(2);
            const script = document.createElement('script');

            window[cbName] = res => {
                try { delete window[cbName]; } catch { }
                script.remove();
                window.hasPendingAsync = false; // RELEASE LOCK
                try { onDone(res); } catch { }
            };

            // Safety timeout in case script fails to load
            setTimeout(() => {
                if (window[cbName]) {
                    console.warn('JSONP timeout');
                    window.hasPendingAsync = false; // RELEASE LOCK
                    try { delete window[cbName]; } catch { }
                    script.remove();
                }
            }, 10000);

            const params = new URLSearchParams({ action: 'edit', rowIndex: String(rowIndexForBackend), callback: cbName });
            for (const k in changes) { params.append(k, changes[k]); }
            script.src = `${SCRIPT_URL}?${params.toString()}`;

            script.onerror = () => {
                window.hasPendingAsync = false; // RELEASE LOCK
                showToast('Network error during edit', 'exclamation');
            };

            document.body.appendChild(script);
        }
        function removeRowFromUI(sheetRow) {
            const tr = document.querySelector(`tr[data-sheetrow="${sheetRow}"]`);
            const card = document.querySelector(`.mcard[data-sheetrow="${sheetRow}"]`);
            if (tr) {
                tr.style.transform = 'scale(0.95)'; tr.style.opacity = '0';
                setTimeout(() => tr.remove(), 200);
            }
            if (card) {
                card.style.transform = 'scale(0.95)'; card.style.opacity = '0';
                setTimeout(() => card.remove(), 200);
            }
        }

        /* REPRINT LABEL LOGIC */
        function reprintLabel(sheetRow) {
            const tr = document.querySelector(`tr[data-sheetrow="${sheetRow}"]`);
            if (!tr) return;

            // Trigger Animation
            const btn = document.querySelector(`button[onclick="reprintLabel('${sheetRow}')"]`);
            if (btn) {
                // Save original content
                if (!btn.dataset.original) btn.dataset.original = btn.innerHTML;

                // Inline animated SVG
                btn.innerHTML = `<svg class="ico printing" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <polyline points="6 9 6 2 18 2 18 9" class="paper-feed" />
  <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
  <rect x="6" y="14" width="12" height="8" />
</svg>`;

                setTimeout(() => {
                    btn.innerHTML = btn.dataset.original; // Restore after 2s
                }, 2000);
            }

            const name = tr.querySelector('.name-stack strong')?.textContent || '';
            // .address-content has <br> for newlines. We use innerHTML to preserve them.
            const addr = tr.querySelector('.address-content')?.innerHTML.replace(/<br>/g, '\n') || '';

            const p1 = tr.dataset.p1 || '';
            const p2 = tr.dataset.p2 || '';
            const acct = tr.dataset.account || '';

            const phones = [p1, p2, acct].filter(Boolean).filter((v, i, a) => a.indexOf(v) === i); // unique

            // Update Preview Elements
            const ln = document.getElementById('labelName');
            const la = document.getElementById('labelAddress');
            const lp = document.getElementById('labelPhoneCombined');

            if (ln) ln.innerHTML = `<strong>${name}</strong>`;
            if (la) la.innerHTML = addr;
            if (lp) lp.innerHTML = `<strong>Phone : ${phones.join(' | ')}</strong>`;

            // Trigger Print
            setTimeout(() => window.print(), 100); // Slight delay to ensure UI updates
        }
        function shiftRowsAfterDelete(deletedRowIndex) {
            // Optimistically shift row indices to allow consecutive deletes without refresh
            const rows = document.querySelectorAll('tr[data-sheetrow]');
            const cards = document.querySelectorAll('.mcard[data-sheetrow]');

            // Helper to shift
            const shift = (el) => {
                const idx = Number(el.dataset.sheetrow);
                if (idx > deletedRowIndex) {
                    el.dataset.sheetrow = idx - 1;
                }
            };

            rows.forEach(shift);
            cards.forEach(shift);
        }

        function doDelete(sheetRow) {
            if (document.getElementById(`deleteToast-${sheetRow}`)) return; // Already pending

            const confirmOverlay = document.getElementById('deleteConfirmOverlay');
            const okBtn = document.getElementById('delConfirmOk');
            const cancelBtn = document.getElementById('delConfirmCancel');
            const closeBtn = document.getElementById('delConfirmX');

            // Show Custom Modal
            confirmOverlay.classList.add('open');
            confirmOverlay.setAttribute('aria-hidden', 'false');

            // Inject Name
            const tr = document.querySelector(`tr[data-sheetrow="${sheetRow}"]`);
            // Use .name-cell strong to reliably get the recipient name (first column)
            const name = tr ? (tr.querySelector('.name-cell strong')?.textContent || 'this row') : 'this row';
            const body = document.getElementById('delConfirmBody');
            if (body) body.innerHTML = `Do you want to delete the data of <strong>${name}'s shipment</strong>?`;

            const close = () => {
                confirmOverlay.classList.remove('open');
                confirmOverlay.setAttribute('aria-hidden', 'true');
            };

            // Cleanup old listeners to prevent stacking
            const newOk = okBtn.cloneNode(true); okBtn.parentNode.replaceChild(newOk, okBtn);
            const newCancel = cancelBtn.cloneNode(true); cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);
            const newClose = closeBtn.cloneNode(true); closeBtn.parentNode.replaceChild(newClose, closeBtn);

            newCancel.onclick = close;
            newClose.onclick = close;

            newOk.onclick = () => {
                close();
                if (window.hasPendingAsync) {
                    showToast('Please wait for current action to finish', 'exclamation');
                    return;
                }
                if (mobileDetail && mobileDetail.open) {
                    _reallyCloseSheet();
                }
                startDeleteFlow(sheetRow);
            };
        }

        /* =========================
           VOICE NOTIFICATIONS
           ========================= */
        let voiceEnabled = localStorage.getItem('voice_enabled') === 'true';
        let voiceLang = localStorage.getItem('voice_lang') || 'en-IN';
        let viewDetailed = localStorage.getItem('view_detailed') === 'true';
        let lastAnnouncedTxn = localStorage.getItem('last_announced_txn') || '';
        let voiceInterval = null;

        function initVoiceNotifications() {
            const toggle = document.getElementById('voiceToggle');
            if (toggle) {
                toggle.checked = voiceEnabled;
                toggle.addEventListener('change', (e) => {
                    voiceEnabled = e.target.checked;
                    localStorage.setItem('voice_enabled', voiceEnabled);
                    if (voiceEnabled) {
                        showToast('Voice Notifications Enabled', 'volume-2');
                        startVoicePolling();
                        speakVoiceNotificationEnabled();
                    } else {
                        stopVoicePolling();
                        showToast('Voice Notifications Disabled', 'volume-x');
                    }
                });
            }

            const langSelect = document.getElementById('voiceLangSelect');
            if (langSelect) {
                langSelect.value = voiceLang;
                langSelect.addEventListener('change', (e) => {
                    voiceLang = e.target.value;
                    localStorage.setItem('voice_lang', voiceLang);
                    if (voiceEnabled) {
                        speakVoiceNotificationEnabled();
                    }
                });
            }

            if (voiceEnabled) startVoicePolling();

            // Initial View Persistence
            const topViewSwitch = document.getElementById('viewModeSwitch');
            if (topViewSwitch) topViewSwitch.checked = viewDetailed;

            document.body.classList.toggle('view-detailed', viewDetailed);
            applyDetailColsFromSwitch();

            initSettingsInModal();
        }

        /* =========================
           SETTINGS MODAL
           ========================= */
        function openSettingsModal() {
            const modal = document.getElementById('settingsModalOverlay');
            if (!modal) return;

            // Sync modal controls with current state
            const viewSwitch = document.getElementById('viewModeSwitchModal');
            if (viewSwitch) viewSwitch.checked = document.body.classList.contains('view-detailed');

            const voiceSwitch = document.getElementById('voiceToggleModal');
            if (voiceSwitch) voiceSwitch.checked = voiceEnabled;

            const langSelect = document.getElementById('voiceLangSelectModal');
            if (langSelect) langSelect.value = voiceLang;

            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeSettingsModal(e) {
            if (e && e.target !== document.getElementById('settingsModalOverlay') && !e.target.closest('.modal-close')) return;
            document.getElementById('settingsModalOverlay').style.display = 'none';
            document.body.style.overflow = '';
        }

        function initSettingsInModal() {
            // Priority: Top Controls Switch
            const topViewSwitch = document.getElementById('viewModeSwitch');
            const viewSwitchModal = document.getElementById('viewModeSwitchModal');

            const handleViewToggle = (e) => {
                const on = e.target.checked;
                document.body.classList.toggle('view-detailed', on);
                localStorage.setItem('view_detailed', on);
                // Keep modal switch in sync if it exists
                if (viewSwitchModal) viewSwitchModal.checked = on;
                if (topViewSwitch) topViewSwitch.checked = on;
                applyDetailColsFromSwitch();
            };

            if (topViewSwitch) topViewSwitch.addEventListener('change', handleViewToggle);
            if (viewSwitchModal) viewSwitchModal.addEventListener('change', handleViewToggle);

            const voiceSwitch = document.getElementById('voiceToggleModal');
            if (voiceSwitch) {
                voiceSwitch.addEventListener('change', (e) => {
                    voiceEnabled = e.target.checked;
                    localStorage.setItem('voice_enabled', voiceEnabled);
                    if (voiceEnabled) {
                        showToast('Voice Notifications Enabled', 'volume-2');
                        startVoicePolling();
                        speakVoiceNotificationEnabled();
                    } else {
                        stopVoicePolling();
                        showToast('Voice Notifications Disabled', 'volume-x');
                    }
                });
            }

            const langSelect = document.getElementById('voiceLangSelectModal');
            if (langSelect) {
                langSelect.addEventListener('change', (e) => {
                    voiceLang = e.target.value;
                    localStorage.setItem('voice_lang', voiceLang);
                    if (voiceEnabled) {
                        speakVoiceNotificationEnabled();
                    }
                });
            }

            // Test Button
            const testBtn = document.createElement('button');
            testBtn.className = 'btn';
            testBtn.style.cssText = 'width:100%; margin-top:12px; height:34px; font-size:12px; font-weight:700; gap:8px;';
            testBtn.innerHTML = '<svg class="ico"><use href="#i-volume-2"/></svg> Test Sound';
            testBtn.onclick = testVoice;
            document.querySelector('.settings-modal .modal-body').appendChild(testBtn);
        }

        function testVoice() {
            const name = "Test User";
            const amt = "100";
            let text = (voiceLang === 'ta-IN')
                ? `à®µà¯†à®±à¯à®±à®¿! à®•à®Ÿà¯à®Ÿà®£à®®à¯ à®šà¯†à®²à¯à®¤à¯à®¤à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯. à®°à¯‚à®ªà®¾à®¯à¯ ${amt}, ${name} à®‡à®Ÿà®®à®¿à®°à¯à®¨à¯à®¤à¯ à®ªà¯†à®±à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯`
                : `Success! Received ${amt} Rupees from ${name}`;
            speak(text);
            showToast('Playing Test Sound...', 'volume-2');
        }

        function speakVoiceNotificationEnabled() {
            const text = voiceLang === 'ta-IN' ? "à®’à®²à®¿ à®…à®±à®¿à®µà®¿à®ªà¯à®ªà¯ à®šà¯†à®¯à®²à¯à®ªà®Ÿà¯à®¤à¯à®¤à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯" : "Voice notification enabled";
            speak(text);
        }

        function startVoicePolling() {
            if (voiceInterval) clearInterval(voiceInterval);
            // Polling every 3 seconds for faster real-time updates
            voiceInterval = setInterval(checkNewSuccessfulPayments, 3000);
            // Initial check
            checkNewSuccessfulPayments();
        }

        function stopVoicePolling() {
            if (voiceInterval) clearInterval(voiceInterval);
            voiceInterval = null;
        }

        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();

            let triggerSpeak = () => {
                const msg = new SpeechSynthesisUtterance(text);
                msg.rate = 0.9;
                msg.pitch = 1.0;
                msg.lang = voiceLang;

                const voices = window.speechSynthesis.getVoices();
                let selectedVoice = null;

                if (voiceLang === 'ta-IN') {
                    selectedVoice = voices.find(v => v.lang.startsWith('ta') && v.name.includes('Google')) ||
                        voices.find(v => v.lang.startsWith('ta'));
                } else {
                    selectedVoice = voices.find(v => v.lang === 'en-IN' && v.name.includes('Google')) ||
                        voices.find(v => v.lang === 'en-IN') ||
                        voices.find(v => v.name.includes('Google')) ||
                        voices.find(v => v.lang.startsWith('en'));
                }

                if (selectedVoice) msg.voice = selectedVoice;
                window.speechSynthesis.speak(msg);
            };

            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                window.speechSynthesis.onvoiceschanged = () => {
                    window.speechSynthesis.onvoiceschanged = null;
                    triggerSpeak();
                };
            } else {
                setTimeout(triggerSpeak, 50);
            }
        }

        function checkNewSuccessfulPayments() {
            if (!voiceEnabled) return;
            fetch(`${SCRIPT_URL}?action=getLatestPayments&_t=${Date.now()}`)
                .then(r => r.json())
                .then(payments => {
                    if (!Array.isArray(payments) || payments.length === 0) return;
                    const latest = payments[0];
                    if (latest && latest.txnid !== lastAnnouncedTxn) {
                        lastAnnouncedTxn = latest.txnid;
                        localStorage.setItem('last_announced_txn', lastAnnouncedTxn);
                        const amt = latest.amount || '0';
                        const name = latest.name || 'Customer';

                        let announcement = (voiceLang === 'ta-IN')
                            ? `à®µà¯†à®±à¯à®±à®¿! à®•à®Ÿà¯à®Ÿà®£à®®à¯ à®šà¯†à®²à¯à®¤à¯à®¤à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯. à®°à¯‚à®ªà®¾à®¯à¯ ${amt}, ${name} à®‡à®Ÿà®®à®¿à®°à¯à®¨à¯à®¤à¯ à®ªà¯†à®±à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯`
                            : `Success! Received ${amt} Rupees from ${name}`;

                        speak(announcement);
                        showToast(`New Payment: â‚¹${amt} from ${name}`, 'check-circle');
                        if (typeof refreshTableAndMetrics === 'function') {
                            refreshTableAndMetrics();
                        }
                    }
                })
                .catch(err => console.log('Voice polling silent error'));
        }

        function startDeleteFlow(sheetRow) {
            // Set guard immediately
            window.hasPendingAsync = true;
            const tr = document.querySelector(`tr[data-sheetrow="${sheetRow}"]`);
            if (tr) tr.classList.add('blinking-red');

            const card = document.querySelector(`.mcard[data-sheetrow="${sheetRow}"]`);
            if (card) card.classList.add('blinking-red');

            // Create Undo Toast Container if needed
            let container = document.getElementById('undoToastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'undoToastContainer';
                container.style.position = 'fixed';
                container.style.bottom = '20px';
                container.style.left = '50%';
                container.style.transform = 'translateX(-50%)';
                container.style.zIndex = '999999';
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.gap = '8px';
                document.body.appendChild(container);
            }

            // Create Toast
            const toastId = `deleteToast-${sheetRow}`;
            const t = document.createElement('div');
            t.id = toastId;
            t.className = 'toast show';
            t.style.display = 'flex';
            t.style.justifyContent = 'space-between';
            t.style.background = '#1e293b'; // Dark
            t.style.color = '#fff';
            t.style.padding = '12px 16px';
            t.style.borderRadius = '8px';
            t.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            t.style.minWidth = '300px';

            t.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          <svg class="ico" style="fill:#fff"><use href="#i-trash"/></svg>
          <span id="txt-${toastId}">Deleting in 5s...</span>
        </div>
        <button id="undoBtn-${sheetRow}" style="background:#fff;color:#000;border:none;padding:5px 12px;border-radius:4px;font-weight:bold;cursor:pointer;font-size:12px;">UNDO</button>
      `;

            container.appendChild(t);

            // Start Timer
            let seconds = 5;
            const interval = setInterval(() => {
                seconds--;
                const span = document.getElementById(`txt-${toastId}`);
                if (span) span.textContent = `Deleting in ${seconds}s...`;
            }, 1000);

            const timer = setTimeout(() => {
                clearInterval(interval);
                finalizeDelete(sheetRow, toastId);
            }, 5000);

            // Bind Undo
            document.getElementById(`undoBtn-${sheetRow}`).onclick = () => {
                clearTimeout(timer);
                clearInterval(interval);
                t.remove();

                if (tr) tr.classList.remove('blinking-red');
                if (card) card.classList.remove('blinking-red');

                showToast('Delete cancelled', 'exclamation');
                if (container.children.length === 0) container.remove();

                // Release guard
                window.hasPendingAsync = false;
            };
        }

        function finalizeDelete(sheetRow, toastId) {
            const t = document.getElementById(toastId);
            if (t) t.remove();

            // Guard is still true from startDeleteFlow, keeps blocking during network request

            const rowIndex = Number(sheetRow);
            // Optimistic Remove
            const tr = document.querySelector(`tr[data-sheetrow="${sheetRow}"]`);
            const card = document.querySelector(`.mcard[data-sheetrow="${sheetRow}"]`);

            const flashAndRemove = (el) => {
                if (!el) return;
                el.classList.remove('blinking-red');
                el.classList.add('flash-delete');
            };

            if (tr || card) {
                flashAndRemove(tr);
                flashAndRemove(card);
                setTimeout(() => {
                    removeRowFromUI(sheetRow);
                    shiftRowsAfterDelete(Number(sheetRow));
                }, 500);
            } else {
                removeRowFromUI(sheetRow);
                shiftRowsAfterDelete(Number(sheetRow));
            }

            if (requestAnimationFrame && document.getElementById('undoToastContainer')?.children.length === 0) {
                document.getElementById('undoToastContainer').remove();
            }

            // Network Delete
            const cbName = 'cbDel' + Date.now() + Math.random().toString(36).slice(2);
            const script = document.createElement('script');

            window[cbName] = (res) => {
                try { delete window[cbName]; } catch { }
                script.remove();
                window.hasPendingAsync = false; // Release lock

                // If callback is called, server processed it. 
                // We relax the check because edits work without checking result.
                if (res && (res.result === 'error' || res.status === 'error')) {
                    console.warn('Delete error:', res);
                    showToast('Delete failed on server', 'exclamation');
                } else {
                    showToast('Deleted successfully', 'trash');
                }
            };

            // Safety timeout
            setTimeout(() => {
                if (window[cbName]) {
                    window.hasPendingAsync = false;
                    try { delete window[cbName]; } catch { }
                    script.remove();
                    showToast('Delete network timeout', 'exclamation');
                }
            }, 20000);

            script.onerror = () => {
                window.hasPendingAsync = false;
                try { delete window[cbName]; } catch { }
                script.remove();
                showToast('Delete network error', 'exclamation');
            };

            const params = new URLSearchParams({ action: 'delete', rowIndex: String(rowIndex), callback: cbName });
            script.src = `${SCRIPT_URL}?${params}`;
            document.body.appendChild(script);
        }

        /* Row actions */
        document.addEventListener('click', e => {
            // Global check for pending actions on critical buttons
            if (window.hasPendingAsync && (
                e.target.closest('.delete-btn') ||
                e.target.closest('.edit-btn') ||
                e.target.closest('.save-btn')
            )) {
                e.stopImmediatePropagation();
                e.preventDefault();
                showToast('Please wait for current action', 'exclamation');
                return;
            }

            const tr = e.target.closest('tr[data-sheetrow]');
            const del = e.target.closest('.delete-btn');
            const edt = e.target.closest('.edit-btn');
            const sav = e.target.closest('.save-btn');
            const copy = e.target.closest('.copy-btn');

            if (!tr) return;

            if (del) { doDelete(tr.dataset.sheetrow); return; }

            if (edt) {
                tr.querySelectorAll('.inline-input, .inline-select').forEach(el => el.disabled = false);
                const sel = tr.querySelector('.payment-select');
                const tag = tr.querySelector('.status-tag');
                const fsWrap = sel?.closest('.fs');
                if (sel && tag) {
                    tag.style.display = 'none';
                    if (fsWrap) { fsWrap.classList.remove('hide-until-edit'); }
                    sel.disabled = false;
                }
                edt.style.display = 'none';
                tr.querySelector('.save-btn').style.display = 'inline-block';
                tr.classList.add('editing');
                enhanceAllSelects();
                return;
            }

            if (sav) {
                const sel = tr.querySelector('.payment-select');
                const tag = tr.querySelector('.status-tag');
                const fsWrap = sel?.closest('.fs');
                if (sel && tag) {
                    const nv = sel.value;
                    tag.innerHTML = `<svg class="ico16"><use href="#i-${nv === 'Paid' ? 'check-circle' : 'x-circle'}"/></svg> ${nv}`;
                    tag.className = "status-tag " + (nv === 'Paid' ? 'paid' : 'unpaid') + " payment-tag";
                    tag.style.display = 'inline-flex';
                    if (fsWrap) { fsWrap.classList.add('hide-until-edit'); }
                    sel.disabled = true;
                }

                const pending = JSON.parse(tr.dataset.pendingChanges || '{}');
                const full = collectAllEditableValues(tr);
                const changes = { ...full, ...pending };

                if (changes.courieredVia) {
                    changes.trackingURL = trackingMap[changes.courieredVia] || '';
                }

                /* â”€â”€ Dispatch Group Validation (table inline save) â”€â”€ */
                const _trk = (changes.trackingNumber || '').trim();
                const _via = (changes.courieredVia || '').trim();
                const _dt = (changes.dispatchDate || '').trim();
                const _anyD = _trk || _via || _dt;
                const _allD = _trk && _via && _dt;
                if (_anyD && !_allD) {
                    if (_trk && !_via) showToast('Please select a courier', 'exclamation');
                    else if (_trk && !_dt) showToast('Please enter dispatch date', 'exclamation');
                    else if (!_trk) showToast('Please enter courier/tracking number', 'exclamation');
                    else showToast('Please complete all dispatch fields', 'exclamation');
                    return;
                }
                /* â”€â”€ End Dispatch Validation â”€â”€ */

                if (Object.keys(changes).length) {
                    const btn = tr.querySelector('.save-btn');
                    btn.disabled = true;

                    // Start blinking green immediately
                    tr.classList.add('blinking-green');

                    doJsonpEdit(tr.dataset.sheetrow, changes, () => {
                        btn.disabled = false;
                        tr.classList.remove('blinking-green');
                        // Silent update + flash
                        updateRowInTableDOM(tr.dataset.sheetrow, changes);
                        showToast('Saved successfully', 'check-circle');
                    });
                }

                tr.querySelectorAll('.inline-input, .inline-select').forEach(el => el.disabled = true);
                sav.style.display = 'none';
                tr.querySelector('.edit-btn').style.display = 'inline-block';
                tr.classList.remove('editing', 'has-pending-changes');
                delete tr.dataset.pendingChanges;

                enhanceAllSelects();
                return;
            }

            if (copy) {
                const td = copy.closest('td');
                const input = td ? td.querySelector('input.inline-input[data-field="trackingNumber"]') : null;
                const val = (input && input.value.trim()) || '';
                if (val) {
                    navigator.clipboard.writeText(val).then(() => {
                        const useEl = copy.querySelector('use');
                        const prev = useEl.getAttribute('href');
                        useEl.setAttribute('href', '#i-clipboard-check');
                        showToast('Tracking copied', 'clipboard-check');
                        setTimeout(() => useEl.setAttribute('href', prev), 900);
                    });
                } else {
                    showToast('Nothing to copy', 'exclamation');
                }
                return;
            }
        });

        // Global click to dismiss WA popups
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.wa-confirm-popup') && !e.target.closest('.sheet-number') && !e.target.closest('.txn-details-overlay') && !e.target.closest('button[onclick*="showTxnDetails"]')) {
                document.querySelectorAll('.wa-confirm-popup, .txn-details-overlay').forEach(el => el.remove());
                document.querySelectorAll('.sheet-number[data-has-popup]').forEach(el => delete el.dataset.hasPopup);
            }
        }, true);

        /* =========================
           MOBILE bottom sheet (inner card)
           ========================= */


        document.getElementById('mCards')?.addEventListener('click', (e) => {
            const card = e.target.closest('.mcard');
            if (!card) return;
            const sheetRow = card.dataset.sheetrow;
            const tr = document.querySelector(`tr[data-sheetrow="${sheetRow}"]`);
            if (!tr) return;
            openDetailSheet(sheetRow, tr);
        });
        function extractRowData(tr) {
            const sheetRow = tr.dataset.sheetrow;
            const name = tr.dataset.name || '';
            const addr = tr.querySelector('.address-content')?.innerHTML.replace(/<br>/g, '\n') || '';
            const p1 = tr.dataset.p1 || '';
            const p2 = tr.dataset.p2 || '';
            const account = tr.dataset.account || '';
            const payment = tr.dataset.payment || 'Unpaid';
            const orderValue = tr.dataset.ordervalue || '0';
            const courieredVia = tr.querySelector('select[data-field="courieredVia"]')?.value || '';
            const trackingNumber = tr.querySelector('input[data-field="trackingNumber"]')?.value || '';
            const trackingURL = tr.querySelector('input[data-field="trackingURL"]')?.value || '';
            const dispatchDate = tr.querySelector('input[data-field="dispatchDate"]')?.value || '';
            const courierCharge = tr.querySelector('input[data-field="courierCharge"]')?.value || '';
            const ts = tr.dataset.ts || '';
            const txnId = tr.dataset.txnid || '';
            return { sheetRow, name, addr, p1, p2, account, payment, orderValue, courieredVia, trackingNumber, trackingURL, dispatchDate, courierCharge, ts, txnId };
        }
        function fillDetailSheet(d) {
            const setText = (id, val) => { const el = document.getElementById(id); if (el) el.innerHTML = val; };
            setText('sheetName', d.name || '');
            setText('sheetAccountText', d.account || '');

            const badge = document.getElementById('sheetPayBadge');
            if (badge) {
                const icon = d.payment === 'Paid' ? 'check-circle' : 'x-circle';
                badge.className = 'badge ' + (d.payment === 'Paid' ? 'paid' : 'unpaid');
                badge.innerHTML = `<svg class="ico"><use href="#i-${icon}"/></svg> ${d.payment}`;
            }

            const amount = document.getElementById('sheetAmount');
            if (amount) amount.innerHTML = '\u20B9' + fmtINR(d.orderValue);

            // Mobile Payment Details Logic
            const txnWrap = document.getElementById('sheetTxnDetailsWrap');
            const viewBtn = document.getElementById('sheetViewDetailsBtn');
            const content = document.getElementById('sheetTxnContent');

            if (txnWrap && viewBtn && content) {
                content.style.display = 'none';
                content.innerHTML = '';
                viewBtn.innerHTML = 'View Details';
                viewBtn.disabled = false;

                if (d.payment === 'Paid' && d.txnId) {
                    txnWrap.style.display = 'flex';
                    viewBtn.onclick = () => {
                        if (content.style.display === 'block') {
                            content.style.display = 'none';
                            viewBtn.innerHTML = 'View Details';
                            return;
                        }

                        viewBtn.innerHTML = `<div class="bounce-dots"><span></span><span></span><span></span></div>`;
                        viewBtn.disabled = true;

                        // Fetch Logic
                        const params = new URLSearchParams({ action: 'txnDetails', txnId: d.txnId });
                        fetch(`${SCRIPT_URL}?${params}`)
                            .then(r => r.json())
                            .then(data => {
                                if (!data.error) {
                                    const txn = data; // Backend returns object directly
                                    const appUsed = txn['APP used'] || txn['app used'] || '-';
                                    let appLogo = txn['App Logo'] || txn['app logo'] || '';
                                    if (!appLogo && appUsed && typeof globalUPILogoMap !== 'undefined') {
                                        appLogo = globalUPILogoMap[appUsed] || '';
                                    }

                                    const rows = [
                                        { l: 'Txn ID', val: txn['Txn ID'] || txn.txnid || '-', icon: 'hashtag', mono: true },
                                        { l: 'Amount', val: txn['Amount'] || txn.amount || '-', icon: 'rupee-circle' },
                                        { l: 'Date', val: txn['Payment Time'] || txn.time || '-', icon: 'calendar' },
                                        { l: 'Mode', val: txn['Payment mode'] || txn.mode || '-', icon: 'credit-card' },
                                        { l: 'App Used', val: appUsed, icon: 'smartphone', logo: appLogo },
                                        { l: 'UPI ID', val: txn['UPI ID (VPA)'] || txn.upi_id || '-', icon: 'upi', wrap: true },
                                        { l: 'Bank Ref', val: txn['Bank Ref No.'] || txn.bank_ref_num || '-', icon: 'bank' }
                                    ];

                                    content.innerHTML = `
                                        <div style="display:flex; flex-direction:column; gap:8px; padding:4px 0;">
                                            ${rows.map(r => `
                                                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; font-size:12px;">
                                                    <span style="color:var(--label-fg); font-weight:600; display:flex; align-items:center; gap:5px; white-space:nowrap;">
                                                        <svg class="ico16" style="opacity:0.6;"><use href="#i-${r.icon}"/></svg>
                                                        ${r.l}
                                                    </span>
                                                    <div style="text-align:right; display:flex; align-items:center; gap:6px; flex:1; justify-content:flex-end;">
                                                        ${r.logo ? `<img src="${r.logo}" style="height:16px; object-fit:contain; border-radius:2px;">` : ''}
                                                        <span style="color:var(--ink); font-weight:700; ${r.mono ? 'font-family:monospace; user-select:all;' : ''} ${r.wrap ? 'word-break:break-all;' : ''}">${r.val}</span>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                    content.style.display = 'block';
                                    viewBtn.innerHTML = 'Hide Details';
                                } else {
                                    showToast(data.error || 'Details not found', 'exclamation');
                                    viewBtn.innerHTML = 'View Details';
                                }
                            })
                            .catch(() => {
                                showToast('Failed to load details', 'exclamation');
                                viewBtn.innerHTML = 'View Details';
                            })
                            .finally(() => {
                                viewBtn.disabled = false;
                            });
                    };
                } else {
                    txnWrap.style.display = 'none';
                }
            }

            const dtText = fmtDateTime(d.ts) || 'â€”';
            setText('sheetDateTime', dtText);

            const address = document.getElementById('sheetAddress');
            if (address) { address.value = d.addr || ''; address.readOnly = true; }

            const av = pickAvatar(d.name || '');
            const avEl = document.getElementById('sheetAvatar');
            if (avEl) { avEl.textContent = av.text; avEl.style.background = av.bg; avEl.style.color = av.fg; }

            setText('sheetP1', d.p1 || '');
            const p2wrap = document.getElementById('sheetP2Wrap');
            if (p2wrap) {
                if (d.p2) { p2wrap.style.display = 'flex'; setText('sheetP2', d.p2); }
                else { p2wrap.style.display = 'none'; }
            }

            const via = document.getElementById('sheetCourieredVia');
            if (via) {
                via.innerHTML = `<option value=""${s(d.courieredVia) ? '' : ' selected'}>Select Courier\u2026</option>` +
                    courierOptions.map(o => {
                        const val = typeof o === 'object' ? o.name : o;
                        const ico = typeof o === 'object' ? (o.icon || 'package') : 'package';
                        return `<option value="${s(val)}"${s(val) === s(d.courieredVia) ? ' selected' : ''} data-icon="${ico}">${s(val)}</option>`;
                    }).join('');
                via.dispatchEvent(new Event('change')); // Update fancy select
            }

            const tn = document.getElementById('sheetTrackingNumber'); if (tn) tn.value = d.trackingNumber || '';
            const dd = document.getElementById('sheetDispatchDate'); if (dd) dd.value = d.dispatchDate || '';
            const cc = document.getElementById('sheetCourierCharge'); if (cc) cc.value = d.courierCharge || '';
            const sp = document.getElementById('sheetPayment'); if (sp) { sp.value = d.payment || 'Unpaid'; sp.dispatchEvent(new Event('change')); }

            const url = trackingMap[d.courieredVia] || d.trackingURL || '';
            const link = document.getElementById('sheetTrackingLink');
            const urlInput = document.getElementById('sheetTrackingURL');

            if (url) {
                if (link) {
                    // CLEANUP: Remove any rogue siblings that might have been added
                    const parent = link.parentNode;
                    if (parent) {
                        // Keep only the input and the link
                        Array.from(parent.children).forEach(child => {
                            if (child !== link && child !== urlInput) {
                                child.remove();
                            }
                        });
                    }
                    link.href = url;
                    link.style.display = 'flex';
                }
                if (urlInput) { urlInput.value = url; }
            } else {
                if (link) { link.style.display = 'none'; link.href = '#'; }
                if (urlInput) { urlInput.value = ''; }
            }

            const makeMsg = () => [
                `Dear ${d.name || ''},`,
                ``,
                `Your order for *Rs.${fmtINR(d.orderValue || 0)}* was generated successfully.`,
                `To make payment and to get the tracking details click on the link below:`,
                ``,
                `*https://www.makkalmarundhagam.in/p/shipment.html?phone=${d.account || ''}*`,
                ``,
                `_Note: Courier details will be updated by next day morning._`
            ].join('\n');
            const waUrl = `https://wa.me/91${d.account || ''}?text=${encodeURIComponent(makeMsg())}`;

            function toggleWaPopup(box, phone) {
                // close others
                document.querySelectorAll('.wa-confirm-popup').forEach(el => el.remove());
                if (box.dataset.hasPopup === '1') {
                    delete box.dataset.hasPopup;
                    return;
                }

                const pop = document.createElement('div');
                pop.className = 'wa-confirm-popup';
                pop.textContent = 'Open WhatsApp profile';
                pop.onclick = (e) => {
                    e.stopPropagation();
                    window.open(`https://wa.me/91${phone.replace(/\D/g, '')}`, '_blank');
                    pop.remove();
                    delete box.dataset.hasPopup;
                };
                box.appendChild(pop);
                box.dataset.hasPopup = '1';

                // simple dismiss handler logic is global
            }

            const p1Box = document.getElementById('sheetP1Box');
            if (p1Box) {
                if (d.p1) {
                    p1Box.onclick = (e) => { e.stopPropagation(); toggleWaPopup(p1Box, d.p1); };
                    p1Box.classList.add('interactive');
                } else {
                    p1Box.onclick = null;
                    p1Box.classList.remove('interactive');
                }
            }

            const p1Call = document.getElementById('sheetP1Call');
            const p1Wa = document.getElementById('sheetP1Wa');
            if (p1Call) p1Call.onclick = () => { if (d.p1) window.location.href = `tel:${d.p1}`; };
            if (p1Wa) p1Wa.onclick = () => window.open(waUrl, '_blank');

            const p2Box = document.getElementById('sheetP2Box');
            if (p2Box) {
                if (d.p2) {
                    p2Box.onclick = (e) => { e.stopPropagation(); toggleWaPopup(p2Box, d.p2); };
                    p2Box.classList.add('interactive');
                } else {
                    p2Box.onclick = null;
                    p2Box.classList.remove('interactive');
                }
            }

            const p2Call = document.getElementById('sheetP2Call');
            const p2Wa = document.getElementById('sheetP2Wa');
            if (d.p2) {
                if (p2Call) p2Call.onclick = () => window.location.href = `tel:${d.p2}`;
                if (p2Wa) p2Wa.onclick = () => window.open(waUrl, '_blank');
            } else {
                if (p2Call) p2Call.onclick = null;
                if (p2Wa) p2Wa.onclick = null;
            }

            const copyBtn = document.getElementById('sheetCopyBtn');
            if (copyBtn) {
                copyBtn.onclick = () => {
                    const val = (document.getElementById('sheetTrackingNumber').value || '').trim();
                    if (!val) { showToast('Nothing to copy', 'exclamation'); return; }
                    navigator.clipboard.writeText(val).then(() => {
                        const use = copyBtn.querySelector('use'); const prev = use.getAttribute('href');
                        use.setAttribute('href', '#i-clipboard-check'); showToast('Tracking copied', 'clipboard-check');
                        setTimeout(() => use.setAttribute('href', prev), 900);
                    });
                };
            }

            enhanceAllSelects();
        }
        function openDetailSheet(sheetRow, tr) {
            mobileDetail = { open: true, rowId: sheetRow, edit: false, data: extractRowData(tr) };
            fillDetailSheet(mobileDetail.data);
            toggleEditMode(false);
            const ov = document.getElementById('detailSheetOverlay');
            if (ov) { ov.classList.add('open'); ov.setAttribute('aria-hidden', 'false'); }
            document.body.style.overflow = 'hidden';
            ensureBackGuard();
        }
        function closeDetailSheet() {
            if (mobileDetail.edit) {
                // show confirm modal if there are unsaved changes
                const c = document.getElementById('confirmOverlay');
                if (c) {
                    c.classList.add('open');
                    c.setAttribute('aria-hidden', 'false');
                    return;
                }
            }
            _reallyCloseSheet();
        }
        function _reallyCloseSheet() {
            mobileDetail = { open: false, rowId: null, edit: false, data: null };
            const ov = document.getElementById('detailSheetOverlay');
            if (ov) { ov.classList.remove('open'); ov.setAttribute('aria-hidden', 'true'); }
            document.body.style.overflow = '';
            deactivateBackGuard();
        }
        function toggleEditMode(on) {
            mobileDetail.edit = on;
            const editableIds = ['sheetCourieredVia', 'sheetTrackingNumber', 'sheetDispatchDate', 'sheetCourierCharge', 'sheetPayment'];
            editableIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.disabled = !on;
                    // Also toggle readonly for inputs to ensure keyboards trigger
                    if (on) el.removeAttribute('readonly');
                    else el.setAttribute('readonly', 'true');
                }
            });

            // Handle Tracking URL Input Visibility
            const trkInput = document.getElementById('sheetTrackingURL');
            const trkLink = document.getElementById('sheetTrackingLink');
            if (trkInput) {
                // Tracking URL is auto-generated, never user-editable
                trkInput.disabled = true;
                const hasURL = trkInput.value.trim().length > 0;
                if (hasURL && trkLink && trkLink.style.display !== 'none') {
                    // URL exists and Open button is visible â†’ hide input
                    trkInput.style.display = 'none';
                } else {
                    // No URL â†’ show the placeholder input
                    trkInput.style.display = 'block';
                }
            }

            const scanBtn = document.getElementById('sheetScanBtn');
            const copyBtn = document.getElementById('sheetCopyBtn');

            if (on) {
                if (canUseCamera()) { if (scanBtn) scanBtn.style.display = 'inline-flex'; } else { if (scanBtn) scanBtn.style.display = 'none'; }
                if (copyBtn) copyBtn.style.display = canUseCamera() ? 'none' : 'inline-flex';
            } else {
                if (copyBtn) copyBtn.style.display = 'inline-flex';
                if (scanBtn) scanBtn.style.display = 'none';
            }

            const btn = document.getElementById('sheetEditBtn');
            if (btn) {
                // MODERN ICONS
                btn.querySelector('.btn-text').textContent = on ? 'Save' : 'Edit';
                const use = btn.querySelector('use');
                if (use) use.setAttribute('href', on ? '#i-check' : '#i-pencil');
            }
            enhanceAllSelects();
        }

        /* Edit/Save button inside sheet */
        /* Edit/Save button inside sheet (Delegated) */
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('#sheetEditBtn');
            if (!btn) return;
            try {
                if (!mobileDetail.open) return;
                if (!mobileDetail.edit) { toggleEditMode(true); return; }

                const btn = document.getElementById('sheetEditBtn');
                setBtnLoading(btn, true);

                // Safe helpers
                const safeVal = (id) => {
                    const el = document.getElementById(id);
                    return el ? String(el.value || '').trim() : '';
                };

                const courieredVia = safeVal('sheetCourieredVia');
                const trackingNumber = safeVal('sheetTrackingNumber');
                const dispatchDate = safeVal('sheetDispatchDate');
                const courierCharge = safeVal('sheetCourierCharge');
                const payment = safeVal('sheetPayment');

                /* â”€â”€ Dispatch Group Validation (atomic save) â”€â”€ */
                const hasTrack = trackingNumber.length > 0;
                const hasCourier = courieredVia.length > 0;
                const hasDate = dispatchDate.length > 0;
                const anyFilled = hasTrack || hasCourier || hasDate;
                const allFilled = hasTrack && hasCourier && hasDate;

                if (anyFilled && !allFilled) {
                    setBtnLoading(btn, false);
                    if (hasTrack && !hasCourier) {
                        showToast('Please select a courier', 'exclamation');
                    } else if (hasTrack && !hasDate) {
                        showToast('Please enter dispatch date', 'exclamation');
                    } else if (!hasTrack && (hasCourier || hasDate)) {
                        showToast('Please enter courier/tracking number', 'exclamation');
                    } else {
                        showToast('Please complete all dispatch fields', 'exclamation');
                    }
                    return;
                }
                /* â”€â”€ End Dispatch Validation â”€â”€ */

                const tMap = window.trackingMap || {};
                const trackingURL = tMap[courieredVia] || ''; // Auto-link

                const changes = { courieredVia, trackingNumber, dispatchDate, courierCharge, payment, trackingURL };

                doJsonpEdit(mobileDetail.data.sheetRow, changes, () => {
                    setBtnLoading(btn, false);
                    toggleEditMode(false);
                    _reallyCloseSheet();
                    updateRowInTableDOM(mobileDetail.data.sheetRow, changes);
                    showToast('Saved successfully', 'check-circle');
                });
            } catch (err) {
                showToast('Save failed: ' + err.message, 'exclamation');
                setBtnLoading(document.getElementById('sheetEditBtn'), false);
            }
        });

        /* â”€â”€ Auto-clear dispatch group when courier number is emptied â”€â”€ */
        document.getElementById('sheetTrackingNumber')?.addEventListener('input', (e) => {
            if (!mobileDetail.edit) return;
            if (e.target.value.trim() === '') {
                const via = document.getElementById('sheetCourieredVia');
                const dt = document.getElementById('sheetDispatchDate');
                if (via) { via.value = ''; enhanceAllSelects(); }
                if (dt) dt.value = '';
            }
        });

        document.getElementById('sheetDeleteBtn')?.addEventListener('click', () => {
            if (!mobileDetail.open) return;
            doDelete(mobileDetail.rowId);
        });

        document.getElementById('sheetClose')?.addEventListener('click', closeDetailSheet);

        /* Confirm modal */
        document.getElementById('confirmX')?.addEventListener('click', () => { document.getElementById('confirmOverlay').classList.remove('open'); });
        document.getElementById('confirmCancel')?.addEventListener('click', () => { document.getElementById('confirmOverlay').classList.remove('open'); });
        document.getElementById('confirmDiscard')?.addEventListener('click', () => {
            document.getElementById('confirmOverlay').classList.remove('open');
            toggleEditMode(false);
            _reallyCloseSheet();
        });
        document.getElementById('confirmSave')?.addEventListener('click', () => {
            document.getElementById('confirmOverlay').classList.remove('open');
            document.getElementById('sheetEditBtn')?.click(); // Triggers delegated listener
        });

        /* Inform via WhatsApp from table */
        function informFromTable(event, sheetRow, targetType = 'account') {
            event?.preventDefault?.();
            const tr = document.querySelector(`tr[data-sheetrow="${sheetRow}"]`); if (!tr) return;
            const recipientName = tr.dataset.name || '';
            const ovText = tr.dataset.ordervalue || '0';
            const formatted = fmtINR(ovText);

            let phone = '';
            if (targetType === 'p1') phone = tr.dataset.p1;
            else if (targetType === 'p2') phone = tr.dataset.p2;
            else phone = tr.dataset.account;

            if (!phone) {
                showToast('Phone number missing', 'exclamation');
                return;
            }

            // Clean phone number (remove spaces/dashes)
            phone = phone.replace(/\D/g, '');

            const msg = [
                `Dear ${recipientName},`,
                ``,
                `Your order for *Rs.${formatted}* was generated successfully.`,
                `To make payment and to get the tracking details click on the link below:`,
                ``,
                `*https://www.makkalmarundhagam.in/p/shipment.html?phone=${tr.dataset.account || ''}*`,
                ``,
                `_Note: Courier details will be updated by next day morning._`
            ].join('\n');

            const waUrl = `https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`;
            window.open(waUrl, '_blank');
        }
        window.informFromTable = informFromTable;

        function showTxnDetails(event, txnIdInput) {
            event.preventDefault();
            event.stopPropagation();

            if (typeof SCRIPT_URL === 'undefined') {
                alert('Configuration Error: SCRIPT_URL is not defined in index.html.');
                return;
            }

            const txnId = txnIdInput; // Direct ID passed
            if (!txnId) {
                showToast('Transaction ID missing', 'exclamation');
                return;
            }

            // Close other popups
            document.querySelectorAll('.txn-details-overlay, .wa-confirm-popup').forEach(el => el.remove());

            const pop = document.createElement('div');
            pop.className = 'txn-details-overlay no-print';
            pop.innerHTML = `
                <div class="txn-loading">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="overflow:visible;">
                        <!-- Static background ring opacity 0.1 -->
                        <circle cx="12" cy="12" r="10" stroke-opacity="0.1" />
                        
                        <!-- Rotating Ring -->
                        <circle cx="12" cy="12" r="10" stroke-dasharray="63" stroke-dashoffset="63">
                            <animate attributeName="stroke-dashoffset" values="63;0;63" dur="2s" repeatCount="indefinite" keyTimes="0;0.5;1" />
                            <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="2s" repeatCount="indefinite" />
                        </circle>
                        
                        <!-- Rupee Symbol Drawing (Scaled down by ~25%) -->
                        <path d="M7.5 7h9M7.5 10h9M13.5 10.5a3.5 3.5 0 0 1-3.5 3.5H7.5M10 14l3.5 4.5" stroke-dasharray="35" stroke-dashoffset="35">
                            <animate attributeName="stroke-dashoffset" values="35;0;35" dur="2s" repeatCount="indefinite" keyTimes="0;0.5;1" />
                        </path>
                    </svg>
                    <span style="font-weight:600;color:var(--muted);font-size:13px;margin-top:16px;">Fetching details...</span>
                </div>`;
            document.body.appendChild(pop);

            // Handle Click Outside to Close
            const closeHandler = (e) => {
                if (!pop.contains(e.target) && e.target !== event.target && !event.target.contains(e.target)) {
                    pop.remove();
                    document.removeEventListener('click', closeHandler);
                }
            };
            // Small timeout to avoid immediate trigger
            setTimeout(() => document.addEventListener('click', closeHandler), 100);


            // Positioning logic relative to document body (Anchor to button)
            const btn = event.currentTarget;
            const rect = btn.getBoundingClientRect();
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;

            const updatePosition = () => {
                const popW = 420; // Match CSS
                const popH = pop.offsetHeight || 400; // Estimate or get actual

                // Horizontal: Fixed Right Align (20px from edge of viewport)
                // We ignore 'left' calculation relative to button

                // Vertical Positioning (Smart Flip)
                const spaceBelow = window.innerHeight - rect.bottom;
                const spaceAbove = rect.top;
                let top = rect.bottom + scrollY + 12; // Default: Below
                let origin = 'top right';

                // If not enough space below AND more space above, flip UP
                if (spaceBelow < 420 && spaceAbove > 420) {
                    top = rect.top + scrollY - popH - 12;
                    origin = 'bottom right';
                    // Verify Top Edge
                    if (top < scrollY + 10) top = scrollY + 10;
                }

                pop.style.top = top + 'px';
                pop.style.width = popW + 'px';

                // FORCE RIGHT ALIGNMENT
                pop.style.left = 'auto';
                pop.style.right = '20px';
                pop.style.transformOrigin = origin;
            };

            // Initial position (might be slightly off if height changes after load, but we update again after fetch)
            updatePosition();

            // Fetch from server
            fetch(`${SCRIPT_URL}?action=txnDetails&txnId=${encodeURIComponent(txnId)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        pop.innerHTML = `
                            <div class="txn-header">
                                <strong>Error</strong>
                                <button class="txn-close-btn" onclick="this.closest('.txn-details-overlay').remove()"><svg class="ico"><use href="#i-x"/></svg></button>
                            </div>
                            <div style="padding:20px; color:#ef4444; text-align:center; font-size:13px;">${data.error}</div>`;
                        return;
                    }

                    // Helpers
                    const get = (keys) => {
                        const foundKey = Object.keys(data).find(dk => {
                            const cleaned = dk.toLowerCase().trim();
                            return keys.some(alias => cleaned === alias || cleaned.includes(alias));
                        });
                        return foundKey ? String(data[foundKey] || '') : '';
                    };

                    // Extract Main Fields
                    const payerName = get(['payer name', 'name', 'sender']) || 'Unknown Payer';
                    let amount = get(['amount']);
                    if (amount && !amount.includes('Rs') && !amount.includes('\u20B9')) amount = '\u20B9' + amount;

                    const statusVal = get(['status']);
                    const isSuccess = statusVal.toLowerCase() === 'success';
                    const statusText = isSuccess ? 'SUCCESS' : (statusVal.toUpperCase() || 'FAILED');
                    const statusClass = isSuccess ? 'txn-status-success' : 'txn-status-failure';

                    const paymentTime = get(['payment time', 'time', 'timestamp', 'date']);
                    const txnIdVal = get(['txn id', 'transaction id', 'txnno', 'txid']);

                    let appLogo = get(['app logo', 'logo']); // New Field
                    const appUsed = get(['app used', 'app', 'source app', 'channel']);

                    if (!appLogo && appUsed && typeof globalUPILogoMap !== 'undefined') {
                        appLogo = globalUPILogoMap[appUsed] || '';
                    }

                    // Extract Detail Fields
                    const detailFields = [
                        { l: 'App Used', val: appUsed, icon: 'smartphone' },
                        { l: 'Payment Mode', val: get(['payment mode', 'mode', 'method', 'type']), icon: 'credit-card' },
                        { l: 'UPI ID (VPA)', val: get(['upi id (vpa)', 'upi id', 'vpa', 'upi']), copy: true, icon: 'upi' },
                        { l: 'Bank Ref No.', val: get(['bank ref no.', 'bank ref', 'reference', 'ref no']), icon: 'bank' },
                        { l: 'PayU Platform', val: get(['payu app']), icon: 'globe' }
                    ];

                    // Construct HTML
                    let detailsHtml = detailFields.map(f => {
                        if (!f.val) return '';
                        return `
                        <div class="txn-row">
                            <span class="txn-label" style="display:flex;align-items:center;gap:4px;">
                                ${f.icon ? `<svg class="ico16" style="min-width:16px;opacity:0.6;"><use href="#i-${f.icon}"/></svg>` : ''}
                                ${f.l}
                            </span>
                            <div style="display:flex;align-items:center;">
                                ${f.l === 'App Used' && appLogo ? `<img src="${appLogo}" style="height:20px;object-fit:contain;margin-right:8px;border-radius:2px;">` : ''}
                                <span class="txn-val">${f.val}</span>
                                ${f.copy ? `<button class="txn-copy-btn" title="Copy" onclick="navigator.clipboard.writeText('${f.val.replace(/<[^>]*>/g, '')}');showToast('Copied','clipboard')"><svg class="ico16"><use href="#i-clipboard"/></svg></button>` : ''}
                            </div>
                        </div>`;
                    }).join('');

                    pop.innerHTML = `
                        <div style="position:absolute; top:12px; right:12px; z-index:10;">
                             <button class="txn-close-btn" onclick="this.closest('.txn-details-overlay').remove()"><svg class="ico"><use href="#i-x"/></svg></button>
                        </div>
                        
                        <div class="txn-header-custom">
                            <div class="txn-payer-name">${payerName}</div>
                            
                            <div class="txn-amount-row">
                                <div class="txn-amount-main">${amount}</div>
                                <div class="txn-status-bracket ${statusClass}">${statusText}</div>
                            </div>

                            <div class="txn-meta-row">
                                <span>Payment Time</span>
                                <span class="txn-meta-val"><svg class="ico16"><use href="#i-calendar"/></svg> ${paymentTime}</span>
                            </div>
                            <div class="txn-meta-row">
                                <span>Txn ID</span>
                                <span class="txn-meta-val">
                                    ${txnIdVal}
                                    <button class="txn-copy-btn" title="Copy" onclick="navigator.clipboard.writeText('${txnIdVal}');showToast('Copied','clipboard')"><svg class="ico16"><use href="#i-clipboard"/></svg></button>
                                </span>
                            </div>
                        </div>

                        <hr class="txn-divider">

                        <div class="txn-details-list">
                            ${detailsHtml || '<div style="text-align:center;color:#94a3b8;font-size:12px;">No additional details.</div>'}
                        </div>
                    `;

                    updatePosition();
                })
                .catch(err => {
                    pop.innerHTML = `<div style="padding:15px; color:#ef4444; font-size:13px;">
                        <strong>Failed to load details.</strong><br>
                        ${err.name}: ${err.message}<br>
                        <span style="font-size:10px; opacity:0.8;">Check console for details.</span>
                    </div>`;
                    console.error('TxnDetails Error:', err);
                });
        }
        window.showTxnDetails = showTxnDetails;

        /* Address expand/collapse */
        function toggleAddress(id, btn) {
            const el = document.getElementById(id);
            const expanded = el.classList.toggle('expanded');
            btn.classList.toggle('rot', expanded);
            btn.querySelector('span').textContent = expanded ? 'View Less' : 'View More';
        }
        window.toggleAddress = toggleAddress;

        /* =========================
           SEARCH / FILTERS / RANGE UI
           ========================= */
        function applyDetailColsFromSwitch() {
            const on = document.body.classList.contains('view-detailed');
            document.querySelectorAll('.extra-col').forEach(el => {
                if (on) el.classList.add('show'); else el.classList.remove('show');
            });
        }
        function syncMirrorWidths() {
            const mirror = document.getElementById('theadMirrorInner');
            const tbl = document.querySelector('#courierList table');
            if (!mirror || !tbl) return;

            // Try to get width from first row of tbody, fall back to thead th
            let tds = tbl.querySelector('tbody tr')?.children;
            if (!tds || tds.length === 0) {
                tds = tbl.querySelectorAll('thead th');
            }

            const cells = mirror.children;
            if (!tds || !cells || !cells.length) return;
            const count = Math.min(cells.length, tds.length);
            for (let i = 0; i < count; i++) {
                const w = (tds[i]).getBoundingClientRect().width;
                if (w > 0) {
                    (cells[i]).style.width = `${Math.round(w)}px`;
                } else {
                    // Fallback to CSS variables if table is not measurable
                    (cells[i]).style.width = '';
                }
            }

            // Show mirror header once widths are synced AND we have data rows
            const m = document.getElementById('theadMirror');
            const hasDataRows = !!tbl.querySelector('tbody tr');
            if (m && count > 0 && hasDataRows) {
                m.style.opacity = '1';
                m.style.visibility = 'visible';
            } else {
                hideMirrorHeader();
            }
        }

        const onResize = debounce(() => {
            setupMobileNav();
            syncMirrorWidths();
        }, 150);

        /* =========================
           RANGE PICKER WIRING (orders + metrics)
           ========================= */
        (function wireRangePicker() {
            const overlay = document.getElementById('rangePickerOverlay');
            const rpClose = document.getElementById('rpClose');
            const rpCancel = document.getElementById('rpCancel');
            const rpApply = document.getElementById('rpApply');
            const rpStart = document.getElementById('rpStart');
            const rpEnd = document.getElementById('rpEnd');
            const presets = document.getElementById('rpPresets');

            // Calendar State
            let calDate = new Date(); // View date
            let selStart = null;
            let selEnd = null;
            let viewMode = 'day'; // 'day' | 'year' | 'month'

            function renderCalendar() {
                const container = document.getElementById('jsCalendar');
                if (!container) return;

                const y = calDate.getFullYear();
                const m = calDate.getMonth();
                const todayStr = new Date().toISOString().slice(0, 10);

                let html = '';

                if (viewMode === 'day') {
                    // Month Names
                    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                    const firstDay = new Date(y, m, 1).getDay(); // 0=Sun
                    const daysInMonth = new Date(y, m + 1, 0).getDate();

                    html += `
             <div class="cal-header">
               <div class="cal-nav-btn" data-action="prev"><svg class="ico" viewBox="0 0 24 24" style="stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round"><polyline points="15 18 9 12 15 6"/></svg></div>
               <div class="current-month-label" title="Click to change year">${months[m]} ${y}</div>
               <div class="cal-nav-btn" data-action="next"><svg class="ico" viewBox="0 0 24 24" style="stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round"><polyline points="9 18 15 12 9 6"/></svg></div>
             </div>
             <div class="cal-grid">
               <div class="cal-head-day">S</div>
               <div class="cal-head-day">M</div>
               <div class="cal-head-day">T</div>
               <div class="cal-head-day">W</div>
               <div class="cal-head-day">T</div>
               <div class="cal-head-day">F</div>
               <div class="cal-head-day">S</div>
           `;

                    // Empty cells
                    for (let i = 0; i < firstDay; i++) {
                        html += `<div class="cal-day empty"></div>`;
                    }

                    for (let d = 1; d <= daysInMonth; d++) {
                        const date = new Date(y, m, d);
                        const iso = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                        let classes = 'cal-day';
                        if (iso === todayStr) classes += ' today';

                        if (selStart && selEnd) {
                            if (iso === selStart && iso === selEnd) classes += ' selected range-start range-end';
                            else if (iso === selStart) classes += ' selected range-start';
                            else if (iso === selEnd) classes += ' selected range-end';
                            else if (iso > selStart && iso < selEnd) classes += ' in-range';
                        } else if (selStart && iso === selStart) {
                            classes += ' selected range-start range-end';
                        }

                        html += `<div class="${classes}" data-date="${iso}">${d}</div>`;
                    }
                    html += `</div>`;

                } else if (viewMode === 'year') {
                    // Year Picker
                    const startY = y - 7;
                    const endY = y + 7;
                    html += `
             <div class="cal-header">
               <div class="cal-nav-btn" data-action="prev-year"><svg class="ico" viewBox="0 0 24 24" style="stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round"><polyline points="15 18 9 12 15 6"/></svg></div>
               <div class="current-month-label">${startY} - ${endY}</div>
               <div class="cal-nav-btn" data-action="next-year"><svg class="ico" viewBox="0 0 24 24" style="stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round"><polyline points="9 18 15 12 9 6"/></svg></div>
             </div>
             <div class="cal-year-grid">
           `;
                    for (let i = startY; i <= endY; i++) {
                        html += `<div class="cal-year-cell ${i === y ? 'current' : ''}" data-year="${i}">${i}</div>`;
                    }
                    html += `</div>`;
                }

                container.innerHTML = html;

                // Bind View Switch
                const label = container.querySelector('.current-month-label');
                if (label && viewMode === 'day') {
                    label.onclick = () => { viewMode = 'year'; renderCalendar(); };
                } else if (label && viewMode === 'year') {
                    label.onclick = () => { viewMode = 'day'; renderCalendar(); };
                }

                // Bind Nav
                container.querySelectorAll('.cal-nav-btn').forEach(b => {
                    b.onclick = (e) => {
                        e.stopPropagation();
                        const act = b.dataset.action;
                        if (act === 'prev') calDate.setMonth(calDate.getMonth() - 1);
                        if (act === 'next') calDate.setMonth(calDate.getMonth() + 1);
                        if (act === 'prev-year') calDate.setFullYear(calDate.getFullYear() - 15);
                        if (act === 'next-year') calDate.setFullYear(calDate.getFullYear() + 15);
                        renderCalendar();
                    };
                });

                // Bind Day Click
                container.querySelectorAll('.cal-day:not(.empty)').forEach(d => {
                    d.onclick = (e) => {
                        e.stopPropagation();
                        handleDayClick(d.dataset.date);
                    };
                });

                // Bind Year Click
                container.querySelectorAll('.cal-year-cell').forEach(y => {
                    y.onclick = (e) => {
                        e.stopPropagation();
                        calDate.setFullYear(parseInt(y.dataset.year));
                        viewMode = 'day';
                        renderCalendar();
                    };
                });
            }

            function handleDayClick(iso) {
                if (rangeTarget === 'mobileSheet') {
                    // Single date mode
                    selStart = iso;
                    selEnd = iso;
                } else if (!selStart || (selStart && selEnd)) {
                    // Start new range
                    selStart = iso;
                    selEnd = null;
                } else {
                    // Complete range
                    if (iso < selStart) {
                        selEnd = selStart;
                        selStart = iso;
                    } else {
                        selEnd = iso;
                    }
                }

                // Update inputs
                rpStart.value = selStart || '';
                rpEnd.value = selEnd || '';
                renderCalendar();

                // Clear preset highlight if custom
                // But if it matches a preset, maybe highlight it? (Optional, skipping for now)
                presets.querySelectorAll('.rp2-chip').forEach(c => c.classList.remove('active'));
            }

            function openRP(target) {
                rangeTarget = target || 'orders';
                overlay.classList.add('open');
                overlay.setAttribute('aria-hidden', 'false');

                const chips = presets.querySelectorAll('.rp2-chip');
                chips.forEach(c => c.classList.remove('active'));

                // Single Date Mode Handling
                const rpTitle = overlay.querySelector('.rp-head strong');
                if (target === 'mobileSheet') {
                    if (rpTitle) rpTitle.textContent = 'Select Dispatch Date';
                    presets.style.display = 'none';
                } else {
                    if (rpTitle) rpTitle.textContent = 'Select date range';
                    presets.style.display = 'flex';
                }

                let currentK = '';
                let sVal = '', eVal = '';

                if (rangeTarget === 'orders') {
                    currentK = (uiDateFilter === 'all') ? 'clear' : uiDateFilter;
                    sVal = document.getElementById('startDate').value;
                    eVal = document.getElementById('endDate').value;
                } else if (rangeTarget === 'mobileSheet') {
                    const v = document.getElementById('sheetDispatchDate')?.value || '';
                    sVal = v; eVal = v;
                    currentK = 'custom';
                } else {
                    const s = document.getElementById('metricsStartDate')?.value;
                    const e = document.getElementById('metricsEndDate')?.value;
                    const { start: tS, end: tE } = computeDateRange('today');
                    if (!s && !e) currentK = 'today';
                    else if (s === tS && e === tE) currentK = 'today';
                    else currentK = 'custom';

                    sVal = s; eVal = e;
                }

                if (currentK && currentK !== 'custom') {
                    const active = presets.querySelector(`.rp2-chip[data-k="${currentK}"]`);
                    if (active) active.classList.add('active');
                }

                // Init Calendar State
                selStart = sVal;
                selEnd = eVal;
                rpStart.value = sVal || '';
                rpEnd.value = eVal || '';

                // Reset View to Start Date or Today
                if (sVal) calDate = new Date(sVal);
                else calDate = new Date();

                renderCalendar();
            }

            function closeRP() { overlay.classList.remove('open'); overlay.setAttribute('aria-hidden', 'true'); }

            document.getElementById('dateBtn')?.addEventListener('click', () => openRP('orders'));
            document.getElementById('metricsDateBtn')?.addEventListener('click', () => openRP('metrics'));
            document.getElementById('sheetDispatchDate')?.addEventListener('click', () => openRP('mobileSheet'));

            rpClose?.addEventListener('click', closeRP);
            rpCancel?.addEventListener('click', closeRP);

            presets?.addEventListener('click', (e) => {
                const b = e.target.closest('.rp2-chip'); if (!b) return;
                presets.querySelectorAll('.rp2-chip').forEach(c => c.classList.remove('active'));
                b.classList.add('active');

                const { start, end } = computeDateRange(b.dataset.k, rpStart, rpEnd);
                selStart = start;
                selEnd = end;
                rpStart.value = start || '';
                rpEnd.value = end || '';

                // Update Calendar View
                if (start) calDate = new Date(start);
                renderCalendar();
            });

            rpApply?.addEventListener('click', () => {
                const start = rpStart.value; const end = rpEnd.value || start;
                const activeChip = presets.querySelector('.rp2-chip.active');
                const k = activeChip ? activeChip.dataset.k : 'custom';

                if (rangeTarget === 'orders') {
                    document.getElementById('startDate').value = start || '';
                    document.getElementById('endDate').value = end || '';
                    uiDateFilter = k === 'clear' ? 'all' : k;
                    const dl = document.getElementById('dateLabel'); if (dl) dl.textContent = start || end ? labelFromRange(start, end) : 'All dates';
                    currentOffset = 0; isLastPage = false; fetchPage(false);
                } else if (rangeTarget === 'mobileSheet') {
                    const el = document.getElementById('sheetDispatchDate');
                    if (el) { el.value = start; el.dispatchEvent(new Event('input')); el.dispatchEvent(new Event('change')); }
                } else {
                    document.getElementById('metricsStartDate').value = start || '';
                    document.getElementById('metricsEndDate').value = end || '';
                    const ml = document.getElementById('metricsDateLabel'); if (ml) ml.textContent = start || end ? labelFromRange(start, end) : 'Today';
                    fetchMetrics();
                }
                closeRP();
            });
        })();

        /* =========================
           SCANNER with FLASH toggle
           ========================= */
        (function injectScanCSS() {
            if (document.getElementById('scanPopupCSS')) return;
            const st = document.createElement('style');
            st.id = 'scanPopupCSS';
            st.textContent = `
    #scanViewport{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
      border-radius:12px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #scanViewport video,
    #scanViewport canvas {
      width:100% !important;
      height:100% !important;
      object-fit:contain !important;
      object-position:center !important;
      transform-origin:center !important;
    }
    #scanViewport.force-landscape video{
      transform: rotate(90deg);
      width:auto;
      height:100%;
    }
    #scanViewport .roi{
      position:absolute;
      inset:20% 20%;
      border:2px solid rgba(255,255,255,.85);
      border-radius:12px;
      box-shadow:0 0 0 9999px rgba(0,0,0,.28) inset;
      pointer-events:none;
    }
  `;
            document.head.appendChild(st);
        })();

        let _smartScanner = null;

        class SmartScanner {
            constructor(viewportEl) {
                this.viewport = viewportEl;
                this.video = null;
                this.canvas = null;
                this.ctx = null;

                this.stream = null;
                this.track = null;

                this.mode = null; // 'detector' | 'zxing' | 'quagga'
                this.zxingReader = null;

                this._loopReq = 0;
                this._closed = false;

                this.requiredHits = 3;
                this._seen = new Map(); // code -> consecutive count

                this.roi = { top: 0.20, right: 0.20, bottom: 0.20, left: 0.20 };

                this._onZXingResult = this._onZXingResult?.bind?.(this) || (() => { });
                this._onQuaggaDetected = null;
            }

            async open(targetInputId) {
                this._closed = false;
                this.targetInputId = targetInputId;

                // Build viewport
                this.viewport.innerHTML = "";
                const wrap = document.createElement("div");
                wrap.style.position = "relative";
                wrap.style.width = "100%";
                wrap.style.height = "100%";
                this.viewport.appendChild(wrap);

                const video = document.createElement("video");
                video.setAttribute("playsinline", "true");
                video.setAttribute("autoplay", "true");
                video.muted = true;
                video.style.width = "100%";
                video.style.height = "100%";
                video.style.objectFit = "cover";
                wrap.appendChild(video);
                this.video = video;

                const roi = document.createElement("div");
                roi.className = "roi";
                wrap.appendChild(roi);

                // Hidden canvas
                const canvas = document.createElement("canvas");
                canvas.style.position = "absolute";
                canvas.style.left = "-9999px";
                wrap.appendChild(canvas);
                this.canvas = canvas;
                this.ctx = canvas.getContext("2d");

                // Start camera
                this.stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        aspectRatio: { ideal: 16 / 9 },
                        advanced: [{ focusMode: "continuous" }]
                    },
                    audio: false
                });
                this.video.srcObject = this.stream;
                await new Promise(res => (this.video.onloadedmetadata = res));

                const tracks = this.stream.getVideoTracks();
                this.track = tracks && tracks[0] ? tracks[0] : null;

                this._applyLandscapeFix();

                if ("BarcodeDetector" in window) {
                    this.mode = "detector";
                    await this._runDetectorLoop();
                } else if (window.ZXing?.BrowserMultiFormatReader) {
                    this.mode = "zxing";
                    await this._runZXing();
                } else if (window.Quagga) {
                    this.mode = "quagga";
                    await this._runQuagga();
                } else {
                    showToast("No scanner engine available", "exclamation");
                    this.close();
                }
            }

            _applyLandscapeFix() {
                // keep natural 16:9; we already set aspect-ratio in CSS
                const vp = this.viewport;
                // force landscape style when height > width (some phones lock portrait video)
                if (vp.offsetHeight > vp.offsetWidth) {
                    vp.classList.add('force-landscape');
                } else {
                    vp.classList.remove('force-landscape');
                }
            }

            async _runDetectorLoop() {
                const formats = [
                    'code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e', 'itf', 'codabar', 'qr_code', 'pdf417', 'aztec', 'data_matrix'
                ];
                const detector = new window.BarcodeDetector({ formats });
                const loop = async () => {
                    if (this._closed) return;
                    try {
                        const codes = await detector.detect(this.video);
                        if (codes && codes.length) {
                            const val = (codes[0].rawValue || '').trim();
                            if (this._bumpAndCheck(val)) {
                                this._setValue(val);
                                return;
                            }
                        }
                    } catch (e) {
                        // ignore frame errors
                    }
                    this._loopReq = requestAnimationFrame(loop);
                };
                loop();
            }

            async _runZXing() {
                this.zxingReader = new window.ZXing.BrowserMultiFormatReader();
                try {
                    const videoInputDevices = await window.ZXing.BrowserCodeReader.listVideoInputDevices();
                    const back = videoInputDevices.find(d => /back|rear|environment/i.test(d.label)) || videoInputDevices[0];
                    const hints = undefined;
                    const onResult = (res, err) => {
                        if (this._closed) return;
                        if (res && res.text) {
                            const val = (res.text || '').trim();
                            if (this._bumpAndCheck(val)) {
                                this._setValue(val);
                            }
                        }
                        // keep scanning until closed
                    };
                    await this.zxingReader.decodeFromVideoDevice(back?.deviceId || null, this.video, onResult, hints);
                } catch (e) {
                    console.warn('ZXing failed; falling back to detector loop if available', e);
                    if ("BarcodeDetector" in window) return this._runDetectorLoop();
                    if (window.Quagga) return this._runQuagga();
                    showToast('Scanner not available', 'exclamation');
                }
            }

            async _runQuagga() {
                return new Promise((resolve) => {
                    const cfg = {
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: this.viewport,
                            constraints: {
                                facingMode: "environment",
                                width: { ideal: 1920 }, height: { ideal: 1080 },
                                aspectRatio: { ideal: 16 / 9 }
                            }
                        },
                        locator: { patchSize: "medium", halfSample: true },
                        numOfWorkers: 2,
                        decoder: {
                            readers: ["code_128_reader", "code_39_reader", "ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader", "itf_reader", "codabar_reader"]
                        },
                        locate: true
                    };
                    window.Quagga.init(cfg, (err) => {
                        if (err) { console.warn('Quagga init error', err); showToast('Scanner init failed', 'exclamation'); resolve(); return; }
                        window.Quagga.start();
                        this.mode = 'quagga';
                        this._onQuaggaDetected = (data) => {
                            if (this._closed) return;
                            const val = (data?.codeResult?.code || '').trim();
                            if (val && this._bumpAndCheck(val)) {
                                this._setValue(val);
                            }
                        };
                        window.Quagga.onDetected(this._onQuaggaDetected);
                        resolve();
                    });
                });
            }

            _bumpAndCheck(val) {
                if (!val) return false;
                const n = (this._seen.get(val) || 0) + 1;
                this._seen.set(val, n);
                // reset others if new value
                if (n === 1) {
                    [...this._seen.keys()].forEach(k => { if (k !== val) this._seen.set(k, 0); });
                }
                return n >= this.requiredHits;
            }

            async torch(on) {
                try {
                    if (!this.track) return false;
                    const cap = this.track.getCapabilities?.();
                    if (!cap || !cap.torch) return false;
                    await this.track.applyConstraints({ advanced: [{ torch: !!on }] });
                    return true;
                } catch { return false; }
            }

            _setValue(val) {
                if (!val) return;
                const input = document.getElementById(this.targetInputId);
                if (input) {
                    input.value = val;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
                showToast('Scanned', 'check-circle');
                this.close();
                document.getElementById('scanOverlay')?.classList.remove('open');
            }

            async close() {
                this._closed = true;
                if (this._loopReq) cancelAnimationFrame(this._loopReq);
                this._loopReq = 0;
                try {
                    if (this.mode === 'zxing' && this.zxingReader) {
                        await this.zxingReader.reset();
                    }
                } catch { }
                try {
                    if (this.mode === 'quagga' && window.Quagga) {
                        window.Quagga.offDetected(this._onQuaggaDetected);
                        window.Quagga.stop();
                    }
                } catch { }
                try {
                    (this.stream?.getTracks?.() || []).forEach(t => t.stop());
                } catch { }
            }
        }

        /* Open/close scan UI */
        (function wireScanner() {
            const scanBtn = document.getElementById('sheetScanBtn');
            const scanClose = document.getElementById('scanClose');
            const overlay = document.getElementById('scanOverlay');
            const viewport = document.getElementById('scanViewport');
            const torchToggle = document.getElementById('scanTorchToggle');
            const torchPill = document.getElementById('torchPill');

            if (!scanBtn || !overlay || !viewport) return;

            scanBtn.addEventListener('click', async () => {
                overlay.classList.add('open');
                _smartScanner = new SmartScanner(viewport);
                await _smartScanner.open('sheetTrackingNumber');
                // try torch capability
                const ok = await _smartScanner.torch(false);
                torchPill.style.display = ok ? 'inline-flex' : 'none';
                torchToggle.checked = false;
            });

            scanClose.addEventListener('click', async () => {
                overlay.classList.remove('open');
                if (_smartScanner) { await _smartScanner.close(); _smartScanner = null; }
            });

            torchToggle?.addEventListener('change', async (e) => {
                if (_smartScanner) await _smartScanner.torch(!!e.target.checked);
            });
        })();

        /* =========================
           MOBILE NAV + SEARCH MODE
           ========================= */
        function setMobileSection(key) {
            mobileCurrent = key;
            document.body.classList.toggle('create-mode', key === 'create');
            document.body.classList.toggle('insights-mode', key === 'insights');
            document.querySelectorAll('#mobileNav .seg').forEach(b => b.classList.toggle('active', b.dataset.target === key));
            if (isMobile() && key === 'create') {
                // Removed auto-focus to prevent unexpected scrolling on keyboard open/resize
            }
        }
        function setupMobileNav({ initial = false } = {}) {
            const nav = document.getElementById('mobileNav'); if (!nav) return;
            if (isMobile()) {
                nav.style.display = 'flex';
                if (initial && !mobileNavInitialized) {
                    mobileNavInitialized = true;
                    setMobileSection(mobileCurrent);
                } else {
                    setMobileSection(mobileCurrent);
                }
            } else {
                nav.style.display = 'none';
                document.body.classList.remove('create-mode', 'insights-mode');
            }
        }
        function enterSearchMode() {
            if (!isMobile()) return;
            document.body.classList.add('search-mode');
            document.getElementById('ordersWrap').style.display = 'block';
        }
        function exitSearchMode() {
            document.body.classList.remove('search-mode');
            document.getElementById('ordersWrap').style.removeProperty('display');
            clearListInlineDisplay();
        }
        function clearListInlineDisplay() {
            const list = document.getElementById('courierList');
            const cards = document.getElementById('mCards');
            if (list) list.style.removeProperty('display');
            if (cards) cards.style.removeProperty('display');
        }
        function refreshTableAndMetrics() {
            currentOffset = 0; // CRITICAL: Reset offset for refresh
            showMetricsSkeleton();
            renderTableSkeleton();
            if (isMobile()) mobileCardSkeleton();

            // Parallel Fetch for speed
            return Promise.all([
                fetchPage(false),
                fetchMetrics()
            ]);
        }

        /* =========================
           TOP CONTROLS + EVENTS
           ========================= */
        window.addEventListener('resize', onResize);

        document.getElementById('viewModeSwitch')?.addEventListener('change', () => {
            applyDetailColsFromSwitch();
            syncMirrorWidths();
        });

        document.getElementById('refreshBtn')?.addEventListener('click', () => {
            if (window.hasPendingAsync) {
                showToast('Please wait for current action', 'exclamation');
                return;
            }
            currentOffset = 0; isLastPage = false;
            refreshTableAndMetrics();
        });

        document.getElementById('loadMoreBtn')?.addEventListener('click', () => {
            if (isLastPage) return;
            fetchPage(true);
        });

        document.getElementById('searchIconBtn')?.addEventListener('click', enterSearchMode);
        document.getElementById('searchCancelBtn')?.addEventListener('click', exitSearchMode);
        document.getElementById('searchClearBtn')?.addEventListener('click', () => {
            const si = document.getElementById('searchInput');
            si.value = ''; si.dispatchEvent(new Event('input'));
            if (isMobile()) {
                exitSearchMode();
            } else {
                si.focus();
            }
        });

        document.getElementById('searchInput')?.addEventListener('input', debounce(() => {
            const v = document.getElementById('searchInput').value.trim();
            document.querySelector('.search-wrap')?.classList.toggle('has-text', v.length > 0);
            currentOffset = 0; isLastPage = false;
            fetchPage(false);
        }, 300));

        document.getElementById('filters')?.addEventListener('click', (e) => {
            const b = e.target.closest('.seg-btn'); if (!b) return;
            document.querySelectorAll('#filters .seg-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
            paymentFilter = b.dataset.payment || 'All';
            currentOffset = 0; isLastPage = false;
            fetchPage(false);
        });

        /* Date buttons are wired in wireRangePicker() */

        /* =========================
           FORM WIRES
           ========================= */
        document.getElementById('sameAsPrimary')?.addEventListener('change', (e) => {
            const p = document.getElementById('primaryPhone').value.replace(/\D/g, '').slice(0, 10);
            const a = document.getElementById('accountPhone');
            if (e.target.checked) { a.value = p; a.dispatchEvent(new Event('input', { bubbles: true })); }
        });
        ['recipientName', 'addressInput', 'primaryPhone', 'secondaryPhone', 'preferredCourier'].forEach(id => {
            const el = document.getElementById(id); if (!el) return;
            const evt = (id === 'preferredCourier') ? 'change' : 'input';
            el.addEventListener(evt, updatePreview);
        });
        document.getElementById('clearBtn')?.addEventListener('click', clearEntireForm);
        document.getElementById('courierForm')?.addEventListener('submit', handleSubmit);

        /* =========================
           SHEET CLOSE ESC/BACK
           ========================= */
        let _backGuard = null;
        function ensureBackGuard() {
            if (_backGuard !== null) return;
            _backGuard = () => { if (mobileDetail.open) { history.pushState({ sheet: true }, ''); } };
            history.pushState({ sheet: true }, '');
            window.addEventListener('popstate', onPopState, { passive: true });
        }
        function deactivateBackGuard() {
            try { window.removeEventListener('popstate', onPopState); } catch { }
            _backGuard = null;
        }
        function onPopState(e) {
            if (mobileDetail.open) {
                closeDetailSheet();
                setTimeout(() => history.pushState({}, ''), 0);
            }
        }

        /* =========================
           INIT
           ========================= */
        async function init() {
            buildMirrorHeader();
            setupMobileNav({ initial: true });
            applyDetailColsFromSwitch();

            // Show skeletons immediately while data loads
            showMetricsSkeleton();
            renderTableSkeleton();
            if (isMobile()) mobileCardSkeleton();

            // Fire ALL backend fetches in parallel for maximum speed
            await Promise.all([
                populatePreferredCourier(),
                loadTrackingMap(),
                loadUPILogoMap(),
                fetchPage(false),
                fetchMetrics()
            ]);

            // Mobile nav buttons
            document.querySelector('#mobileNav [data-target="insights"]')?.addEventListener('click', () => setMobileSection('insights'));
            document.querySelector('#mobileNav [data-target="create"]')?.addEventListener('click', () => setMobileSection('create'));

            // Auto-Capitalize Name and Address
            // const toTitleCase = (str) => str.toLowerCase().replace(/(?:^|\s)\S/g, a => a.toUpperCase());
            ['recipientName', 'addressInput'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', function () {
                        const start = this.selectionStart;
                        const end = this.selectionEnd;
                        const oldVal = this.value;
                        const newVal = toTitleCase(oldVal);
                        if (oldVal !== newVal) {
                            this.value = newVal;
                            this.setSelectionRange(start, end);
                        }
                    });
                }
            });

            // Refresh Protection: Hardware/Browser Back/Refresh
            window.addEventListener('beforeunload', (e) => {
                if (window.hasPendingAsync) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            initVoiceNotifications();
        }
        document.addEventListener('DOMContentLoaded', initAuth);

        /* =========================
           AUTH GATING
           ========================= */
        function initAuth() {
            // 1. Check Local Session (OTP Login)
            const localSession = localStorage.getItem('session_user');
            if (localSession) {
                updateSettingsUser('User', localSession, null);
                init();
                return;
            }

            // 2. Check Firebase Session (Google Login)
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    updateSettingsUser(user.displayName || 'User', user.email, user.photoURL);
                    init();
                    initFCMNotifications();
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        function updateSettingsUser(name, email, photo) {
            const nameEl = document.getElementById('settingsUserName');
            const emailEl = document.getElementById('settingsUserEmail');
            const avatarEl = document.getElementById('settingsAvatar');
            if (nameEl) nameEl.textContent = name;
            if (emailEl) emailEl.textContent = email;
            if (avatarEl && photo) {
                avatarEl.innerHTML = '<img src="' + photo + '" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">';
            }
        }

        function logout() {
            firebase.auth().signOut().then(() => {
                localStorage.removeItem('session_user');
                window.location.reload();
            });
        }

        async function initFCMNotifications() {
            try {
                const fcmMessaging = firebase.messaging();
                const permission = await Notification.requestPermission();

                if (permission === 'granted') {
                    const token = await fcmMessaging.getToken({
                        vapidKey:
                            'BLnRYvHnZEydBfLde5EdgRY6ej5sPdGpjzicQi0tSZW3V-9-mRnlm0Pcy0ULd9kxWB1q_yVo6-etfGzooQQoUGw'
                    });

                    if (token) {
                        await fetch(SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify({ action: 'saveSubscription', token: token })
                        });
                        console.log('FCM Token sent to backend');
                    }

                    fcmMessaging.onMessage((payload) => {
                        console.log('FCM Message received:', payload);
                        const { title, body } = payload.notification || {};
                        if (body && typeof speak === 'function') speak(body);
                        if (body && typeof showToast === 'function') showToast(body, 'check-circle');
                        if (typeof refreshTableAndMetrics === 'function') refreshTableAndMetrics();
                    });
                }
            } catch (error) {
                console.error('FCM Notification setup failed:', error);
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.error('SW Registration Failed:', err));
        }
    </script>

    <!-- SVG Icons Injected -->
    <svg style="display:none">
        <symbol id="i-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path
                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
            <circle cx="12" cy="12" r="3" />
        </symbol>
        <symbol id="i-chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
        </symbol>
        <symbol id="i-arrow-up-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="7" y1="17" x2="17" y2="7"></line>
            <polyline points="7 7 17 7 17 17"></polyline>
        </symbol>
        <symbol id="i-arrow-down-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="7" y1="7" x2="17" y2="17"></line>
            <polyline points="17 7 17 17 7 17"></polyline>
        </symbol>
        <!-- Paper Sizes: Refined with Text (Maximized Visibility) -->
        <symbol id="i-a4-portrait" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <!-- Portrait: 14x20 (Maximized) -->
            <rect x="5" y="2" width="14" height="20" rx="1" />
            <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="9" font-weight="900"
                stroke="none" fill="currentColor" style="font-family:sans-serif;">A4</text>
        </symbol>
        <symbol id="i-a4-landscape" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <!-- Landscape: 20x14 (Maximized) -->
            <rect x="2" y="5" width="20" height="14" rx="1" />
            <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="9" font-weight="900"
                stroke="none" fill="currentColor" style="font-family:sans-serif;">A4</text>
        </symbol>
        <symbol id="i-a5-portrait" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <!-- Portrait: 14x20 (SAME size as A4 for visibility) -->
            <rect x="5" y="2" width="14" height="20" rx="1" />
            <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="9" font-weight="900"
                stroke="none" fill="currentColor" style="font-family:sans-serif;">A5</text>
        </symbol>
        <symbol id="i-a5-landscape" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <!-- Landscape: 20x14 (SAME size as A4 for visibility) -->
            <rect x="2" y="5" width="20" height="14" rx="1" />
            <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="9" font-weight="900"
                stroke="none" fill="currentColor" style="font-family:sans-serif;">A5</text>
        </symbol>
        <symbol id="i-globe" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10" />
            <path
                d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
        </symbol>
        <symbol id="i-tag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />
            <line x1="7" y1="7" x2="7.01" y2="7" />
        </symbol>

        <!-- UPI Icon (Official BHIM Style) -->
        <symbol id="i-upi" viewBox="0 0 123 60" fill="currentColor">
            <path
                d="M111.45,19.26l-5.17,4.81l-0.17-0.13c0.59-2.19,1.18-4.39,1.78-6.58c1.5-5.45,3-10.89,4.51-16.34 c0-0.27,0.14-0.52,0.38-0.65c0.36-0.06,0.35,0.35,0.48,0.58c0.77,1.42,1.35,2.93,2.25,4.28 c0.85,2.06,1.84,4.11,2.91,6.06c0.13,0.2,0.21,0.43,0.21,0.67c0,0.41-0.21,0.8-0.56,1.02C115.82,15.02,113.64,17.15,111.45,19.26z" />
            <path
                d="M30.37,12.17c0.76,0.35,1.25,1.11,1.25,1.94c0,0.34-0.08,0.68-0.24,0.98c-0.6,1.95-1.09,3.92-1.63,5.89 c-0.15,1.86-1.71,3.29-3.57,3.29c-0.21,0-0.42-0.02-0.63-0.06c-8.27,0-16.53,0.01-24.8,0.02c-0.65,0-0.89-0.06-0.68-0.79 C2.2,15.9,4.3,8.35,6.39,0.8C6.44,0.35,6.82,0,7.27,0c0.13,0.01,8.51,0.02,17.03,0.01 C33.06,0.02,33.18,0,33.3,0c0.95,0,1.71,0.77,1.71,1.71c0,0.24-0.05,0.47-0.15,0.69c-0.64,2.52-1.34,5.02-2.07,7.52 C32.4,11.02,31.5,11.86,30.37,12.17z M85.39,59.94h-4.84l6.72-24.26h4.83L85.39,59.94z M45.21,58.42h-27.06c-1.2,0-1.73-0.92-1.73-1.72l6.08-21.9h4.84l-5.43,19.56 h19.34l5.43-19.56h4.83L45.21,58.42z M82.88,36.44c-0.33-0.46-0.85-0.69-1.55-0.69l-26.57,0l-1.31,4.76 h24.17l-1.41,5.08H56.87h-4.83l-4.01,14.48h4.83l2.69-9.71h21.73c0.68,0,1.32-0.23,1.92-0.69s0.99-1.04,1.18-1.72l2.69-9.71z" />
            <polygon points="100.46,35.72 106.57,47.88 93.71,60.04 95.24,54.53 102.27,47.88 98.93,41.23" />
            <polygon points="96.16,35.72 102.27,47.88 89.41,60.04" />
        </symbol>
        <!-- QR Icon -->
        <symbol id="i-qr" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7" />
            <rect x="14" y="3" width="7" height="7" />
            <rect x="14" y="14" width="7" height="7" />
            <path d="M3 14h7v7H3z" />
        </symbol>
        <symbol id="i-hashtag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="9" x2="20" y2="9"></line>
            <line x1="4" y1="15" x2="20" y2="15"></line>
            <line x1="10" y1="3" x2="8" y2="21"></line>
            <line x1="16" y1="3" x2="14" y2="21"></line>
        </symbol>
        <symbol id="i-clipboard-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
            <polyline points="12 16 14 18 19 13" />
        </symbol>
    </svg>
    <!-- SETTINGS MODAL -->
    <div id="settingsModalOverlay" class="modal-overlay no-print" onclick="closeSettingsModal(event)">
        <div class="settings-modal">
            <div class="modal-header">
                <div class="modal-title">
                    <svg class="ico">
                        <use href="#i-settings" />
                    </svg>
                    Settings
                </div>
                <button class="modal-close" onclick="closeSettingsModal()"><svg class="ico">
                        <use href="#i-x" />
                    </svg></button>
            </div>
            <div class="modal-body">
                <!-- Account Section -->
                <div
                    style="display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--border, #e2e8f0); margin-bottom:12px;">
                    <div id="settingsAvatar"
                        style="width:44px; height:44px; border-radius:50%; background:linear-gradient(135deg, #7c3aed, #6d28d9); color:white; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px; flex-shrink:0;">
                        ðŸ‘¤</div>
                    <div style="flex:1; min-width:0;">
                        <div id="settingsUserName"
                            style="font-weight:700; font-size:14px; color:var(--text, #1e293b); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            User</div>
                        <div id="settingsUserEmail"
                            style="font-size:12px; color:var(--muted, #64748b); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            ...</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px; margin-bottom:16px;">
                    <a href="account.html" class="btn"
                        style="flex:1; text-align:center; text-decoration:none; font-size:12px; padding:8px 12px; border-radius:8px; font-weight:600; display:inline-flex; align-items:center; justify-content:center; gap:4px;">
                        <svg style="width:14px;height:14px;stroke:currentColor;fill:none;stroke-width:2;"
                            viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        View Account
                    </a>
                    <button onclick="logout()" class="btn"
                        style="flex:1; font-size:12px; padding:8px 12px; border-radius:8px; font-weight:600; color:#ef4444; border-color:#fecaca; display:inline-flex; align-items:center; justify-content:center; gap:4px;">
                        <svg style="width:14px;height:14px;stroke:#ef4444;fill:none;stroke-width:2;"
                            viewBox="0 0 24 24">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Log Out
                    </button>
                </div>

                <div class="settings-row" style="display:none;">
                    <label class="switch" style="display:none;">
                        <input type="checkbox" id="viewModeSwitchModal">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <strong>Voice Notifications</strong>
                        <p>Announce successful payments via voice</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="voiceToggleModal">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <strong>Voice Language</strong>
                        <p>Select language for announcements</p>
                    </div>
                    <select id="voiceLangSelectModal" class="fancy-select"
                        style="width:110px; height:28px; padding:0 8px; font-size:12px;">
                        <option value="en-IN">English</option>
                        <option value="ta-IN">Tamil</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Settings Button removal -->

    <!-- RECEIPT MODAL -->
    <div id="receiptModal" onclick="if(event.target===this)closeReceipt()"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
        <div
            style="background:white;padding:0;border-radius:24px;box-shadow:0 10px 40px rgba(0,0,0,0.25);width:320px;text-align:center;position:relative;overflow:hidden;">

            <!-- Header -->
            <div style="background:#f0fdf4;padding:30px 20px 20px;border-bottom:1px dashed #cbd5e1;">
                <div
                    style="width:60px;height:60px;background:#22c55e;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 15px;box-shadow:0 4px 12px rgba(34,197,94,0.4);">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>
                </div>
                <h2 id="receiptTitle" style="margin:0;color:#15803d;font-size:20px;font-weight:700;">Payment Successful
                </h2>
                <div style="font-size:13px;color:#86efac;margin-top:5px;font-weight:600;">Transaction Completed</div>
            </div>

            <!-- Body -->
            <div style="padding:25px 25px 15px;">
                <div style="margin-bottom:20px;">
                    <div
                        style="font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#64748b;font-weight:600;">
                        Amount Paid</div>
                    <div id="rAmt" style="font-size:32px;font-weight:800;color:#0f172a;margin-top:5px;"></div>
                </div>

                <div
                    style="text-align:left;background:#f8fafc;padding:15px;border-radius:12px;margin-bottom:25px;border:1px solid #e2e8f0;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="font-size:13px;color:#64748b;">Txn ID</span>
                        <span id="rTxn" style="font-size:13px;font-weight:600;color:#334155;"></span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="font-size:13px;color:#64748b;">Time</span>
                        <span id="rTime" style="font-size:13px;font-weight:600;color:#334155;"></span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span style="font-size:13px;color:#64748b;">Status</span>
                        <span id="rStatus"
                            style="font-size:11px;font-weight:700;color:#16a34a;background:#dcfce7;padding:2px 8px;border-radius:4px;">SUCCESS</span>
                    </div>
                </div>

                <button onclick="shareReceiptFromModal()"
                    style="width:100%;padding:14px;background:#25D366;color:white;border:none;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 4px 12px rgba(37,211,102,0.3);transition:transform 0.1s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path
                            d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" />
                    </svg>
                    Share via WhatsApp
                </button>
            </div>

            <!-- Close Hint (Subtle) -->
            <div style="padding-bottom:15px;color:#94a3b8;font-size:11px;">Tap outside to close</div>
        </div>
    </div>

    <script>
        // Check URL for Receipt Params
        (function () {
            const up = new URLSearchParams(window.location.search);
            const status = up.get('status');
            if (status === 'success') {
                document.getElementById('receiptModal').style.display = 'flex';
                document.getElementById('rTxn').textContent = up.get('txnid') || '';
                const amt = up.get('amount') || '';
                document.getElementById('rAmt').textContent = 'Rs. ' + amt;
                document.getElementById('rTime').textContent = decodeURIComponent(up.get('time') || '');

                // Activity-Driven: Instant Voice Trigger for the Payer
                if (localStorage.getItem('voice_enabled') === 'true') {
                    setTimeout(() => {
                        const name = up.get('name') || 'Customer';
                        const amt = up.get('amount') || '0';
                        const lang = localStorage.getItem('voice_lang') || 'en-IN';
                        if (localStorage.getItem('last_announced_txn') !== up.get('txnid')) {
                            localStorage.setItem('last_announced_txn', up.get('txnid'));
                            let text = (lang === 'ta-IN')
                                ? `à®µà¯†à®±à¯à®±à®¿! à®•à®Ÿà¯à®Ÿà®£à®®à¯ à®šà¯†à®²à¯à®¤à¯à®¤à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯. à®°à¯‚à®ªà®¾à®¯à¯ ${amt}, ${name} à®‡à®Ÿà®®à®¿à®°à¯à®¨à¯à®¤à¯ à®ªà¯†à®±à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯`
                                : `Success! Received ${amt} Rupees from ${name}`;
                            if (typeof speak === 'function') speak(text);
                        }
                    }, 500);
                }
            } else if (status === 'failed') {
                // Reuse modal but style for failure
                document.getElementById('receiptModal').style.display = 'flex';
                document.getElementById('receiptTitle').textContent = 'Payment Failed';
                document.getElementById('receiptTitle').style.color = '#ef4444';
                document.getElementById('receiptTitle').parentElement.style.background = '#fef2f2';
                document.getElementById('receiptTitle').parentElement.style.borderBottom = '1px dashed #fecaca';

                // Change Icon
                document.getElementById('receiptTitle').previousElementSibling.style.background = '#ef4444';
                document.getElementById('receiptTitle').previousElementSibling.style.boxShadow = '0 4px 12px rgba(239,68,68,0.4)';
                document.getElementById('receiptTitle').previousElementSibling.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

                document.getElementById('rStatus').textContent = 'FAILED';
                document.getElementById('rStatus').style.color = '#ef4444';
                document.getElementById('rStatus').style.background = '#fee2e2';

                document.getElementById('rTxn').textContent = up.get('txnid') || '';
                document.getElementById('rAmt').textContent = 'Rs. ' + (up.get('amount') || '0');
            }
        })();

        function closeReceipt() {
            document.getElementById('receiptModal').style.display = 'none';
            // Remove params
            const url = new URL(window.location);
            url.searchParams.delete('status');
            url.searchParams.delete('txnid');
            url.searchParams.delete('amount');
            url.searchParams.delete('time');
            window.history.replaceState({}, document.title, url);
        }

        function shareReceiptFromModal() {
            const txnid = document.getElementById('rTxn').textContent;
            const amount = document.getElementById('rAmt').textContent;
            const time = document.getElementById('rTime').textContent;
            const status = document.getElementById('rStatus').textContent;

            var text = "âœ… Payment Receipt\n" +
                "Txn ID: " + txnid + "\n" +
                "Amount: " + amount + "\n" +
                "Time: " + time + "\n" +
                "Status: " + status;

            if (navigator.share) {
                navigator.share({ title: "Payment Receipt", text: text }).catch(console.error);
            } else {
                window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
            }
        }
    </script>
</body>

</html>